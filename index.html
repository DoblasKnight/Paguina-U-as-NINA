<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Nails App - Premium Admin</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
      :root {
        --primary: #d63384;
        --primary-soft: #fce4ec;
        --accent: #f8bbd0;
        --bg: #fff5f8;
        --text: #4a148c;
        --whatsapp: #25d366;
      }

      body {
        font-family: "Segoe UI", sans-serif;
        background: var(--bg);
        margin: 0;
        color: var(--text);
        padding: 10px;
      }

      /* MODALES */
      .modal-overlay {
        display: none;
        position: fixed;
        z-index: 3000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: rgba(74, 20, 140, 0.4);
        backdrop-filter: blur(4px);
      }
      .modal-content {
        background: white;
        margin: 12% auto;
        padding: 35px;
        border-radius: 30px;
        width: 85%;
        max-width: 350px;
        text-align: center;
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.2);
      }

      /* APP INTERFACE */
      #auth-screen {
        max-width: 400px;
        margin: 40px auto;
        background: white;
        padding: 30px;
        border-radius: 25px;
        border: 2px solid var(--accent);
      }
      #app-screen {
        display: none;
        max-width: 1000px;
        margin: 10px auto;
        background: white;
        border-radius: 25px;
        overflow: hidden;
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
      }

      .nav-header {
        background: var(--primary);
        color: white;
        padding: 15px 25px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .tabs {
        display: flex;
        background: white;
        border-bottom: 2px solid var(--accent);
      }
      .tab-btn {
        flex: 1;
        padding: 15px;
        border: none;
        background: none;
        cursor: pointer;
        font-weight: bold;
        color: #888;
      }
      .tab-btn.active {
        color: var(--primary);
        border-bottom: 3px solid var(--primary);
        background: var(--bg);
      }

      /* CALENDARIO */
      .cal-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 5px;
        margin-top: 10px;
      }
      .day {
        padding: 12px 5px;
        border-radius: 12px;
        cursor: pointer;
        border: 1px solid #fff0f5;
        text-align: center;
      }
      .day.today {
        border: 2px solid var(--primary);
        color: var(--primary);
      }
      .day.selected {
        background: var(--primary) !important;
        color: white !important;
        font-weight: bold;
      }
      .day.disabled {
        color: #ccc;
        cursor: not-allowed;
        opacity: 0.4;
        pointer-events: none;
      }

      /* FORMULARIO */
      .main-grid {
        display: grid;
        grid-template-columns: 1fr 350px;
        gap: 20px;
        padding: 20px;
      }
      @media (max-width: 850px) {
        .main-grid {
          grid-template-columns: 1fr;
        }
      }

      input,
      select {
        width: 100%;
        padding: 12px;
        margin: 8px 0;
        border: 2px solid var(--primary-soft);
        border-radius: 12px;
        box-sizing: border-box;
        font-family: inherit;
      }
      .btn-main {
        background: var(--primary);
        color: white;
        border: none;
        padding: 15px;
        width: 100%;
        border-radius: 15px;
        cursor: pointer;
        font-weight: bold;
        font-size: 1rem;
      }
      .btn-wa {
        background: var(--whatsapp);
        color: white;
        border: none;
        padding: 15px;
        width: 100%;
        border-radius: 15px;
        cursor: pointer;
        font-weight: bold;
      }

      /* CARDS DE CITA */
      .appointment-card {
        background: white;
        border-left: 6px solid var(--primary);
        padding: 15px;
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        margin-bottom: 15px;
        position: relative;
      }
      .admin-data-box {
        background: #f8f8f8;
        padding: 10px;
        border-radius: 12px;
        margin-top: 10px;
        font-size: 0.85rem;
        border: 1px dashed var(--accent);
      }
      .btn-remind {
        background: var(--whatsapp);
        color: white;
        border: none;
        padding: 10px;
        border-radius: 10px;
        cursor: pointer;
        width: 100%;
        font-weight: bold;
        margin-top: 10px;
      }
      .role-badge {
        font-size: 0.6rem;
        background: white;
        color: var(--primary);
        padding: 2px 6px;
        border-radius: 4px;
        vertical-align: middle;
        margin-left: 5px;
        text-transform: uppercase;
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <div id="confirmModal" class="modal-overlay">
      <div class="modal-content">
        <div style="font-size: 60px">ðŸ“©</div>
        <h2>Â¡Casi listo!</h2>
        <p>
          Para agendar tu espacio, **debes enviar el comprobante** por WhatsApp
          ahora mismo.
        </p>
        <button class="btn-wa" onclick="enviarWhatsAppCliente()">
          Enviar Comprobante ðŸ“±
        </button>
      </div>
    </div>

    <div id="auth-screen">
      <h1 style="text-align: center; color: var(--primary)">Nails App</h1>
      <div id="login-form">
        <input type="email" id="loginEmail" placeholder="Correo" />
        <input type="password" id="loginPass" placeholder="ContraseÃ±a" />
        <button class="btn-main" onclick="handleAuth('login')">Entrar</button>
        <p style="text-align: center; font-size: 0.8rem">
          Â¿No tienes cuenta?
          <a href="#" onclick="toggleAuth(false)" style="color: var(--primary)"
            >RegÃ­strate</a
          >
        </p>
      </div>
      <div id="signup-form" style="display: none">
        <input type="text" id="regNombre" placeholder="Nombre completo" />
        <input type="email" id="regEmail" placeholder="Correo" />
        <input type="password" id="regPass" placeholder="ContraseÃ±a (min. 6)" />
        <button class="btn-main" onclick="handleAuth('signup')">
          Crear Cuenta
        </button>
        <p style="text-align: center; font-size: 0.8rem">
          <a href="#" onclick="toggleAuth(true)" style="color: var(--primary)"
            >Ya tengo cuenta</a
          >
        </p>
      </div>
    </div>

    <div id="app-screen">
      <div class="nav-header">
        <span
          >ðŸ’… <b id="displayUserName"></b>
          <span id="adminBadge" class="role-badge" style="display: none"
            >Admin</span
          ></span
        >
        <button
          onclick="logout()"
          style="
            background: none;
            border: 1px solid white;
            color: white;
            padding: 5px 10px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.7rem;
          "
        >
          Salir
        </button>
      </div>

      <div class="tabs">
        <button
          id="tab-agenda"
          class="tab-btn active"
          onclick="showTab('agenda')"
        >
          Agendar
        </button>
        <button id="tab-lista" class="tab-btn" onclick="showTab('lista')">
          Citas
        </button>
      </div>

      <div id="view-agenda" class="main-grid">
        <div>
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
            "
          >
            <button
              onclick="moveMonth(-1)"
              style="border: none; background: none; cursor: pointer"
            >
              â—€
            </button>
            <b id="monthDisplay"></b>
            <button
              onclick="moveMonth(1)"
              style="border: none; background: none; cursor: pointer"
            >
              â–¶
            </button>
          </div>
          <div class="cal-grid" id="calendarGrid"></div>
        </div>

        <div class="form-section">
          <input type="text" id="fieldNombre" placeholder="Nombre de clienta" />
          <input
            type="email"
            id="fieldCorreo"
            placeholder="Correo electrÃ³nico"
          />
          <input
            type="text"
            id="fieldTelefono"
            placeholder="WhatsApp (Ej: 57300...)"
          />
          <select id="fieldServicio">
            <option>UÃ±as AcrÃ­licas</option>
            <option>Retoque</option>
            <option>Semipermanente</option>
          </select>
          <select id="fieldHora"></select>
          <label style="font-size: 0.7rem; font-weight: bold"
            >FOTO COMPROBANTE:</label
          >
          <input type="file" id="fieldFile" accept="image/*" />
          <button class="btn-main" onclick="confirmarCita()">
            âœ¨ Reservar Espacio
          </button>
        </div>
      </div>

      <div id="view-lista" style="display: none; padding: 20px">
        <div id="tablaCitasContainer"></div>
      </div>
    </div>

    <script>
      const sbUrl = "https://jifwtgpchbipxyriirtq.supabase.co";
      const sbKey = "sb_publishable_zF5mj6Ba61zibU_19vnFPQ_a4GDaKwi";
      const client = supabase.createClient(sbUrl, sbKey);

      const miWhatsAppAdmin = "573228211246"; // PON TU NÃšMERO AQUÃ

      let userProfile = null;
      let selectedDate = null;
      let lastCitaData = null;
      let viewDate = new Date();

      function format12h(h24) {
        let [h, m] = h24.split(":");
        let suf = h >= 12 ? "PM" : "AM";
        h = h % 12 || 12;
        return `${h}:${m} ${suf}`;
      }

      function toggleAuth(isLogin) {
        document.getElementById("login-form").style.display = isLogin
          ? "block"
          : "none";
        document.getElementById("signup-form").style.display = isLogin
          ? "none"
          : "block";
      }

      async function handleAuth(type) {
        if (type === "signup") {
          const email = document.getElementById("regEmail").value;
          const pass = document.getElementById("regPass").value;
          const name = document.getElementById("regNombre").value;
          const { error } = await client.auth.signUp({
            email,
            password: pass,
            options: { data: { full_name: name } },
          });
          if (error) alert(error.message);
          else alert("Cuenta creada. Â¡Inicia sesiÃ³n!");
        } else {
          const { error } = await client.auth.signInWithPassword({
            email: document.getElementById("loginEmail").value,
            password: document.getElementById("loginPass").value,
          });
          if (error) alert("Error: " + error.message);
          else checkUser();
        }
      }

      async function checkUser() {
        const {
          data: { session },
        } = await client.auth.getSession();
        if (session) {
          const { data: profile } = await client
            .from("profiles")
            .select("*")
            .eq("id", session.user.id)
            .single();
          if (!profile) return setTimeout(checkUser, 1000);

          userProfile = profile;
          document.getElementById("auth-screen").style.display = "none";
          document.getElementById("app-screen").style.display = "block";
          document.getElementById("displayUserName").innerText =
            profile.full_name;

          // REGLAS ADMIN VS CLIENTE
          const inputN = document.getElementById("fieldNombre");
          const inputC = document.getElementById("fieldCorreo");
          inputN.value = profile.full_name;
          inputC.value = session.user.email;

          if (profile.role === "admin") {
            document.getElementById("adminBadge").style.display =
              "inline-block";
            inputN.readOnly = false;
            inputC.readOnly = false;
            inputN.style.background = "white";
          } else {
            inputN.readOnly = true;
            inputC.readOnly = false;
            inputN.style.background = "#f0f0f0";
          }
          renderCalendar();
        }
      }

      function renderCalendar() {
        const grid = document.getElementById("calendarGrid");
        const months = [
          "Enero",
          "Febrero",
          "Marzo",
          "Abril",
          "Mayo",
          "Junio",
          "Julio",
          "Agosto",
          "Septiembre",
          "Octubre",
          "Noviembre",
          "Diciembre",
        ];
        const year = viewDate.getFullYear();
        const month = viewDate.getMonth();
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        document.getElementById("monthDisplay").innerText =
          `${months[month]} ${year}`;
        grid.innerHTML = "";
        ["Do", "Lu", "Ma", "Mi", "Ju", "Vi", "SÃ¡"].forEach(
          (d) =>
            (grid.innerHTML += `<div style="font-size:0.7rem; color:#bbb; text-align:center;">${d}</div>`),
        );

        const firstDay = new Date(year, month, 1).getDay();
        const lastDate = new Date(year, month + 1, 0).getDate();

        for (let i = 0; i < firstDay; i++) grid.innerHTML += `<div></div>`;
        for (let i = 1; i <= lastDate; i++) {
          const d = document.createElement("div");
          const cIter = new Date(year, month, i);
          const dStr = `${year}-${String(month + 1).padStart(2, "0")}-${String(i).padStart(2, "0")}`;

          d.className = "day";
          d.innerText = i;
          if (cIter < today) d.classList.add("disabled");
          else {
            if (cIter.getTime() === today.getTime()) d.classList.add("today");
            d.onclick = () => {
              document
                .querySelectorAll(".day")
                .forEach((el) => el.classList.remove("selected"));
              d.classList.add("selected");
              selectedDate = dStr;
              checkHoras(dStr);
            };
          }
          grid.appendChild(d);
        }
      }

      async function checkHoras(fecha) {
        const { data } = await client
          .from("citas")
          .select("hora")
          .eq("fecha", fecha);
        const selector = document.getElementById("fieldHora");
        selector.innerHTML = "";
        ["09:00", "11:00", "14:00", "16:00"].forEach((h) => {
          const opt = document.createElement("option");
          opt.value = h;
          const ocupado = data && data.some((c) => c.hora.startsWith(h));
          opt.disabled = ocupado;
          opt.text = format12h(h) + (ocupado ? " (Ocupado)" : "");
          selector.appendChild(opt);
        });
      }

      async function confirmarCita() {
        if (!selectedDate) return alert("Selecciona fecha");
        const file = document.getElementById("fieldFile").files[0];
        if (!file) return alert("Sube el comprobante");

        const datos = {
          fecha: selectedDate,
          hora: document.getElementById("fieldHora").value,
          nombre: document.getElementById("fieldNombre").value,
          correo: document.getElementById("fieldCorreo").value,
          telefono: document.getElementById("fieldTelefono").value,
          servicio: document.getElementById("fieldServicio").value,
          user_id: userProfile.id,
        };

        const { error } = await client.from("citas").insert([datos]);
        if (error) alert(error.message);
        else {
          lastCitaData = datos;
          document.getElementById("confirmModal").style.display = "block";
        }
      }

      function enviarWhatsAppCliente() {
        const msg = `Â¡Hola! Soy *${lastCitaData.nombre}*. AgendÃ© cita para *${lastCitaData.servicio}* el *${lastCitaData.fecha}* a las *${format12h(lastCitaData.hora)}*. Adjunto comprobante. âœ¨`;
        window.open(
          `https://wa.me/${miWhatsAppAdmin}?text=${encodeURIComponent(msg)}`,
          "_blank",
        );
        document.getElementById("confirmModal").style.display = "none";
        showTab("lista");
      }

      async function loadAllAppointments() {
        let query = client.from("citas").select("*");
        if (userProfile.role !== "admin")
          query = query.eq("user_id", userProfile.id);

        const { data } = await query
          .order("fecha", { ascending: true })
          .order("hora", { ascending: true });
        const container = document.getElementById("tablaCitasContainer");
        container.innerHTML = "";

        const maÃ±ana = new Date();
        maÃ±ana.setDate(maÃ±ana.getDate() + 1);
        const maÃ±anaStr = maÃ±ana.toISOString().split("T")[0];

        if (data)
          data.forEach((c) => {
            const esMaÃ±ana = c.fecha === maÃ±anaStr;
            let adminInfo = "";

            if (userProfile.role === "admin") {
              adminInfo = `
                        <div class="admin-data-box">
                            <b>ðŸ“± WhatsApp:</b> ${c.telefono}<br>
                            <b>ðŸ“§ Correo:</b> ${c.correo}
                        </div>
                        ${esMaÃ±ana ? `<button class="btn-remind" onclick="window.open('https://wa.me/${c.telefono}?text=Hola%20${c.nombre}!%20Confirmamos%20tu%20cita%20de%20maÃ±ana%20a%20las%20${format12h(c.hora)}')">ðŸ“± Recordar MaÃ±ana</button>` : ""}
                    `;
            }

            container.innerHTML += `
                    <div class="appointment-card">
                        <div style="font-weight:bold; color:var(--primary)">ðŸ•’ ${format12h(c.hora)} - ${c.fecha}</div>
                        <div style="font-size:1.1rem; margin:5px 0;">ðŸ‘¤ ${c.nombre}</div>
                        <div style="font-size:0.8rem; color:#666">âœ¨ ${c.servicio}</div>
                        ${adminInfo}
                    </div>`;
          });
      }

      function showTab(t) {
        document.getElementById("view-agenda").style.display =
          t === "agenda" ? "grid" : "none";
        document.getElementById("view-lista").style.display =
          t === "lista" ? "block" : "none";
        document
          .getElementById("tab-agenda")
          .classList.toggle("active", t === "agenda");
        document
          .getElementById("tab-lista")
          .classList.toggle("active", t === "lista");
        if (t === "lista") loadAllAppointments();
      }

      function moveMonth(d) {
        viewDate.setMonth(viewDate.getMonth() + d);
        renderCalendar();
      }
      async function logout() {
        await client.auth.signOut();
        window.location.reload();
      }
      checkUser();
    </script>
  </body>
</html>
