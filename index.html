<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Nails App - Premium</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
      :root {
        --primary: #d63384;
        --primary-soft: #fce4ec;
        --accent: #f8bbd0;
        --bg: #fff5f8;
        --text: #4a148c;
        --whatsapp: #25d366;
        --danger: #ff4d4d;
        --info: #2196f3;
        --warning: #ff9800;
        --success: #4caf50;
        --full-bg: #ffcdd2;
        --full-text: #b71c1c;
      }

      body {
        font-family: "Segoe UI", sans-serif;
        background: var(--bg);
        margin: 0;
        color: var(--text);
        padding: 10px;
        -webkit-tap-highlight-color: transparent;
      }

      /* ANIMACIONES */
      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }
      @keyframes slideUp {
        from {
          transform: translateY(20px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }
      .animate-fade {
        animation: fadeIn 0.4s ease-out;
      }

      /* MODALES */
      .modal-overlay {
        display: none;
        position: fixed;
        z-index: 3000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: rgba(74, 20, 140, 0.5);
        backdrop-filter: blur(4px);
        align-items: center;
        justify-content: center;
        animation: fadeIn 0.2s ease;
      }
      .modal-content {
        background: white;
        padding: 25px;
        border-radius: 25px;
        width: 85%;
        max-width: 320px;
        text-align: center;
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
        animation: slideUp 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28);
      }
      .modal-icon {
        font-size: 3rem;
        margin-bottom: 10px;
        display: block;
      }
      .modal-btn-row {
        display: flex;
        gap: 10px;
        margin-top: 20px;
      }
      .btn-modal {
        flex: 1;
        padding: 12px;
        border: none;
        border-radius: 12px;
        font-weight: bold;
        cursor: pointer;
        font-size: 0.9rem;
        transition: transform 0.1s;
      }
      .btn-modal:active {
        transform: scale(0.95);
      }
      .btn-modal.primary {
        background: var(--primary);
        color: white;
      }
      .btn-modal.secondary {
        background: #f0f0f0;
        color: #666;
      }
      .btn-modal.whatsapp {
        background: var(--whatsapp);
        color: white;
      }
      .btn-modal.danger {
        background: var(--danger);
        color: white;
      }

      /* ESTILOS BASE */
      #auth-screen,
      #app-screen {
        display: none;
        max-width: 1000px;
        margin: 10px auto;
        background: white;
        border-radius: 25px;
        overflow: hidden;
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
      }
      #auth-screen {
        display: block;
        max-width: 400px;
        margin-top: 40px;
        padding: 30px;
        border: 2px solid var(--accent);
      }

      .nav-header {
        background: var(--primary);
        color: white;
        padding: 15px 25px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .tabs {
        display: flex;
        background: white;
        border-bottom: 2px solid var(--accent);
      }
      .tab-btn {
        flex: 1;
        padding: 15px;
        border: none;
        background: none;
        cursor: pointer;
        font-weight: bold;
        color: #888;
        transition: all 0.3s;
      }
      .tab-btn.active {
        color: var(--primary);
        border-bottom: 3px solid var(--primary);
        background: var(--bg);
      }

      /* CALENDARIO */
      .cal-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 6px;
        margin-top: 10px;
      }
      .day {
        aspect-ratio: 1/1;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 12px;
        cursor: pointer;
        border: 1px solid #fff0f5;
        font-size: 0.9rem;
        transition: transform 0.1s;
      }
      .day:active {
        transform: scale(0.9);
      }
      .day.today {
        border: 2px solid var(--primary);
        color: var(--primary);
        font-weight: 800;
      }
      .day.selected {
        background: var(--primary) !important;
        color: white !important;
        font-weight: bold;
        transform: scale(1.05);
      }
      .day.disabled {
        color: #ddd;
        pointer-events: none;
      }
      .day.full {
        background: var(--full-bg);
        color: var(--full-text);
        border: 1px solid var(--full-bg);
      }

      /* FORMULARIO */
      .main-grid {
        display: grid;
        grid-template-columns: 1fr 350px;
        gap: 20px;
        padding: 20px;
      }
      @media (max-width: 850px) {
        .main-grid {
          grid-template-columns: 1fr;
        }
      }
      input,
      select {
        width: 100%;
        padding: 14px;
        margin: 8px 0;
        border: 2px solid var(--primary-soft);
        border-radius: 15px;
        box-sizing: border-box;
        background: #fafafa;
        font-size: 1rem;
      }
      input:focus,
      select:focus {
        outline: none;
        border-color: var(--primary);
        background: white;
      }
      .btn-main {
        background: var(--primary);
        color: white;
        border: none;
        padding: 16px;
        width: 100%;
        border-radius: 15px;
        cursor: pointer;
        font-weight: bold;
        font-size: 1rem;
        margin-top: 10px;
        transition: transform 0.1s;
      }
      .btn-main:active {
        transform: scale(0.98);
      }
      .btn-main.reschedule-mode {
        background: var(--info);
        box-shadow: 0 4px 15px rgba(33, 150, 243, 0.3);
      }

      /* BARRA DE EDICI√ìN */
      #editModeBar {
        background: var(--info);
        color: white;
        padding: 10px;
        text-align: center;
        font-weight: bold;
        font-size: 0.9rem;
        display: none;
        align-items: center;
        justify-content: space-between;
      }
      .btn-cancel-edit {
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: white;
        padding: 5px 10px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 0.8rem;
      }

      /* CARDS */
      .appointment-card {
        background: white;
        border-left: 6px solid var(--primary);
        padding: 15px;
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        margin-bottom: 15px;
        animation: slideUp 0.4s ease forwards;
      }
      .appointment-card.reprogramada {
        border-left-color: var(--warning);
        background: #fffbf0;
      }

      .admin-data-box {
        background: #f8f8f8;
        padding: 10px;
        border-radius: 12px;
        margin-top: 10px;
        font-size: 0.85rem;
        border: 1px dashed var(--accent);
      }
      .badge-reprogramada {
        display: inline-block;
        background: var(--warning);
        color: white;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 0.7rem;
        font-weight: bold;
        margin-bottom: 5px;
      }

      .actions-row {
        display: flex;
        gap: 6px;
        margin-top: 12px;
        flex-wrap: wrap;
      }
      .btn-action {
        border: none;
        padding: 8px 12px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
        font-size: 0.8rem;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 4px;
        color: white;
        flex: 1;
      }
      .btn-remind {
        background: var(--whatsapp);
      }
      .btn-reschedule {
        background: var(--info);
      }
      .btn-cancel {
        background: white;
        border: 2px solid var(--danger);
        color: var(--danger);
        flex: 0.6;
      }

      /* ADMIN CONFIG */
      .admin-control-panel {
        padding: 20px;
        background: #fff;
      }
      .week-selector {
        display: flex;
        justify-content: center;
        gap: 8px;
        margin: 20px 0;
        flex-wrap: wrap;
      }
      .day-chip {
        width: 40px;
        height: 40px;
        border-radius: 12px;
        background: #f0f0f0;
        color: #888;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        cursor: pointer;
      }
      .day-chip.active {
        background: var(--primary);
        color: white;
      }
      .admin-control-box {
        background: #fff0f5;
        border: 2px dashed var(--primary);
        border-radius: 20px;
        padding: 20px;
        margin-top: 20px;
      }
      .hour-btn {
        padding: 8px;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        font-weight: bold;
        margin: 2px;
      }
      .hour-btn.open {
        background: white;
        border: 2px solid var(--success);
        color: var(--success);
      }
      .hour-btn.blocked {
        background: var(--danger);
        color: white;
        text-decoration: line-through;
        opacity: 0.7;
      }
      .hour-tag {
        display: inline-block;
        background: var(--primary);
        color: white;
        padding: 5px 10px;
        border-radius: 15px;
        margin: 2px;
        font-size: 0.8rem;
      }
    </style>
  </head>
  <body>
    <div id="generalModal" class="modal-overlay">
      <div class="modal-content">
        <div class="modal-icon" id="genIcon">üîî</div>
        <h3 id="genTitle"></h3>
        <p id="genMsg" style="color: #666; margin: 10px 0 20px"></p>
        <div class="modal-btn-row">
          <button
            class="btn-modal primary"
            onclick="closeModal('generalModal')"
          >
            Entendido
          </button>
        </div>
      </div>
    </div>

    <div id="cancelModal" class="modal-overlay">
      <div class="modal-content">
        <div class="modal-icon">‚ö†Ô∏è</div>
        <h3>¬øCancelar Cita?</h3>
        <p style="color: #666">Esta acci√≥n es irreversible.</p>
        <div class="modal-btn-row">
          <button
            class="btn-modal secondary"
            onclick="closeModal('cancelModal')"
          >
            Volver</button
          ><button class="btn-modal danger" onclick="confirmCancelation()">
            S√≠, Cancelar
          </button>
        </div>
      </div>
    </div>

    <div id="wspModal" class="modal-overlay">
      <div class="modal-content">
        <div class="modal-icon">üì©</div>
        <h2>¬°Casi listo!</h2>
        <p>Env√≠a el comprobante por WhatsApp.</p>
        <div class="modal-btn-row">
          <button class="btn-modal whatsapp" onclick="enviarWhatsAppCliente()">
            Enviar üì±
          </button>
        </div>
      </div>
    </div>

    <div id="wspRescheduleModal" class="modal-overlay">
      <div class="modal-content">
        <div class="modal-icon">üîÑ</div>
        <h2>¬°Reprogramada!</h2>
        <p>Tu nueva fecha est√° lista. Avisa por WhatsApp para confirmar.</p>
        <div class="modal-btn-row">
          <button
            class="btn-modal whatsapp"
            onclick="enviarWhatsAppReprogramacion()"
          >
            Avisar Cambio üì±
          </button>
        </div>
      </div>
    </div>

    <div id="auth-screen">
      <h1 style="text-align: center; color: var(--primary)">Nails App</h1>
      <div id="login-form">
        <input type="email" id="loginEmail" placeholder="Correo" />
        <input type="password" id="loginPass" placeholder="Contrase√±a" />
        <button class="btn-main" onclick="handleAuth('login')">Entrar</button>
        <p style="text-align: center; font-size: 0.8rem; margin-top: 20px">
          ¬øNo tienes cuenta?
          <a href="#" onclick="toggleAuth(false)">Reg√≠strate</a>
        </p>
      </div>
      <div id="signup-form" style="display: none">
        <input type="text" id="regNombre" placeholder="Nombre completo" />
        <input type="email" id="regEmail" placeholder="Correo" />
        <input type="password" id="regPass" placeholder="Contrase√±a (min 6)" />
        <button class="btn-main" onclick="handleAuth('signup')">
          Crear Cuenta
        </button>
        <p style="text-align: center; font-size: 0.8rem; margin-top: 20px">
          <a href="#" onclick="toggleAuth(true)">Ya tengo cuenta</a>
        </p>
      </div>
    </div>

    <div id="app-screen">
      <div class="nav-header">
        <span
          >üíÖ <b id="displayUserName"></b>
          <span
            id="adminBadge"
            class="badge-reprogramada"
            style="display: none; background: white; color: var(--primary)"
            >ADMIN</span
          ></span
        >
        <button
          onclick="logout()"
          style="
            background: none;
            border: 1px solid white;
            color: white;
            padding: 5px 10px;
            border-radius: 8px;
            cursor: pointer;
          "
        >
          Salir
        </button>
      </div>

      <div id="editModeBar">
        <span>üîÑ MODO REPROGRAMACI√ìN</span>
        <button class="btn-cancel-edit" onclick="cancelRescheduleMode()">
          Cancelar
        </button>
      </div>

      <div class="tabs">
        <button
          id="tab-agenda"
          class="tab-btn active"
          onclick="showTab('agenda')"
        >
          Agendar
        </button>
        <button id="tab-lista" class="tab-btn" onclick="showTab('lista')">
          Mis Citas
        </button>
        <button
          id="tab-config"
          class="tab-btn"
          onclick="showTab('config')"
          style="display: none"
        >
          Configurar
        </button>
      </div>

      <div id="view-agenda" class="main-grid animate-fade">
        <div>
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: 10px;
            "
          >
            <button
              onclick="moveMonth(-1)"
              style="
                border: none;
                background: none;
                font-size: 1.2rem;
                cursor: pointer;
              "
            >
              ‚óÄ
            </button>
            <b id="monthDisplay"></b>
            <button
              onclick="moveMonth(1)"
              style="
                border: none;
                background: none;
                font-size: 1.2rem;
                cursor: pointer;
              "
            >
              ‚ñ∂
            </button>
          </div>
          <div class="cal-grid" id="calendarGrid"></div>
        </div>

        <div class="form-section">
          <div id="newAppointmentFields">
            <input
              type="text"
              id="fieldNombre"
              placeholder="Nombre de clienta"
            />
            <input type="email" id="fieldCorreo" placeholder="Correo" />
            <input
              type="tel"
              id="fieldTelefono"
              placeholder="WhatsApp"
              pattern="[0-9]*"
              oninput="this.value = this.value.replace(/[^0-9]/g, '')"
            />
            <select id="fieldServicio">
              <option>U√±as Acr√≠licas</option>
              <option>Retoque</option>
              <option>Semipermanente</option>
            </select>
          </div>

          <select id="fieldHora"></select>

          <div id="fileUploadDiv">
            <label
              style="
                font-size: 0.75rem;
                font-weight: bold;
                color: var(--primary);
              "
              >FOTO COMPROBANTE:</label
            >
            <input type="file" id="fieldFile" accept="image/*" />
          </div>

          <button id="btnMainAction" class="btn-main" onclick="confirmarCita()">
            ‚ú® Reservar Espacio
          </button>
        </div>
      </div>

      <div
        id="view-lista"
        style="display: none; padding: 20px"
        class="animate-fade"
      >
        <div id="tablaCitasContainer"></div>
      </div>

      <div
        id="view-config"
        class="admin-control-panel animate-fade"
        style="display: none"
      >
        <h3 style="text-align: center; color: var(--primary)">
          Horario Base Semanal
        </h3>
        <div class="week-selector">
          <div class="day-chip" id="d1" onclick="toggleWeekDay(1)">Lu</div>
          <div class="day-chip" id="d2" onclick="toggleWeekDay(2)">Ma</div>
          <div class="day-chip" id="d3" onclick="toggleWeekDay(3)">Mi</div>
          <div class="day-chip" id="d4" onclick="toggleWeekDay(4)">Ju</div>
          <div class="day-chip" id="d5" onclick="toggleWeekDay(5)">Vi</div>
          <div class="day-chip" id="d6" onclick="toggleWeekDay(6)">Sa</div>
          <div class="day-chip" id="d0" onclick="toggleWeekDay(0)">Do</div>
        </div>
        <div class="hours-editor-box" id="hoursEditor" style="display: none">
          <div id="weeklyHours" style="margin-bottom: 10px"></div>
          <div class="add-hour-row">
            <input type="time" id="newHourInput" style="margin: 0" />
            <button
              class="btn-main"
              style="width: auto; padding: 0 20px; margin: 0; height: 50px"
              onclick="addStagedHour()"
            >
              +
            </button>
          </div>
          <button
            class="btn-main"
            style="background: var(--success); margin-top: 15px"
            onclick="saveWeekSchedule()"
          >
            üíæ Guardar
          </button>
        </div>

        <h3
          style="
            text-align: center;
            color: var(--primary);
            margin-top: 40px;
            border-top: 1px solid #eee;
            padding-top: 20px;
          "
        >
          Bloqueos por Fecha
        </h3>
        <input
          type="date"
          id="adminDateInput"
          onchange="loadAdminDayConfig()"
        />
        <div
          id="adminPanelControls"
          style="display: none"
          class="admin-control-box"
        >
          <button
            id="btnToggleDay"
            class="btn-block-day"
            onclick="toggleFullDayBlock()"
          >
            üîì D√çA ABIERTO
          </button>
          <div
            style="
              display: grid;
              grid-template-columns: repeat(3, 1fr);
              gap: 8px;
              margin-top: 15px;
            "
            id="adminHourGrid"
          ></div>
        </div>
      </div>
    </div>

    <script>
      const sbUrl = "https://jifwtgpchbipxyriirtq.supabase.co";
      const sbKey = "sb_publishable_zF5mj6Ba61zibU_19vnFPQ_a4GDaKwi";
      const client = supabase.createClient(sbUrl, sbKey);
      const miWhatsAppAdmin = "573228211246";

      let userProfile = null;
      let globalSchedule = {};
      let selectedWeekDays = [],
        stagedHours = [];
      let viewDate = new Date();
      let selectedDate = null;
      let lastCitaData = null;

      // VARIABLES PARA REPROGRAMAR
      let isRescheduling = false;
      let rescheduleId = null;
      let rescheduleData = null;

      // VARIABLES PARA BORRAR
      let pendingCancelId = null;
      let pendingCancelData = null; // {tel, name, isClient}

      function format12h(h24) {
        if (!h24) return "";
        let [h, m] = h24.split(":");
        let suf = h >= 12 ? "PM" : "AM";
        h = h % 12 || 12;
        return `${h}:${m} ${suf}`;
      }

      function showAlert(t, m, i = "üîî") {
        document.getElementById("genIcon").innerText = i;
        document.getElementById("genTitle").innerText = t;
        document.getElementById("genMsg").innerText = m;
        document.getElementById("generalModal").style.display = "flex";
      }
      function closeModal(id) {
        document.getElementById(id).style.display = "none";
      }

      // AUTH
      function toggleAuth(l) {
        document.getElementById("login-form").style.display = l
          ? "block"
          : "none";
        document.getElementById("signup-form").style.display = l
          ? "none"
          : "block";
      }
      async function handleAuth(type) {
        const email = document.getElementById(
          type === "login" ? "loginEmail" : "regEmail",
        ).value;
        const pass = document.getElementById(
          type === "login" ? "loginPass" : "regPass",
        ).value;
        if (type === "signup") {
          const { error } = await client.auth.signUp({
            email,
            password: pass,
            options: {
              data: { full_name: document.getElementById("regNombre").value },
            },
          });
          if (error) showAlert("Error", error.message);
          else showAlert("√âxito", "Cuenta creada. Inicia sesi√≥n.");
        } else {
          const { error } = await client.auth.signInWithPassword({
            email,
            password: pass,
          });
          if (error) showAlert("Error", error.message);
          else checkUser();
        }
      }

      async function checkUser() {
        const {
          data: { session },
        } = await client.auth.getSession();
        if (session) {
          const { data } = await client
            .from("profiles")
            .select("*")
            .eq("id", session.user.id)
            .single();
          if (!data) return setTimeout(checkUser, 500);
          userProfile = data;
          document.getElementById("auth-screen").style.display = "none";
          document.getElementById("app-screen").style.display = "block";
          document.getElementById("displayUserName").innerText = data.full_name;

          // Prellenar datos
          document.getElementById("fieldNombre").value = data.full_name;
          document.getElementById("fieldCorreo").value = session.user.email;

          await fetchSchedule();
          if (data.role === "admin") {
            document.getElementById("adminBadge").style.display =
              "inline-block";
            document.getElementById("tab-config").style.display = "block";
            // Admin puede editar campos
            document.getElementById("fieldNombre").readOnly = false;
            document.getElementById("fieldCorreo").readOnly = false;
          } else {
            // Cliente solo lectura en campos clave
            document.getElementById("fieldNombre").readOnly = true;
            document.getElementById("fieldCorreo").readOnly = true;
          }
          renderCalendar();
        }
      }

      // --- L√ìGICA DE REPROGRAMACI√ìN (CLIENTE Y ADMIN) ---

      function startReschedule(id, fecha, hora, servicio, nombre, tel) {
        // Activar modo edici√≥n
        isRescheduling = true;
        rescheduleId = id;
        rescheduleData = { fecha, hora, servicio, nombre, tel };

        // UI Changes
        document.getElementById("editModeBar").style.display = "flex";
        document.getElementById("newAppointmentFields").style.display = "none"; // Ocultar datos pers
        document.getElementById("fileUploadDiv").style.display = "none"; // Ocultar subida de foto

        const btn = document.getElementById("btnMainAction");
        btn.innerText = "üîÑ Guardar Nueva Fecha";
        btn.className = "btn-main reschedule-mode";

        // Llevar al calendario
        showTab("agenda");
        showAlert(
          "Modo Reprogramaci√≥n",
          "Selecciona el NUEVO d√≠a y hora en el calendario.",
          "üóìÔ∏è",
        );
      }

      function cancelRescheduleMode() {
        isRescheduling = false;
        rescheduleId = null;
        rescheduleData = null;

        document.getElementById("editModeBar").style.display = "none";
        document.getElementById("newAppointmentFields").style.display = "block";
        document.getElementById("fileUploadDiv").style.display = "block";

        const btn = document.getElementById("btnMainAction");
        btn.innerText = "‚ú® Reservar Espacio";
        btn.className = "btn-main";
      }

      // --- GUARDAR CITA (NUEVA O REPROGRAMADA) ---
      async function confirmarCita() {
        if (!selectedDate)
          return showAlert("Falta Fecha", "Selecciona un d√≠a.");
        const hora = document.getElementById("fieldHora").value;
        if (!hora) return showAlert("Falta Hora", "Selecciona una hora.");

        if (isRescheduling) {
          // --- UPDATE (REPROGRAMAR) ---
          try {
            const { error } = await client
              .from("citas")
              .update({
                fecha: selectedDate,
                hora: hora,
                estado: "reprogramada", // MARCA PARA EL ADMIN
              })
              .eq("id", rescheduleId);

            if (error) throw error;

            // Guardamos datos para el modal de √©xito
            lastCitaData = {
              ...rescheduleData,
              fecha: selectedDate,
              hora: hora,
            };
            document.getElementById("wspRescheduleModal").style.display =
              "flex";

            // Limpieza
            cancelRescheduleMode();
            loadAllAppointments();
          } catch (err) {
            showAlert("Error", err.message, "üö´");
          }
        } else {
          // --- INSERT (NUEVA CITA) ---
          const tel = document.getElementById("fieldTelefono").value;
          const file = document.getElementById("fieldFile").files[0];
          if (!tel || !file)
            return showAlert(
              "Faltan Datos",
              "Tel√©fono y comprobante requeridos.",
            );

          const datos = {
            fecha: selectedDate,
            hora,
            nombre: document.getElementById("fieldNombre").value,
            correo: document.getElementById("fieldCorreo").value,
            telefono: tel,
            servicio: document.getElementById("fieldServicio").value,
            user_id: userProfile.id,
            estado: "pendiente",
          };

          const { error } = await client.from("citas").insert([datos]);
          if (error) showAlert("Error", error.message);
          else {
            lastCitaData = datos;
            document.getElementById("wspModal").style.display = "flex";
          }
        }
      }

      function enviarWhatsAppReprogramacion() {
        const msg =
          `Hola, he reprogramado mi cita (ID: ${rescheduleId}).\n` +
          `üë§ Nombre: ${lastCitaData.nombre}\n` +
          `üìÖ Nueva Fecha: *${lastCitaData.fecha}*\n` +
          `üïí Nueva Hora: *${format12h(lastCitaData.hora)}*\n` +
          `Gracias por la gesti√≥n. ‚ú®`;
        window.open(
          `https://wa.me/${miWhatsAppAdmin}?text=${encodeURIComponent(msg)}`,
          "_blank",
        );
        closeModal("wspRescheduleModal");
        showTab("lista");
      }

      function enviarWhatsAppCliente() {
        const msg = `Hola! Soy *${lastCitaData.nombre}*.\nServicio: ${lastCitaData.servicio}\nFecha: ${lastCitaData.fecha} - ${format12h(lastCitaData.hora)}\nAdjunto comprobante. ‚ú®`;
        window.open(
          `https://wa.me/${miWhatsAppAdmin}?text=${encodeURIComponent(msg)}`,
          "_blank",
        );
        closeModal("wspModal");
        showTab("lista");
      }

      // --- CANCELAR CITAS (CLIENTE Y ADMIN) ---
      function openCancelModal(id, tel, name, isClient) {
        pendingCancelId = id;
        pendingCancelData = { tel, name, isClient };
        document.getElementById("cancelModal").style.display = "flex";
      }

      async function confirmCancelation() {
        if (!pendingCancelId) return;
        const { error } = await client
          .from("citas")
          .delete()
          .eq("id", pendingCancelId);
        if (error) showAlert("Error", error.message);
        else {
          // Si es admin, avisa al cliente. Si es cliente, avisa al admin.
          let msg = "";
          let num = "";

          if (pendingCancelData.isClient) {
            // El cliente cancel√≥ -> Avisar al admin
            msg = `Hola, deseo CANCELAR mi cita del d√≠a. Nombre: ${pendingCancelData.name}. Disculpa las molestias.`;
            num = miWhatsAppAdmin;
          } else {
            // Admin cancel√≥ -> Avisar al cliente
            msg = `Hola ${pendingCancelData.name}, lamentamos informarte que hemos cancelado tu cita. Por favor cont√°ctanos para reagendar.`;
            num = pendingCancelData.tel;
          }

          window.open(
            `https://wa.me/${num}?text=${encodeURIComponent(msg)}`,
            "_blank",
          );
          loadAllAppointments();
          closeModal("cancelModal");
        }
      }

      // LISTA DE CITAS
      async function loadAllAppointments() {
        let q = client.from("citas").select("*");
        if (userProfile.role !== "admin") q = q.eq("user_id", userProfile.id);

        const { data } = await q.order("fecha").order("hora");
        const container = document.getElementById("tablaCitasContainer");
        container.innerHTML = "";

        if (!data) return;

        const hoy = new Date().toISOString().split("T")[0];

        data.forEach((c) => {
          const safeName = c.nombre.replace(/'/g, "");
          const isReprogramada = c.estado === "reprogramada";
          const badge = isReprogramada
            ? `<div class="badge-reprogramada">‚ö†Ô∏è REPROGRAMADA</div>`
            : "";
          const cardClass = isReprogramada
            ? "appointment-card reprogramada animate-fade"
            : "appointment-card animate-fade";

          let buttonsHtml = "";

          if (userProfile.role === "admin") {
            // BOTONES DE ADMIN
            buttonsHtml = `
                    <div class="actions-row">
                        <button class="btn-action btn-remind" onclick="window.open('https://wa.me/${c.telefono}?text=Recordatorio%20cita%20${c.fecha}')">üìÖ Recordar</button>
                        <button class="btn-action btn-cancel" onclick="openCancelModal('${c.id}', '${c.telefono}', '${safeName}', false)">‚ùå</button>
                    </div>`;
          } else {
            // BOTONES DE CLIENTE (Reprogramar y Cancelar)
            // Solo permitimos acciones si la fecha es hoy o futuro
            if (c.fecha >= hoy) {
              buttonsHtml = `
                        <div class="actions-row">
                            <button class="btn-action btn-reschedule" onclick="startReschedule('${c.id}', '${c.fecha}', '${c.hora}', '${c.servicio}', '${safeName}', '${c.telefono}')">üîÑ Reprogramar</button>
                            <button class="btn-action btn-cancel" onclick="openCancelModal('${c.id}', '${c.telefono}', '${safeName}', true)">‚ùå Cancelar</button>
                        </div>
                      `;
            }
          }

          container.innerHTML += `
                  <div class="${cardClass}">
                      ${badge}
                      <div style="font-weight:bold; color:var(--primary)">üïí ${format12h(c.hora)} - ${c.fecha}</div>
                      <div style="font-size:1.1rem; margin:5px 0">üë§ ${c.nombre}</div>
                      <div style="font-size:0.8rem; color:#666">‚ú® ${c.servicio}</div>
                      ${userProfile.role === "admin" ? `<div class="admin-data-box">üì± ${c.telefono}<br>üìß ${c.correo}</div>` : ""}
                      ${buttonsHtml}
                  </div>
              `;
        });
      }

      // --- CALENDARIO Y HORARIOS (L√ìGICA EXISTENTE) ---
      async function fetchSchedule() {
        const { data } = await client.from("horarios_base").select("*");
        if (data) data.forEach((i) => (globalSchedule[i.dia] = i.horas));
      }

      function renderCalendar() {
        const grid = document.getElementById("calendarGrid");
        grid.innerHTML = "";
        ["Do", "Lu", "Ma", "Mi", "Ju", "Vi", "Sa"].forEach(
          (d) =>
            (grid.innerHTML += `<div style="font-size:0.75rem; text-align:center; color:#bbb">${d}</div>`),
        );

        const year = viewDate.getFullYear(),
          month = viewDate.getMonth();
        document.getElementById("monthDisplay").innerText = new Date(
          year,
          month,
        ).toLocaleString("es-ES", { month: "long", year: "numeric" });

        const firstDay = new Date(year, month, 1).getDay();
        const lastDate = new Date(year, month + 1, 0).getDate();
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        for (let i = 0; i < firstDay; i++) grid.innerHTML += `<div></div>`;
        for (let i = 1; i <= lastDate; i++) {
          const d = document.createElement("div");
          const dStr = `${year}-${String(month + 1).padStart(2, "0")}-${String(i).padStart(2, "0")}`;
          const cDate = new Date(dStr + "T00:00:00");

          d.className = "day";
          d.innerText = i;
          d.id = `day-${dStr}`;
          if (cDate < today) d.classList.add("disabled");
          else {
            if (cDate.getTime() === today.getTime()) d.classList.add("today");
            d.onclick = () => {
              if (d.classList.contains("full"))
                return showAlert("D√≠a Cerrado", "No hay citas disponibles.");
              document
                .querySelectorAll(".day")
                .forEach((e) => e.classList.remove("selected"));
              d.classList.add("selected");
              selectedDate = dStr;
              checkHoras(dStr);
            };
          }
          grid.appendChild(d);
        }
        updateFullDays(year, month, lastDate);
      }

      async function updateFullDays(y, m, last) {
        const start = `${y}-${String(m + 1).padStart(2, "0")}-01`,
          end = `${y}-${String(m + 1).padStart(2, "0")}-${last}`;
        const { data: citas } = await client
          .from("citas")
          .select("fecha,hora")
          .gte("fecha", start)
          .lte("fecha", end);
        const { data: bloq } = await client
          .from("bloqueos")
          .select("fecha,hora")
          .gte("fecha", start)
          .lte("fecha", end);

        for (let i = 1; i <= last; i++) {
          const dStr = `${y}-${String(m + 1).padStart(2, "0")}-${String(i).padStart(2, "0")}`;
          const el = document.getElementById(`day-${dStr}`);
          if (!el || el.classList.contains("disabled")) continue;

          const dayW = new Date(dStr + "T00:00:00").getDay();
          const base = globalSchedule[dayW] || [];
          const dayBloq = bloq.some((b) => b.fecha === dStr && b.hora === null);

          if (dayBloq || base.length === 0) {
            el.classList.add("full");
            continue;
          }

          const taken = [
            ...citas.filter((c) => c.fecha === dStr).map((c) => c.hora),
            ...bloq
              .filter((b) => b.fecha === dStr && b.hora)
              .map((b) => b.hora),
          ];
          const avail = base.filter((h) => !taken.includes(h));
          if (avail.length === 0) el.classList.add("full");
        }
      }

      async function checkHoras(fecha) {
        const dayW = new Date(fecha + "T00:00:00").getDay();
        let base = globalSchedule[dayW] ? [...globalSchedule[dayW]].sort() : [];

        const { data: citas } = await client
          .from("citas")
          .select("hora")
          .eq("fecha", fecha);
        const { data: bloq } = await client
          .from("bloqueos")
          .select("hora")
          .eq("fecha", fecha);

        const taken = [...citas.map((c) => c.hora), ...bloq.map((b) => b.hora)];
        const isDayBloq = bloq.some((b) => b.hora === null);

        const sel = document.getElementById("fieldHora");
        sel.innerHTML = "";
        if (base.length === 0 || isDayBloq) {
          sel.add(new Option("D√≠a Cerrado", ""));
          sel.disabled = true;
          return;
        }

        sel.disabled = false;
        let any = false;
        base.forEach((h) => {
          const opt = document.createElement("option");
          opt.value = h;
          if (taken.includes(h)) {
            opt.disabled = true;
            opt.text = format12h(h) + " (Ocupado)";
          } else {
            opt.text = format12h(h);
            any = true;
          }
          sel.appendChild(opt);
        });
        if (!any) {
          sel.innerHTML = "";
          sel.add(new Option("Sin cupos", ""));
          sel.disabled = true;
        }
      }

      function moveMonth(v) {
        viewDate.setMonth(viewDate.getMonth() + v);
        renderCalendar();
      }
      function showTab(t) {
        ["agenda", "lista", "config"].forEach(
          (x) => (document.getElementById(`view-${x}`).style.display = "none"),
        );
        ["agenda", "lista", "config"].forEach(
          (x) => (document.getElementById(`tab-${x}`).className = "tab-btn"),
        );
        document.getElementById(`view-${t}`).style.display =
          t === "agenda" ? "grid" : t === "config" ? "block" : "block";
        document.getElementById(`tab-${t}`).className = "tab-btn active";
        if (t === "lista") loadAllAppointments();
        if (t !== "agenda" && isRescheduling) cancelRescheduleMode(); // Cancelar modo edici√≥n si sale
      }
      async function logout() {
        await client.auth.signOut();
        window.location.reload();
      }

      // ADMIN CONFIG LOGIC (Simplificada)
      function toggleWeekDay(d) {
        const el = document.getElementById(`d${d}`);
        const idx = selectedWeekDays.indexOf(d);
        if (idx > -1) {
          selectedWeekDays.splice(idx, 1);
          el.classList.remove("active");
        } else {
          if (selectedWeekDays.length === 0) {
            stagedHours = globalSchedule[d] ? [...globalSchedule[d]] : [];
            renderStaged();
          }
          selectedWeekDays.push(d);
          el.classList.add("active");
        }
        document.getElementById("hoursEditor").style.display =
          selectedWeekDays.length ? "block" : "none";
      }
      function renderStaged() {
        const c = document.getElementById("weeklyHours");
        c.innerHTML = "";
        stagedHours.sort().forEach((h) => {
          c.innerHTML += `<span class="hour-tag">${format12h(h)} <span onclick="remStaged('${h}')">x</span></span>`;
        });
      }
      function addStagedHour() {
        const h = document.getElementById("newHourInput").value;
        if (h && !stagedHours.includes(h)) {
          stagedHours.push(h);
          renderStaged();
        }
      }
      function remStaged(h) {
        stagedHours = stagedHours.filter((x) => x !== h);
        renderStaged();
      }
      async function saveWeekSchedule() {
        for (let d of selectedWeekDays)
          await client
            .from("horarios_base")
            .upsert({ dia: d, horas: stagedHours });
        selectedWeekDays.forEach((d) =>
          document.getElementById(`d${d}`).classList.remove("active"),
        );
        selectedWeekDays = [];
        document.getElementById("hoursEditor").style.display = "none";
        showAlert("Guardado", "Horario actualizado");
      }
      async function loadAdminDayConfig() {
        const d = document.getElementById("adminDateInput").value;
        if (!d) return;
        adminSelectedDate = d;
        document.getElementById("adminPanelControls").style.display = "block";
        const { data } = await client
          .from("bloqueos")
          .select("*")
          .eq("fecha", d);
        const isFull = data.some((b) => b.hora === null);
        document.getElementById("btnToggleDay").innerText = isFull
          ? "üîí D√çA CERRADO"
          : "üîì D√çA ABIERTO";
        document.getElementById("btnToggleDay").className = isFull
          ? "btn-block-day is-blocked"
          : "btn-block-day";

        const dayW = new Date(d + "T00:00:00").getDay();
        const base = globalSchedule[dayW] || [];
        const grid = document.getElementById("adminHourGrid");
        grid.innerHTML = "";
        base.sort().forEach((h) => {
          const isB = data.some((b) => b.hora === h);
          grid.innerHTML += `<button class="hour-btn ${isB ? "blocked" : "open"}" onclick="toggleBlock('${h}',${isB})">${format12h(h)}</button>`;
        });
      }
      async function toggleFullDayBlock() {
        const { data } = await client
          .from("bloqueos")
          .select("*")
          .eq("fecha", adminSelectedDate)
          .is("hora", null);
        if (data.length)
          await client.from("bloqueos").delete().eq("id", data[0].id);
        else
          await client
            .from("bloqueos")
            .insert([{ fecha: adminSelectedDate, hora: null }]);
        loadAdminDayConfig();
      }
      async function toggleBlock(h, isB) {
        if (isB)
          await client
            .from("bloqueos")
            .delete()
            .eq("fecha", adminSelectedDate)
            .eq("hora", h);
        else
          await client
            .from("bloqueos")
            .insert([{ fecha: adminSelectedDate, hora: h }]);
        loadAdminDayConfig();
      }
    </script>
  </body>
</html>
