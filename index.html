<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>NailsByNINA - App</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
      :root {
        --primary: #ff1493;
        --primary-glow: 0 0 10px rgba(255, 20, 147, 0.4);
        --bg: #fff0f5;
        --card-bg: #ffffff;
        --text: #4a148c;
        --text-light: #888;
        --whatsapp: #25d366;
        --danger: #ff3366;
        --info: #00bfff;
        --success: #00e676;
        --radius: 20px;
      }

      body {
        font-family: "Segoe UI", sans-serif;
        background: var(--bg);
        margin: 0;
        color: var(--text);
        padding: 15px;
        -webkit-tap-highlight-color: transparent;
        overscroll-behavior-y: none;
      }

      @keyframes popIn {
        0% {
          opacity: 0;
          transform: scale(0.98);
        }
        100% {
          opacity: 1;
          transform: scale(1);
        }
      }
      .animate-pop {
        animation: popIn 0.3s ease-out;
      }

      /* MODALES */
      .modal-overlay {
        display: none;
        position: fixed;
        z-index: 3000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.6);
        backdrop-filter: blur(8px);
        align-items: center;
        justify-content: center;
      }
      .modal-content {
        background: white;
        padding: 30px;
        border-radius: var(--radius);
        width: 85%;
        max-width: 340px;
        text-align: center;
        box-shadow: 0 20px 60px rgba(255, 20, 147, 0.15);
        border: 1px solid rgba(255, 20, 147, 0.1);
        animation: popIn 0.3s ease-out;
      }
      .modal-icon {
        font-size: 3.5rem;
        margin-bottom: 15px;
        display: block;
      }
      .modal-btn-row {
        display: flex;
        gap: 12px;
        margin-top: 25px;
      }
      .btn-modal {
        flex: 1;
        padding: 14px;
        border: none;
        border-radius: 12px;
        font-weight: 600;
        cursor: pointer;
        font-size: 0.95rem;
        transition: transform 0.2s;
      }
      .btn-modal:active {
        transform: scale(0.95);
      }
      .btn-modal.primary {
        background: var(--primary);
        color: white;
        box-shadow: var(--primary-glow);
      }
      .btn-modal.secondary {
        background: #f0f0f0;
        color: #666;
      }
      .btn-modal.whatsapp {
        background: var(--whatsapp);
        color: white;
        box-shadow: 0 4px 10px rgba(37, 211, 102, 0.3);
      }
      .btn-modal.danger {
        background: var(--danger);
        color: white;
      }

      /* LAYOUT */
      #auth-screen,
      #app-screen,
      #recovery-screen {
        display: none;
        max-width: 800px;
        margin: 0 auto;
        background: var(--card-bg);
        border-radius: var(--radius);
        overflow: hidden;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.03);
        min-height: 85vh;
      }
      #auth-screen,
      #recovery-screen {
        display: block;
        max-width: 400px;
        margin-top: 40px;
        padding: 40px 30px;
        border: 2px solid #ffe6f2;
        min-height: auto;
      }
      #recovery-screen {
        display: none;
      }

      .nav-header {
        background: white;
        color: var(--primary);
        padding: 20px 25px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid #ffe6f2;
      }

      .tabs {
        display: flex;
        background: white;
        padding: 5px;
        border-bottom: 1px solid #f8f8f8;
        overflow-x: auto;
        white-space: nowrap;
      }
      .tab-btn {
        flex: 1;
        min-width: 70px;
        padding: 15px 5px;
        border: none;
        background: none;
        cursor: pointer;
        font-weight: 600;
        color: #bbb;
        position: relative;
        transition: color 0.3s;
      }
      .tab-btn.active {
        color: var(--primary);
      }
      .tab-btn.active::after {
        content: "";
        position: absolute;
        bottom: 5px;
        left: 50%;
        transform: translateX(-50%);
        width: 6px;
        height: 6px;
        background: var(--primary);
        border-radius: 50%;
        box-shadow: var(--primary-glow);
      }

      .cal-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 8px;
        margin-top: 15px;
      }
      .day {
        aspect-ratio: 1/1;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 14px;
        cursor: pointer;
        font-size: 0.9rem;
        transition: all 0.2s;
        background: #fff;
        border: 1px solid transparent;
        color: #555;
      }
      .day.today {
        border-color: var(--primary);
        color: var(--primary);
        font-weight: 700;
      }
      .day.selected {
        background: var(--primary) !important;
        color: white !important;
        box-shadow: var(--primary-glow);
        transform: scale(1.05);
        font-weight: bold;
      }
      .day.full {
        background: #f8f8f8;
        color: #ddd;
        text-decoration: line-through;
        pointer-events: none;
      }
      .day.disabled {
        opacity: 0.3;
        pointer-events: none;
      }

      .main-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 30px;
        padding: 25px;
      }
      @media (min-width: 768px) {
        .main-grid {
          grid-template-columns: 1fr 350px;
        }
      }

      input,
      select {
        width: 100%;
        padding: 16px;
        margin: 8px 0;
        border: 2px solid #f0f0f0;
        border-radius: 16px;
        box-sizing: border-box;
        background: #fbfbfb;
        font-size: 1rem;
        color: #333;
      }
      input:focus,
      select:focus {
        outline: none;
        border-color: var(--primary);
        background: white;
      }

      .password-wrapper {
        position: relative;
        width: 100%;
        margin: 8px 0;
      }
      .password-wrapper input {
        margin: 0;
        padding-right: 45px;
      }
      .toggle-eye {
        position: absolute;
        right: 15px;
        top: 50%;
        transform: translateY(-50%);
        cursor: pointer;
        font-size: 1.2rem;
        color: #bbb;
        user-select: none;
        z-index: 10;
      }

      .file-upload-wrapper {
        margin: 15px 0;
        text-align: center;
      }
      .custom-file-upload {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        padding: 12px 20px;
        cursor: pointer;
        border: 2px dashed var(--primary);
        border-radius: 15px;
        background: rgba(255, 20, 147, 0.03);
        color: var(--primary);
        font-weight: bold;
        width: 100%;
        box-sizing: border-box;
      }
      #fileNameDisplay {
        display: block;
        font-size: 0.8rem;
        color: #888;
        margin-top: 5px;
        font-style: italic;
      }

      .btn-main {
        background: var(--primary);
        color: white;
        border: none;
        padding: 18px;
        width: 100%;
        border-radius: 16px;
        cursor: pointer;
        font-weight: 700;
        font-size: 1.05rem;
        margin-top: 15px;
        box-shadow: var(--primary-glow);
        transition: transform 0.2s;
      }
      .btn-main:active {
        transform: scale(0.98);
      }
      .btn-main.reschedule-mode {
        background: var(--info);
        box-shadow: 0 0 15px rgba(0, 191, 255, 0.4);
      }
      .btn-main:disabled {
        background: #ccc;
        box-shadow: none;
        cursor: not-allowed;
      }

      .appointment-card {
        background: white;
        border: 1px solid #f0f0f0;
        padding: 20px;
        border-radius: 18px;
        margin-bottom: 20px;
        position: relative;
        overflow: hidden;
      }
      .appointment-card::before {
        content: "";
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 5px;
        background: var(--primary);
      }
      .appointment-card.reprogramada::before {
        background: var(--info);
      }
      .status-pill {
        display: inline-block;
        font-size: 0.7rem;
        padding: 4px 10px;
        border-radius: 20px;
        background: #f0f0f0;
        color: #666;
        margin-bottom: 8px;
        font-weight: 600;
      }
      .status-pill.repro {
        background: rgba(0, 191, 255, 0.1);
        color: var(--info);
        border: 1px solid var(--info);
      }
      .actions-row {
        display: flex;
        gap: 10px;
        margin-top: 15px;
      }
      .btn-action {
        border: none;
        padding: 10px;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 600;
        font-size: 0.85rem;
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 5px;
      }
      .btn-reschedule {
        background: #eeffff;
        color: var(--info);
      }
      .btn-cancel {
        background: #fff5f5;
        color: var(--danger);
      }

      .admin-control-panel {
        padding: 20px;
        background: white;
      }
      .day-chip {
        width: 45px;
        height: 45px;
        border-radius: 14px;
        background: #f5f5f5;
        color: #aaa;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        cursor: pointer;
      }
      .day-chip.active {
        background: var(--primary);
        color: white;
        transform: translateY(-3px);
      }
      .hour-tag {
        display: inline-block;
        background: var(--primary);
        color: white;
        padding: 6px 12px;
        border-radius: 20px;
        margin: 4px;
        font-size: 0.85rem;
      }
      #editModeBar {
        background: var(--info);
        color: white;
        padding: 12px;
        text-align: center;
        font-weight: bold;
        display: none;
        justify-content: space-between;
        align-items: center;
        border-radius: 0 0 15px 15px;
        margin-bottom: 15px;
      }
      .service-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: #f9f9f9;
        padding: 15px;
        border-radius: 12px;
        margin-bottom: 8px;
        border: 1px solid #eee;
      }
      .btn-delete-svc {
        background: #ffebee;
        color: var(--danger);
        border: none;
        padding: 8px 12px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
        font-size: 0.8rem;
      }
      .add-row {
        display: flex;
        gap: 10px;
        align-items: center;
        margin-top: 15px;
      }
      .add-row input {
        margin: 0;
        flex: 1;
        border: 2px solid #ddd;
      }
      .add-row button {
        width: auto;
        margin: 0;
        padding: 0 20px;
        height: 58px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
      }
    </style>
  </head>
  <body>
    <div id="generalModal" class="modal-overlay">
      <div class="modal-content">
        <div class="modal-icon" id="genIcon">‚ú®</div>
        <h3 id="genTitle" style="color: var(--primary); margin: 0"></h3>
        <p
          id="genMsg"
          style="color: #666; margin: 15px 0 25px; line-height: 1.5"
        ></p>
        <div class="modal-btn-row">
          <button
            class="btn-modal primary"
            onclick="closeModal('generalModal')"
          >
            Entendido
          </button>
        </div>
      </div>
    </div>

    <div id="resetModal" class="modal-overlay">
      <div class="modal-content">
        <div class="modal-icon">üìß</div>
        <h3 style="color: var(--primary); margin: 0">Recuperar Cuenta</h3>
        <p style="color: #666; margin: 10px 0">
          Ingresa tu correo y te enviaremos un enlace m√°gico.
        </p>
        <input
          type="email"
          id="resetEmailInput"
          placeholder="tucorreo@ejemplo.com"
        />
        <div class="modal-btn-row">
          <button
            class="btn-modal secondary"
            onclick="closeModal('resetModal')"
          >
            Cancelar
          </button>
          <button class="btn-modal primary" onclick="sendResetEmail()">
            Enviar
          </button>
        </div>
      </div>
    </div>

    <div id="cancelModal" class="modal-overlay">
      <div class="modal-content">
        <div class="modal-icon">üíî</div>
        <h3 style="color: var(--text); margin: 0">¬øCancelar Cita?</h3>
        <p style="color: #888; margin-top: 10px">
          Esta acci√≥n liberar√° tu espacio.
        </p>
        <div class="modal-btn-row">
          <button
            class="btn-modal secondary"
            onclick="closeModal('cancelModal')"
          >
            Volver
          </button>
          <button class="btn-modal danger" onclick="confirmCancelation()">
            S√≠, Cancelar
          </button>
        </div>
      </div>
    </div>

    <div id="wspModal" class="modal-overlay">
      <div class="modal-content">
        <div class="modal-icon">üíÖ</div>
        <h2 style="color: var(--primary); margin: 0">¬°Casi Listo!</h2>
        <p style="color: #666; margin: 15px 0">
          Para confirmar, env√≠a tu comprobante.
        </p>
        <div class="modal-btn-row">
          <button class="btn-modal whatsapp" onclick="enviarWhatsAppCliente()">
            Enviar Comprobante
          </button>
        </div>
      </div>
    </div>

    <div id="wspRescheduleModal" class="modal-overlay">
      <div class="modal-content">
        <div class="modal-icon">üîÑ</div>
        <h2 style="color: var(--info); margin: 0">Cambio Realizado</h2>
        <p style="color: #666; margin: 15px 0">
          Nueva fecha reservada. Av√≠sanos.
        </p>
        <div class="modal-btn-row">
          <button
            class="btn-modal whatsapp"
            onclick="enviarWhatsAppReprogramacion()"
          >
            Confirmar Cambio
          </button>
        </div>
      </div>
    </div>

    <div id="recovery-screen" class="animate-pop">
      <h1 style="text-align: center; color: var(--primary)">
        Restablecer Clave
      </h1>
      <p
        id="recoveryStatus"
        style="text-align: center; color: #666; margin-bottom: 20px"
      >
        Verificando enlace...
      </p>

      <div id="recoveryForm" style="display: none">
        <div class="password-wrapper">
          <input
            type="password"
            id="recoveryPass"
            placeholder="Nueva contrase√±a (m√≠n 6)"
          />
          <span
            class="toggle-eye"
            onclick="togglePassword('recoveryPass', this)"
            >üëÅÔ∏è</span
          >
        </div>
        <button
          id="btnFinalizeRecovery"
          class="btn-main"
          onclick="finalizeRecovery()"
        >
          Guardar Nueva Contrase√±a
        </button>
      </div>
    </div>

    <div id="auth-screen" class="animate-pop">
      <h1 style="text-align: center; color: var(--primary); margin-bottom: 5px">
        NailsByNINA
      </h1>
      <p
        style="
          text-align: center;
          color: #aaa;
          font-size: 0.9rem;
          margin-bottom: 30px;
        "
      >
        Agenda tu momento de brillo ‚ú®
      </p>

      <div id="login-form">
        <input type="email" id="loginEmail" placeholder="Tu Correo" />

        <div class="password-wrapper">
          <input type="password" id="loginPass" placeholder="Contrase√±a" />
          <span class="toggle-eye" onclick="togglePassword('loginPass', this)"
            >üëÅÔ∏è</span
          >
        </div>

        <button class="btn-main" onclick="handleAuth('login')">
          Ingresar üíñ
        </button>
        <p style="text-align: center; margin-top: 15px">
          <a
            href="#"
            onclick="openResetModal()"
            style="
              color: var(--info);
              font-size: 0.85rem;
              text-decoration: none;
            "
            >¬øOlvidaste tu contrase√±a?</a
          >
        </p>
        <p
          style="
            text-align: center;
            font-size: 0.85rem;
            margin-top: 25px;
            color: #888;
          "
        >
          ¬øPrimera vez?
          <a
            href="#"
            onclick="toggleAuth(false)"
            style="
              color: var(--primary);
              font-weight: bold;
              text-decoration: none;
            "
            >Crear cuenta</a
          >
        </p>
      </div>

      <div id="signup-form" style="display: none">
        <input type="text" id="regNombre" placeholder="Tu Nombre Completo" />
        <input type="email" id="regEmail" placeholder="Tu Correo" />

        <div class="password-wrapper">
          <input
            type="password"
            id="regPass"
            placeholder="Contrase√±a (m√≠n 6)"
          />
          <span class="toggle-eye" onclick="togglePassword('regPass', this)"
            >üëÅÔ∏è</span
          >
        </div>

        <div class="password-wrapper">
          <input
            type="password"
            id="regPassConfirm"
            placeholder="Confirmar Contrase√±a"
          />
          <span
            class="toggle-eye"
            onclick="togglePassword('regPassConfirm', this)"
            >üëÅÔ∏è</span
          >
        </div>

        <button class="btn-main" onclick="handleAuth('signup')">
          Registrarme ‚ú®
        </button>
        <p
          style="
            text-align: center;
            font-size: 0.85rem;
            margin-top: 25px;
            color: #888;
          "
        >
          <a
            href="#"
            onclick="toggleAuth(true)"
            style="
              color: var(--primary);
              font-weight: bold;
              text-decoration: none;
            "
            >Ya tengo cuenta</a
          >
        </p>
      </div>
    </div>

    <div id="app-screen" class="animate-pop">
      <div class="nav-header">
        <span style="font-size: 1.1rem; font-weight: bold">
          NailsByNINA
          <span
            id="adminBadge"
            style="
              display: none;
              font-size: 0.6rem;
              background: var(--text);
              color: white;
              padding: 2px 5px;
              border-radius: 4px;
              vertical-align: middle;
              margin-left: 5px;
            "
            >ADMIN</span
          >
        </span>
        <div style="display: flex; align-items: center; gap: 10px">
          <span
            id="displayUserName"
            style="font-size: 0.85rem; color: #888"
          ></span>
        </div>
      </div>

      <div id="editModeBar">
        <span>üîÑ REPROGRAMANDO CITA</span>
        <button
          onclick="cancelRescheduleMode()"
          style="
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 5px 10px;
            border-radius: 8px;
            cursor: pointer;
          "
        >
          Cancelar
        </button>
      </div>

      <div class="tabs">
        <button
          id="tab-agenda"
          class="tab-btn active"
          onclick="showTab('agenda')"
        >
          Agendar
        </button>
        <button id="tab-lista" class="tab-btn" onclick="showTab('lista')">
          Mis Citas
        </button>
        <button
          id="tab-config"
          class="tab-btn"
          onclick="showTab('config')"
          style="display: none"
        >
          Admin
        </button>
        <button id="tab-perfil" class="tab-btn" onclick="showTab('perfil')">
          Perfil
        </button>
      </div>

      <div id="view-agenda" class="main-grid animate-pop">
        <div>
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: 15px;
            "
          >
            <button
              onclick="moveMonth(-1)"
              style="
                border: none;
                background: white;
                width: 35px;
                height: 35px;
                border-radius: 50%;
                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
                color: var(--primary);
                font-weight: bold;
                cursor: pointer;
              "
            >
              ‚óÄ
            </button>
            <b
              id="monthDisplay"
              style="
                color: var(--text);
                font-size: 1.1rem;
                text-transform: capitalize;
              "
            ></b>
            <button
              onclick="moveMonth(1)"
              style="
                border: none;
                background: white;
                width: 35px;
                height: 35px;
                border-radius: 50%;
                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
                color: var(--primary);
                font-weight: bold;
                cursor: pointer;
              "
            >
              ‚ñ∂
            </button>
          </div>
          <div class="cal-grid" id="calendarGrid"></div>
        </div>
        <div class="form-section">
          <h3 style="margin: 0 0 15px 0; color: var(--primary)">
            Detalles de la Cita
          </h3>
          <div id="newAppointmentFields">
            <input
              type="text"
              id="fieldNombre"
              placeholder="Nombre de quien asiste"
            />
            <input
              type="email"
              id="fieldCorreo"
              placeholder="Correo electr√≥nico"
            />
            <input
              type="tel"
              id="fieldTelefono"
              placeholder="WhatsApp (Sin espacios)"
              pattern="[0-9]*"
              oninput="this.value = this.value.replace(/[^0-9]/g, '')"
            />

            <label
              style="
                font-size: 0.8rem;
                color: #888;
                margin-left: 5px;
                margin-top: 5px;
                display: block;
              "
              >Servicio deseado:</label
            >
            <select id="fieldServicio">
              <option>Cargando servicios...</option>
            </select>
          </div>
          <label
            style="
              font-size: 0.8rem;
              color: #888;
              margin-left: 5px;
              margin-top: 10px;
              display: block;
            "
            >Hora de la cita:</label
          >
          <select id="fieldHora">
            <option value="">Selecciona un d√≠a primero</option>
          </select>
          <div id="fileUploadDiv" class="file-upload-wrapper">
            <input
              type="file"
              id="fieldFile"
              accept="image/*"
              hidden
              onchange="updateFileName()"
            />
            <label for="fieldFile" class="custom-file-upload"
              >üì∏ Subir Comprobante</label
            >
            <span id="fileNameDisplay">Ning√∫n archivo seleccionado</span>
          </div>
          <button id="btnMainAction" class="btn-main" onclick="confirmarCita()">
            üíñ Reservar Cita
          </button>
        </div>
      </div>

      <div
        id="view-lista"
        style="display: none; padding: 20px"
        class="animate-pop"
      >
        <h3 style="color: var(--primary); margin-bottom: 20px">
          Tus Citas Programadas
        </h3>
        <div id="tablaCitasContainer"></div>
      </div>

      <div
        id="view-config"
        class="admin-control-panel animate-pop"
        style="display: none"
      >
        <h3 style="color: var(--primary); margin-top: 0">
          Gesti√≥n de Servicios
        </h3>
        <div
          style="
            background: #fdfdfd;
            padding: 15px;
            border-radius: 15px;
            border: 1px dashed var(--primary);
            margin-bottom: 30px;
          "
        >
          <div id="adminServicesList"></div>
          <div class="add-row">
            <input
              type="text"
              id="newServiceInput"
              placeholder="Nombre del nuevo servicio..."
            />
            <button
              class="btn-main"
              style="background: var(--success)"
              onclick="addService()"
            >
              <span style="font-size: 1.5rem; line-height: 1">+</span>
            </button>
          </div>
        </div>
        <h3 style="text-align: center; color: var(--primary)">
          Horario Semanal
        </h3>
        <div
          style="
            display: flex;
            justify-content: center;
            gap: 5px;
            margin-bottom: 20px;
          "
        >
          <div class="day-chip" id="d1" onclick="toggleWeekDay(1)">Lu</div>
          <div class="day-chip" id="d2" onclick="toggleWeekDay(2)">Ma</div>
          <div class="day-chip" id="d3" onclick="toggleWeekDay(3)">Mi</div>
          <div class="day-chip" id="d4" onclick="toggleWeekDay(4)">Ju</div>
          <div class="day-chip" id="d5" onclick="toggleWeekDay(5)">Vi</div>
          <div class="day-chip" id="d6" onclick="toggleWeekDay(6)">Sa</div>
          <div class="day-chip" id="d0" onclick="toggleWeekDay(0)">Do</div>
        </div>
        <div
          id="hoursEditor"
          style="
            display: none;
            background: #fffbfd;
            padding: 15px;
            border-radius: 15px;
            border: 1px dashed var(--primary);
          "
        >
          <div id="weeklyHours" style="margin-bottom: 10px"></div>
          <div class="add-row">
            <input type="time" id="newHourInput" />
            <button class="btn-main" onclick="addStagedHour()">+</button>
          </div>
          <button
            class="btn-main"
            style="background: var(--whatsapp); margin-top: 10px"
            onclick="saveWeekSchedule()"
          >
            Guardar Horario
          </button>
        </div>
        <hr style="border: 0; border-top: 1px solid #eee; margin: 30px 0" />
        <h3 style="text-align: center; color: var(--primary)">
          Bloquear Fecha
        </h3>
        <input
          type="date"
          id="adminDateInput"
          onchange="loadAdminDayConfig()"
        />
        <div id="adminPanelControls" style="display: none; margin-top: 15px">
          <button
            id="btnToggleDay"
            onclick="toggleFullDayBlock()"
            class="btn-main"
            style="background: #888"
          >
            CERRAR D√çA COMPLETO
          </button>
          <div
            id="adminHourGrid"
            style="
              display: grid;
              grid-template-columns: repeat(3, 1fr);
              gap: 8px;
              margin-top: 15px;
            "
          ></div>
        </div>
      </div>

      <div
        id="view-perfil"
        style="display: none; padding: 25px"
        class="animate-pop"
      >
        <h3 style="color: var(--primary); text-align: center">Mi Perfil</h3>
        <div
          style="
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
          "
        >
          <h4 style="margin-top: 0">Datos Personales</h4>
          <label style="font-size: 0.8rem; color: #888"
            >Nombre para mostrar:</label
          >
          <input type="text" id="profileName" />
          <button
            class="btn-main"
            style="margin-top: 10px; padding: 12px"
            onclick="updateProfileName()"
          >
            Guardar Nombre
          </button>
        </div>

        <button
          class="btn-main"
          style="
            background: white;
            border: 2px dashed var(--primary);
            color: var(--primary);
            margin-bottom: 20px;
          "
          onclick="togglePassForm()"
        >
          üîí Cambiar Contrase√±a
        </button>

        <div
          id="profilePassForm"
          style="
            display: none;
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
          "
        >
          <h4 style="margin-top: 0">Cambiar Contrase√±a</h4>

          <div class="password-wrapper">
            <input
              type="password"
              id="currentPassProfile"
              placeholder="Contrase√±a Actual"
            />
            <span
              class="toggle-eye"
              onclick="togglePassword('currentPassProfile', this)"
              >üëÅÔ∏è</span
            >
          </div>

          <div class="password-wrapper">
            <input
              type="password"
              id="newPassProfile"
              placeholder="Nueva Contrase√±a (m√≠n 6)"
            />
            <span
              class="toggle-eye"
              onclick="togglePassword('newPassProfile', this)"
              >üëÅÔ∏è</span
            >
          </div>

          <div class="password-wrapper">
            <input
              type="password"
              id="confirmPassProfile"
              placeholder="Confirmar Nueva Contrase√±a"
            />
            <span
              class="toggle-eye"
              onclick="togglePassword('confirmPassProfile', this)"
              >üëÅÔ∏è</span
            >
          </div>

          <button
            class="btn-main"
            style="margin-top: 10px; padding: 12px; background: var(--info)"
            onclick="updatePassword()"
          >
            Actualizar Contrase√±a
          </button>
        </div>

        <button
          onclick="logout()"
          style="
            width: 100%;
            padding: 15px;
            border: 1px solid var(--danger);
            background: white;
            color: var(--danger);
            border-radius: 15px;
            font-weight: bold;
            cursor: pointer;
          "
        >
          Cerrar Sesi√≥n
        </button>
      </div>
    </div>

    <script>
      // CONFIG
      const sbUrl = "https://jifwtgpchbipxyriirtq.supabase.co";
      const sbKey = "sb_publishable_zF5mj6Ba61zibU_19vnFPQ_a4GDaKwi";
      const client = supabase.createClient(sbUrl, sbKey);
      const miWhatsAppAdmin = "573228211246";

      let userProfile = null;
      let currentUserEmail = "";
      let globalSchedule = {};
      let globalServices = [];
      let selectedWeekDays = [],
        stagedHours = [];
      let viewDate = new Date();
      let selectedDate = null;
      let lastCitaData = null;
      let isRescheduling = false;
      let rescheduleId = null;
      let rescheduleData = null;
      let pendingCancelId = null;
      let pendingCancelData = null;

      // --- INICIALIZACI√ìN INTELIGENTE ---
      function initApp() {
        const hash = window.location.hash;
        if (hash && hash.includes("type=recovery")) {
          // MODO RECUPERACI√ìN DETECTADO
          document.getElementById("auth-screen").style.display = "none";
          document.getElementById("app-screen").style.display = "none";
          document.getElementById("recovery-screen").style.display = "block";

          // Esperamos a que Supabase procese el hash y nos loguee autom√°ticamente
          waitForSession();
        } else {
          checkUser();
        }
      }

      // --- ESPERAR SESI√ìN (FIX para "Session Missing") ---
      async function waitForSession() {
        // Intentamos obtener la sesi√≥n varias veces hasta que Supabase la establezca
        let attempts = 0;
        const maxAttempts = 10;

        const interval = setInterval(async () => {
          attempts++;
          const {
            data: { session },
          } = await client.auth.getSession();

          if (session) {
            clearInterval(interval);
            document.getElementById("recoveryStatus").innerText =
              "Enlace verificado. Ingresa tu nueva clave.";
            document.getElementById("recoveryStatus").style.color =
              "var(--success)";
            document.getElementById("recoveryForm").style.display = "block";
          } else if (attempts >= maxAttempts) {
            clearInterval(interval);
            document.getElementById("recoveryStatus").innerText =
              "El enlace ha expirado o es inv√°lido.";
            document.getElementById("recoveryStatus").style.color =
              "var(--danger)";
          }
        }, 500); // Revisar cada medio segundo
      }

      // --- MOSTRAR/OCULTAR CONTRASE√ëA ---
      function togglePassword(inputId, icon) {
        const input = document.getElementById(inputId);
        if (input.type === "password") {
          input.type = "text";
          icon.innerText = "üôà";
        } else {
          input.type = "password";
          icon.innerText = "üëÅÔ∏è";
        }
      }

      function togglePassForm() {
        const form = document.getElementById("profilePassForm");
        form.style.display = form.style.display === "none" ? "block" : "none";
      }

      // --- RECUPERACI√ìN ---
      function openResetModal() {
        document.getElementById("resetModal").style.display = "flex";
      }
      async function sendResetEmail() {
        const email = document.getElementById("resetEmailInput").value;
        if (!email) return showAlert("Error", "Escribe tu correo.");
        const { error } = await client.auth.resetPasswordForEmail(email, {
          redirectTo: window.location.href,
        });
        if (error) showAlert("Error", error.message);
        else {
          closeModal("resetModal");
          showAlert(
            "Enviado",
            "Revisa tu correo. Sigue el enlace para cambiar tu clave.",
          );
        }
      }

      async function finalizeRecovery() {
        const newPass = document.getElementById("recoveryPass").value;
        if (!newPass || newPass.length < 6)
          return showAlert(
            "Error",
            "La contrase√±a debe tener al menos 6 caracteres",
          );

        // La sesi√≥n ya deber√≠a estar activa gracias a waitForSession
        const { error } = await client.auth.updateUser({ password: newPass });
        if (error) {
          showAlert(
            "Error",
            "No se pudo actualizar. Intenta solicitar el correo de nuevo.",
          );
        } else {
          showAlert("¬°√âxito!", "Contrase√±a restablecida. Ingresando...");
          document.getElementById("recovery-screen").style.display = "none";
          history.replaceState(null, null, " "); // Limpiar URL
          checkUser();
        }
      }

      // --- SWIPE ---
      let touchStartX = 0,
        touchStartY = 0,
        touchEndX = 0,
        touchEndY = 0;
      const appScreen = document.getElementById("app-screen");
      appScreen.addEventListener("touchstart", (e) => {
        touchStartX = e.changedTouches[0].screenX;
        touchStartY = e.changedTouches[0].screenY;
      });
      appScreen.addEventListener("touchend", (e) => {
        touchEndX = e.changedTouches[0].screenX;
        touchEndY = e.changedTouches[0].screenY;
        handleSwipe();
      });

      function handleSwipe() {
        const threshold = 100;
        const restraint = 80;
        const diffX = touchEndX - touchStartX;
        const diffY = touchEndY - touchStartY;
        if (Math.abs(diffX) > threshold && Math.abs(diffY) < restraint) {
          const tabs = ["agenda", "lista"];
          if (userProfile && userProfile.role === "admin") tabs.push("config");
          tabs.push("perfil");

          let activeIdx = 0;
          if (document.getElementById("view-lista").style.display !== "none")
            activeIdx = 1;
          if (document.getElementById("view-config").style.display !== "none")
            activeIdx = 2;
          if (document.getElementById("view-perfil").style.display !== "none")
            activeIdx = tabs.indexOf("config") > -1 ? 3 : 2;

          if (diffX < 0) {
            if (activeIdx < tabs.length - 1) showTab(tabs[activeIdx + 1]);
          } else {
            if (activeIdx > 0) showTab(tabs[activeIdx - 1]);
          }
        }
      }

      function format12h(h24) {
        if (!h24) return "";
        let [h, m] = h24.split(":");
        let suf = h >= 12 ? "PM" : "AM";
        h = h % 12 || 12;
        return `${h}:${m} ${suf}`;
      }

      function updateFileName() {
        const input = document.getElementById("fieldFile");
        const display = document.getElementById("fileNameDisplay");
        if (input.files && input.files[0]) {
          display.innerText = "Archivo: " + input.files[0].name;
          display.style.color = "var(--primary)";
        } else {
          display.innerText = "Ning√∫n archivo seleccionado";
          display.style.color = "#888";
        }
      }

      function showAlert(t, m, i = "‚ú®") {
        document.getElementById("genIcon").innerText = i;
        document.getElementById("genTitle").innerText = t;
        document.getElementById("genMsg").innerText = m;
        document.getElementById("generalModal").style.display = "flex";
      }
      function closeModal(id) {
        document.getElementById(id).style.display = "none";
      }
      function toggleAuth(l) {
        document.getElementById("login-form").style.display = l
          ? "block"
          : "none";
        document.getElementById("signup-form").style.display = l
          ? "none"
          : "block";
      }

      async function handleAuth(type) {
        const email = document.getElementById(
          type === "login" ? "loginEmail" : "regEmail",
        ).value;
        const pass = document.getElementById(
          type === "login" ? "loginPass" : "regPass",
        ).value;

        if (type === "signup") {
          const confirm = document.getElementById("regPassConfirm").value;
          if (pass !== confirm)
            return showAlert("Error", "Las contrase√±as no coinciden", "üö´");

          const { error } = await client.auth.signUp({
            email,
            password: pass,
            options: {
              data: { full_name: document.getElementById("regNombre").value },
            },
          });
          if (error) showAlert("Ups", error.message, "üßê");
          else
            showAlert(
              "¬°Bienvenida!",
              "Cuenta creada. Por favor inicia sesi√≥n.",
              "üíñ",
            );
        } else {
          const { error } = await client.auth.signInWithPassword({
            email,
            password: pass,
          });
          if (error) showAlert("Error", "Datos incorrectos.", "üö´");
          else checkUser();
        }
      }

      async function checkUser() {
        if (
          document.getElementById("recovery-screen").style.display === "block"
        )
          return;

        const {
          data: { session },
        } = await client.auth.getSession();
        if (session) {
          const { data } = await client
            .from("profiles")
            .select("*")
            .eq("id", session.user.id)
            .single();
          if (!data) return setTimeout(checkUser, 500);

          userProfile = data;
          currentUserEmail = session.user.email;
          document.getElementById("auth-screen").style.display = "none";
          document.getElementById("app-screen").style.display = "block";
          document.getElementById("displayUserName").innerText = data.full_name;
          document.getElementById("profileName").value = data.full_name;

          document.getElementById("fieldNombre").value = data.full_name;
          document.getElementById("fieldCorreo").value = session.user.email;

          await fetchServices();
          await fetchSchedule();

          if (data.role === "admin") {
            document.getElementById("adminBadge").style.display =
              "inline-block";
            document.getElementById("tab-config").style.display = "block";
            document.getElementById("fieldNombre").readOnly = false;
            document.getElementById("fieldCorreo").readOnly = false;
          } else {
            document.getElementById("fieldNombre").readOnly = true;
            document.getElementById("fieldCorreo").readOnly = true;
          }
          renderCalendar();
        } else {
          if (
            document.getElementById("recovery-screen").style.display !== "block"
          ) {
            document.getElementById("auth-screen").style.display = "block";
          }
        }
      }

      async function fetchServices() {
        const { data, error } = await client
          .from("servicios")
          .select("*")
          .order("id");
        if (data) {
          globalServices = data;
          renderServicesDropdown();
          if (userProfile && userProfile.role === "admin")
            renderAdminServicesList();
        }
      }

      function renderServicesDropdown() {
        const sel = document.getElementById("fieldServicio");
        sel.innerHTML = "";
        globalServices.forEach((s) => {
          const opt = document.createElement("option");
          opt.value = s.nombre;
          opt.text = s.nombre;
          sel.appendChild(opt);
        });
      }

      function renderAdminServicesList() {
        const list = document.getElementById("adminServicesList");
        list.innerHTML = "";
        globalServices.forEach((s) => {
          list.innerHTML += `<div class="service-item"><span>${s.nombre}</span><button class="btn-delete-svc" onclick="deleteService(${s.id})">Borrar</button></div>`;
        });
      }

      async function addService() {
        const input = document.getElementById("newServiceInput");
        const val = input.value.trim();
        if (!val) return;
        const { error } = await client
          .from("servicios")
          .insert([{ nombre: val }]);
        if (error) showAlert("Error", error.message);
        else {
          input.value = "";
          await fetchServices();
        }
      }

      async function deleteService(id) {
        if (!confirm("¬øSeguro que quieres borrar este servicio?")) return;
        const { error } = await client.from("servicios").delete().eq("id", id);
        if (error) showAlert("Error", error.message);
        else await fetchServices();
      }

      async function updateProfileName() {
        const newName = document.getElementById("profileName").value;
        if (!newName)
          return showAlert("Error", "El nombre no puede estar vac√≠o");
        const { error } = await client
          .from("profiles")
          .update({ full_name: newName })
          .eq("id", userProfile.id);
        if (error) showAlert("Error", error.message);
        else {
          userProfile.full_name = newName;
          document.getElementById("displayUserName").innerText = newName;
          document.getElementById("fieldNombre").value = newName;
          showAlert("√âxito", "Nombre actualizado correctamente.");
        }
      }

      // --- ACTUALIZAR CONTRASE√ëA (PERFIL) ---
      async function updatePassword() {
        const currentPass = document.getElementById("currentPassProfile").value;
        const newPass = document.getElementById("newPassProfile").value;
        const confirmPass = document.getElementById("confirmPassProfile").value;

        if (!currentPass || !newPass || !confirmPass)
          return showAlert("Faltan datos", "Llena todos los campos");
        if (newPass !== confirmPass)
          return showAlert("Error", "Las nuevas contrase√±as no coinciden");
        if (newPass.length < 6)
          return showAlert(
            "Error",
            "La contrase√±a debe tener m√≠nimo 6 caracteres",
          );

        const { error: signInError } = await client.auth.signInWithPassword({
          email: currentUserEmail,
          password: currentPass,
        });

        if (signInError) {
          return showAlert("Error", "Tu contrase√±a actual es incorrecta.");
        }

        const { error } = await client.auth.updateUser({ password: newPass });
        if (error) showAlert("Error", error.message);
        else {
          document.getElementById("currentPassProfile").value = "";
          document.getElementById("newPassProfile").value = "";
          document.getElementById("confirmPassProfile").value = "";
          togglePassForm();
          showAlert("√âxito", "Contrase√±a actualizada correctamente.");
        }
      }

      function startReschedule(id, fecha, hora, servicio, nombre, tel) {
        isRescheduling = true;
        rescheduleId = id;
        rescheduleData = { fecha, hora, servicio, nombre, tel };
        document.getElementById("editModeBar").style.display = "flex";
        document.getElementById("newAppointmentFields").style.display = "none";
        document.getElementById("fileUploadDiv").style.display = "none";
        const btn = document.getElementById("btnMainAction");
        btn.innerText = "Confirmar Nueva Fecha üîÑ";
        btn.className = "btn-main reschedule-mode";
        showTab("agenda");
        showAlert("Reprogramaci√≥n", "Selecciona el NUEVO d√≠a y hora.", "üóìÔ∏è");
      }

      function cancelRescheduleMode() {
        isRescheduling = false;
        rescheduleId = null;
        rescheduleData = null;
        document.getElementById("editModeBar").style.display = "none";
        document.getElementById("newAppointmentFields").style.display = "block";
        document.getElementById("fileUploadDiv").style.display = "block";
        const btn = document.getElementById("btnMainAction");
        btn.innerText = "üíñ Reservar Cita";
        btn.className = "btn-main";
      }

      async function confirmarCita() {
        if (!selectedDate)
          return showAlert("Falta Fecha", "Selecciona un d√≠a.");
        const hora = document.getElementById("fieldHora").value;
        if (!hora) return showAlert("Falta Hora", "Selecciona una hora.");

        if (isRescheduling) {
          try {
            const { error } = await client
              .from("citas")
              .update({
                fecha: selectedDate,
                hora: hora,
                estado: "reprogramada",
              })
              .eq("id", rescheduleId);
            if (error) throw error;
            lastCitaData = {
              ...rescheduleData,
              fecha: selectedDate,
              hora: hora,
            };
            document.getElementById("wspRescheduleModal").style.display =
              "flex";
            cancelRescheduleMode();
            loadAllAppointments();
          } catch (err) {
            showAlert("Error", err.message, "üö´");
          }
        } else {
          const tel = document.getElementById("fieldTelefono").value;
          const file = document.getElementById("fieldFile").files[0];
          if (!tel)
            return showAlert("Faltan Datos", "El tel√©fono es obligatorio.");
          if (!file)
            return showAlert("Falta Comprobante", "Sube la foto del pago.");

          const datos = {
            fecha: selectedDate,
            hora,
            nombre: document.getElementById("fieldNombre").value,
            correo: document.getElementById("fieldCorreo").value,
            telefono: tel,
            servicio: document.getElementById("fieldServicio").value,
            user_id: userProfile.id,
            estado: "pendiente",
          };
          const { error } = await client.from("citas").insert([datos]);
          if (error) showAlert("Error", error.message);
          else {
            lastCitaData = datos;
            document.getElementById("wspModal").style.display = "flex";
          }
        }
      }

      function enviarWhatsAppCliente() {
        const msg =
          `Hola NailsByNINA. Soy ${lastCitaData.nombre}.\n` +
          `Cita: ${lastCitaData.fecha} a las ${format12h(lastCitaData.hora)}\n` +
          `Servicio: ${lastCitaData.servicio}\n` +
          `Adjunto mi comprobante para confirmar. Gracias.`;
        window.open(
          `https://wa.me/${miWhatsAppAdmin}?text=${encodeURIComponent(msg)}`,
          "_blank",
        );
        closeModal("wspModal");
        showTab("lista");
      }

      function enviarWhatsAppReprogramacion() {
        const msg =
          `Hola NailsByNINA. Soy ${lastCitaData.nombre}.\nHe reprogramado mi cita.\n` +
          `Nueva Fecha: ${lastCitaData.fecha}\nNueva Hora: ${format12h(lastCitaData.hora)}\nQuedo atenta a la confirmacion.`;
        window.open(
          `https://wa.me/${miWhatsAppAdmin}?text=${encodeURIComponent(msg)}`,
          "_blank",
        );
        closeModal("wspRescheduleModal");
        showTab("lista");
      }

      function openCancelModal(id, tel, name, isClient) {
        pendingCancelId = id;
        pendingCancelData = { tel, name, isClient };
        document.getElementById("cancelModal").style.display = "flex";
      }

      async function confirmCancelation() {
        if (!pendingCancelId) return;
        const { error } = await client
          .from("citas")
          .delete()
          .eq("id", pendingCancelId);
        if (error) showAlert("Error", error.message);
        else {
          let msg = "";
          let num = "";
          if (pendingCancelData.isClient) {
            msg = `Hola NailsByNINA. Debo cancelar mi cita a nombre de ${pendingCancelData.name}. Disculpa las molestias.`;
            num = miWhatsAppAdmin;
          } else {
            msg = `Hola ${pendingCancelData.name}, te escribimos de NailsByNINA. Lamentamos informarte que hemos cancelado tu cita. Por favor cont√°ctanos.`;
            num = pendingCancelData.tel;
          }
          window.open(
            `https://wa.me/${num}?text=${encodeURIComponent(msg)}`,
            "_blank",
          );
          loadAllAppointments();
          closeModal("cancelModal");
        }
      }

      async function logout() {
        await client.auth.signOut();
        window.location.reload();
      }

      async function loadAllAppointments() {
        let q = client.from("citas").select("*");
        if (userProfile.role !== "admin") q = q.eq("user_id", userProfile.id);
        const { data } = await q.order("fecha").order("hora");
        const container = document.getElementById("tablaCitasContainer");
        container.innerHTML = "";
        if (!data || data.length === 0) {
          container.innerHTML =
            "<p style='text-align:center; color:#aaa; margin-top:30px;'>No tienes citas agendadas.</p>";
          return;
        }
        const hoy = new Date().toISOString().split("T")[0];
        data.forEach((c) => {
          const safeName = c.nombre.replace(/'/g, "");
          const isReprogramada = c.estado === "reprogramada";
          const badge = isReprogramada
            ? `<div class="status-pill repro">Reprogramada</div>`
            : `<div class="status-pill" style="background:#e6fffa; color:#00b894; border:1px solid #00b894;">Confirmada</div>`;
          const cardClass = isReprogramada
            ? "appointment-card reprogramada animate-pop"
            : "appointment-card animate-pop";
          let buttonsHtml = "";
          if (userProfile.role === "admin") {
            buttonsHtml = `<div class="actions-row"><button class="btn-action btn-reschedule" style="background:var(--whatsapp); color:white;" onclick="window.open('https://wa.me/${c.telefono}?text=Hola%20${c.nombre},%20recordatorio%20de%20tu%20cita%20en%20NailsByNINA')">Recordar</button><button class="btn-action btn-cancel" onclick="openCancelModal('${c.id}', '${c.telefono}', '${safeName}', false)">Cancelar</button></div>`;
          } else {
            if (c.fecha >= hoy) {
              buttonsHtml = `<div class="actions-row"><button class="btn-action btn-reschedule" onclick="startReschedule('${c.id}', '${c.fecha}', '${c.hora}', '${c.servicio}', '${safeName}', '${c.telefono}')">Reprogramar</button><button class="btn-action btn-cancel" onclick="openCancelModal('${c.id}', '${c.telefono}', '${safeName}', true)">Cancelar</button></div>`;
            }
          }
          container.innerHTML += `<div class="${cardClass}">${badge}<div style="font-size:1.1rem; font-weight:bold; color:var(--text);">${c.servicio}</div><div style="color:var(--primary); font-weight:bold; margin:5px 0;">${format12h(c.hora)} - ${c.fecha}</div><div style="font-size:0.9rem; color:#888;">${c.nombre}</div>${userProfile.role === "admin" ? `<div style="background:#f9f9f9; padding:8px; border-radius:8px; margin-top:8px; font-size:0.8rem;">üì± ${c.telefono}<br>üìß ${c.correo}</div>` : ""}${buttonsHtml}</div>`;
        });
      }

      async function fetchSchedule() {
        const { data } = await client.from("horarios_base").select("*");
        if (data) data.forEach((i) => (globalSchedule[i.dia] = i.horas));
      }

      function renderCalendar() {
        const grid = document.getElementById("calendarGrid");
        grid.innerHTML = "";
        ["Do", "Lu", "Ma", "Mi", "Ju", "Vi", "Sa"].forEach(
          (d) =>
            (grid.innerHTML += `<div style="font-size:0.8rem; text-align:center; color:var(--primary); font-weight:bold;">${d}</div>`),
        );
        const year = viewDate.getFullYear(),
          month = viewDate.getMonth();
        document.getElementById("monthDisplay").innerText = new Date(
          year,
          month,
          1,
        ).toLocaleString("es-ES", { month: "long", year: "numeric" });
        const firstDay = new Date(year, month, 1).getDay();
        const lastDate = new Date(year, month + 1, 0).getDate();
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        for (let i = 0; i < firstDay; i++) grid.innerHTML += `<div></div>`;
        for (let i = 1; i <= lastDate; i++) {
          const d = document.createElement("div");
          const dStr = `${year}-${String(month + 1).padStart(2, "0")}-${String(i).padStart(2, "0")}`;
          const cDate = new Date(dStr + "T00:00:00");
          d.className = "day";
          d.innerText = i;
          d.id = `day-${dStr}`;
          if (cDate < today) d.classList.add("disabled");
          else {
            if (cDate.getTime() === today.getTime()) d.classList.add("today");
            d.onclick = () => {
              if (d.classList.contains("full"))
                return showAlert(
                  "Lo sentimos",
                  "No prestamos servicio este d√≠a.",
                );
              document
                .querySelectorAll(".day")
                .forEach((e) => e.classList.remove("selected"));
              d.classList.add("selected");
              selectedDate = dStr;
              checkHoras(dStr);
            };
          }
          grid.appendChild(d);
        }
        updateFullDays(year, month, lastDate);
      }

      async function updateFullDays(y, m, last) {
        const start = `${y}-${String(m + 1).padStart(2, "0")}-01`;
        const end = `${y}-${String(m + 1).padStart(2, "0")}-${last}`;
        const { data: citas } = await client
          .from("citas")
          .select("fecha,hora")
          .gte("fecha", start)
          .lte("fecha", end);
        const { data: bloq } = await client
          .from("bloqueos")
          .select("fecha,hora")
          .gte("fecha", start)
          .lte("fecha", end);
        for (let i = 1; i <= last; i++) {
          const dStr = `${y}-${String(m + 1).padStart(2, "0")}-${String(i).padStart(2, "0")}`;
          const el = document.getElementById(`day-${dStr}`);
          if (!el || el.classList.contains("disabled")) continue;
          const dayW = new Date(dStr + "T00:00:00").getDay();
          const base = globalSchedule[dayW] || [];
          const dayBloq = bloq.some((b) => b.fecha === dStr && b.hora === null);
          if (dayBloq || base.length === 0) {
            el.classList.add("full");
            continue;
          }
          const taken = [
            ...citas.filter((c) => c.fecha === dStr).map((c) => c.hora),
            ...bloq
              .filter((b) => b.fecha === dStr && b.hora)
              .map((b) => b.hora),
          ];
          const avail = base.filter((h) => !taken.includes(h));
          if (avail.length === 0) el.classList.add("full");
        }
      }

      async function checkHoras(fecha) {
        const dayW = new Date(fecha + "T00:00:00").getDay();
        let base = globalSchedule[dayW] ? [...globalSchedule[dayW]].sort() : [];
        const { data: citas } = await client
          .from("citas")
          .select("hora")
          .eq("fecha", fecha);
        const { data: bloq } = await client
          .from("bloqueos")
          .select("hora")
          .eq("fecha", fecha);
        const taken = [...citas.map((c) => c.hora), ...bloq.map((b) => b.hora)];
        const isDayBloq = bloq.some((b) => b.hora === null);
        const sel = document.getElementById("fieldHora");
        sel.innerHTML = "";
        if (base.length === 0 || isDayBloq) {
          sel.add(new Option("No prestamos servicio este d√≠a", ""));
          sel.disabled = true;
          return;
        }
        sel.disabled = false;
        let any = false;
        sel.add(new Option("Selecciona una hora...", ""));
        base.forEach((h) => {
          const opt = document.createElement("option");
          opt.value = h;
          if (taken.includes(h)) {
            opt.disabled = true;
            opt.text = format12h(h) + " - No disponible";
          } else {
            opt.text = format12h(h);
            any = true;
          }
          sel.appendChild(opt);
        });
        if (!any) {
          sel.innerHTML = "";
          sel.add(new Option("Agenda llena hoy", ""));
          sel.disabled = true;
        }
      }

      function moveMonth(v) {
        viewDate.setMonth(viewDate.getMonth() + v);
        renderCalendar();
      }

      function showTab(t) {
        // Orden de ocultar
        ["agenda", "lista", "perfil", "config"].forEach((x) => {
          document.getElementById(`view-${x}`).style.display = "none";
          document.getElementById(`tab-${x}`).className = "tab-btn";
        });

        // Mostrar
        document.getElementById(`view-${t}`).style.display =
          t === "agenda"
            ? window.innerWidth > 850
              ? "grid"
              : "block"
            : "block";
        document.getElementById(`tab-${t}`).className = "tab-btn active";

        if (t === "lista") loadAllAppointments();
        if (t !== "agenda" && isRescheduling) cancelRescheduleMode();
      }

      function toggleWeekDay(d) {
        const el = document.getElementById(`d${d}`);
        const idx = selectedWeekDays.indexOf(d);
        if (idx > -1) {
          selectedWeekDays.splice(idx, 1);
          el.classList.remove("active");
        } else {
          if (selectedWeekDays.length === 0) {
            stagedHours = globalSchedule[d] ? [...globalSchedule[d]] : [];
            renderStaged();
          }
          selectedWeekDays.push(d);
          el.classList.add("active");
        }
        document.getElementById("hoursEditor").style.display =
          selectedWeekDays.length ? "block" : "none";
      }
      function renderStaged() {
        const c = document.getElementById("weeklyHours");
        c.innerHTML = "";
        stagedHours.sort().forEach((h) => {
          c.innerHTML += `<span class="hour-tag">${format12h(h)} <span onclick="remStaged('${h}')" style="cursor:pointer; margin-left:5px;">x</span></span>`;
        });
      }
      function addStagedHour() {
        const h = document.getElementById("newHourInput").value;
        if (h && !stagedHours.includes(h)) {
          stagedHours.push(h);
          renderStaged();
        }
      }
      function remStaged(h) {
        stagedHours = stagedHours.filter((x) => x !== h);
        renderStaged();
      }
      async function saveWeekSchedule() {
        for (let d of selectedWeekDays)
          await client
            .from("horarios_base")
            .upsert({ dia: d, horas: stagedHours });
        selectedWeekDays.forEach((d) =>
          document.getElementById(`d${d}`).classList.remove("active"),
        );
        selectedWeekDays = [];
        document.getElementById("hoursEditor").style.display = "none";
        showAlert("√âxito", "Horario actualizado.");
      }

      async function loadAdminDayConfig() {
        const d = document.getElementById("adminDateInput").value;
        if (!d) return;
        adminSelectedDate = d;
        document.getElementById("adminPanelControls").style.display = "block";
        const { data } = await client
          .from("bloqueos")
          .select("*")
          .eq("fecha", d);
        const isFull = data.some((b) => b.hora === null);
        const btn = document.getElementById("btnToggleDay");
        btn.innerText = isFull ? "üîì ABRIR D√çA" : "üîí CERRAR D√çA COMPLETO";
        btn.style.background = isFull ? "var(--whatsapp)" : "var(--danger)";
        const dayW = new Date(d + "T00:00:00").getDay();
        const base = globalSchedule[dayW] || [];
        const grid = document.getElementById("adminHourGrid");
        grid.innerHTML = "";
        base.sort().forEach((h) => {
          const isB = data.some((b) => b.hora === h);
          grid.innerHTML += `<button onclick="toggleBlock('${h}',${isB})" style="padding:10px; border-radius:10px; border:none; background:${isB ? "#ffebee" : "#e8f5e9"}; color:${isB ? "red" : "green"}; font-weight:bold; cursor:pointer;">${format12h(h)} <br> ${isB ? "üö´" : "‚úÖ"}</button>`;
        });
      }
      async function toggleFullDayBlock() {
        const { data } = await client
          .from("bloqueos")
          .select("*")
          .eq("fecha", adminSelectedDate)
          .is("hora", null);
        if (data.length)
          await client.from("bloqueos").delete().eq("id", data[0].id);
        else
          await client
            .from("bloqueos")
            .insert([{ fecha: adminSelectedDate, hora: null }]);
        loadAdminDayConfig();
      }
      async function toggleBlock(h, isB) {
        if (isB)
          await client
            .from("bloqueos")
            .delete()
            .eq("fecha", adminSelectedDate)
            .eq("hora", h);
        else
          await client
            .from("bloqueos")
            .insert([{ fecha: adminSelectedDate, hora: h }]);
        loadAdminDayConfig();
      }

      // EJECUTAR INICIO
      initApp();
    </script>
  </body>
</html>
