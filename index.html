<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>NailsbyNiNa - App</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;800&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --primary: #ff1493;
        --primary-light: #fff0f6;
        --primary-glow: 0 4px 15px rgba(255, 20, 147, 0.3);
        --bg: #f8f9fa;
        --card-bg: #ffffff;
        --text: #2d3436;
        --text-light: #636e72;
        --whatsapp: #00e676;
        --danger: #ff4757;
        --info: #29b6f6;
        --success: #00d2d3;
        --warning: #ffa502;
        --radius: 24px;
        --disabled: #f1f2f6;
      }
      body {
        font-family: "Poppins", sans-serif;
        background: var(--bg);
        margin: 0;
        color: var(--text);
        padding: 20px 15px;
        -webkit-tap-highlight-color: transparent;
        overscroll-behavior-y: none;
      }

      /* ANIMACIONES */
      @keyframes popIn {
        0% {
          opacity: 0;
          transform: scale(0.95);
        }
        100% {
          opacity: 1;
          transform: scale(1);
        }
      }
      @keyframes slideUp {
        0% {
          opacity: 0;
          transform: translateY(20px);
        }
        100% {
          opacity: 1;
          transform: translateY(0);
        }
      }
      @keyframes highlight {
        0% {
          border-color: var(--primary);
          transform: scale(1.02);
        }
        100% {
          border-color: #f0f0f0;
          transform: scale(1);
        }
      }

      .animate-pop {
        animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      }
      .highlight-input {
        animation: highlight 0.5s ease-out;
        border-color: var(--primary) !important;
      }

      /* MODALES */
      .modal-overlay {
        display: none;
        position: fixed;
        z-index: 3000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.85);
        backdrop-filter: blur(8px);
        align-items: center;
        justify-content: center;
      }
      .modal-content {
        background: white;
        padding: 30px;
        border-radius: 30px;
        width: 85%;
        max-width: 350px;
        text-align: center;
        box-shadow: 0 30px 60px -12px rgba(0, 0, 0, 0.1);
        border: 1px solid rgba(0, 0, 0, 0.05);
        animation: popIn 0.3s ease-out;
      }
      .modal-icon {
        font-size: 3.5rem;
        margin-bottom: 10px;
        display: block;
        filter: drop-shadow(0 10px 10px rgba(0, 0, 0, 0.05));
      }
      .modal-btn-row {
        display: flex;
        gap: 10px;
        margin-top: 25px;
      }

      /* BOTONES GENERALES */
      .btn-modal {
        flex: 1;
        padding: 14px;
        border: none;
        border-radius: 16px;
        font-weight: 700;
        cursor: pointer;
        font-size: 0.95rem;
        transition: transform 0.1s;
        font-family: inherit;
      }
      .btn-modal:active {
        transform: scale(0.95);
      }
      .btn-modal.primary {
        background: var(--primary);
        color: white;
        box-shadow: var(--primary-glow);
      }
      .btn-modal.secondary {
        background: #f1f2f6;
        color: #636e72;
      }
      .btn-modal.whatsapp {
        background: var(--whatsapp);
        color: white;
        box-shadow: 0 5px 15px rgba(0, 230, 118, 0.25);
      }
      .btn-modal.danger {
        background: var(--danger);
        color: white;
        box-shadow: 0 5px 15px rgba(255, 71, 87, 0.25);
      }

      /* LAYOUT */
      #auth-screen,
      #app-screen,
      #recovery-screen {
        display: none;
        max-width: 800px;
        margin: 0 auto;
        background: var(--card-bg);
        border-radius: 30px;
        overflow: hidden;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.03);
        min-height: 85vh;
      }
      #auth-screen,
      #recovery-screen {
        display: block;
        max-width: 400px;
        margin-top: 40px;
        padding: 40px 30px;
        min-height: auto;
        border: 2px solid white;
      }
      #recovery-screen {
        display: none;
      }

      /* HEADER & PERFIL */
      .nav-header {
        background: white;
        padding: 20px 25px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid #f1f2f6;
      }
      .brand-title {
        font-size: 1.4rem;
        font-weight: 800;
        display: flex;
        align-items: center;
        gap: 8px;
        color: var(--text);
        letter-spacing: -0.5px;
      }
      .brand-title span {
        color: var(--primary);
      }
      .header-avatar {
        width: 42px;
        height: 42px;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--primary), #ff80bf);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 0.9rem;
        cursor: pointer;
        box-shadow: 0 5px 15px rgba(255, 20, 147, 0.2);
        transition: transform 0.2s;
      }
      .header-avatar:active {
        transform: scale(0.9);
      }

      /* TABS */
      .tabs {
        display: flex;
        background: white;
        padding: 10px;
        border-bottom: 1px solid #f8f9fa;
      }
      .tab-btn {
        flex: 1;
        padding: 12px;
        border: none;
        background: none;
        cursor: pointer;
        font-weight: 600;
        color: #b2bec3;
        position: relative;
        transition: color 0.3s;
        font-family: inherit;
        font-size: 0.95rem;
      }
      .tab-btn.active {
        color: var(--text);
      }
      .tab-btn.active::after {
        content: "";
        position: absolute;
        bottom: 0;
        left: 50%;
        transform: translateX(-50%);
        width: 6px;
        height: 6px;
        background: var(--primary);
        border-radius: 50%;
      }

      /* SUB-TABS */
      .sub-tabs {
        display: flex;
        background: #f1f2f6;
        padding: 5px;
        border-radius: 20px;
        margin-bottom: 25px;
      }
      .sub-tab-btn {
        flex: 1;
        padding: 12px;
        border: none;
        background: transparent;
        color: #636e72;
        font-weight: 600;
        cursor: pointer;
        border-radius: 16px;
        transition: all 0.2s;
        font-family: inherit;
      }
      .sub-tab-btn.active {
        background: white;
        color: var(--primary);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      }

      /* INPUTS */
      input,
      select,
      textarea {
        width: 100%;
        padding: 16px 20px;
        margin: 8px 0;
        border: 2px solid #f1f2f6;
        border-radius: 18px;
        box-sizing: border-box;
        background: #fbfbfb;
        font-size: 1rem;
        color: var(--text);
        font-family: inherit;
        transition: all 0.2s;
        font-weight: 500;
      }
      input:focus,
      select:focus,
      textarea:focus {
        outline: none;
        border-color: var(--primary);
        background: white;
      }
      input:disabled,
      select:disabled {
        background-color: var(--disabled);
        color: #b2bec3;
        border-color: transparent;
        cursor: not-allowed;
      }
      .password-wrapper {
        position: relative;
        width: 100%;
        margin: 8px 0;
      }
      .password-wrapper input {
        margin: 0;
        padding-right: 45px;
      }
      .toggle-eye {
        position: absolute;
        right: 15px;
        top: 50%;
        transform: translateY(-50%);
        cursor: pointer;
        font-size: 1.2rem;
        color: #b2bec3;
        z-index: 10;
      }

      .btn-main {
        background: var(--text);
        color: white;
        border: none;
        padding: 20px;
        width: 100%;
        border-radius: 20px;
        cursor: pointer;
        font-weight: 700;
        font-size: 1.1rem;
        margin-top: 20px;
        transition: transform 0.2s;
        font-family: inherit;
      }
      .btn-main:active {
        transform: scale(0.98);
      }
      .btn-main.reschedule-mode {
        background: var(--info);
        box-shadow: 0 8px 25px rgba(41, 182, 246, 0.3);
      }
      .btn-main:disabled {
        background: #dfe6e9;
        color: #b2bec3;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      /* CITA CARD */
      .appointment-card {
        background: white;
        border: 1px solid #f0f0f0;
        padding: 20px;
        border-radius: 24px;
        margin-bottom: 15px;
        position: relative;
        overflow: hidden;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.02);
        transition: transform 0.2s;
      }
      .appointment-card:active {
        transform: scale(0.98);
      }
      .appointment-card::before {
        content: "";
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 6px;
        background: var(--primary);
      }
      .appointment-card.reprogramada::before {
        background: var(--info);
      }
      .appointment-card.completada::before {
        background: var(--success);
      }
      .appointment-card.vencida::before {
        background: var(--danger);
      }
      .appointment-card.past {
        opacity: 0.6;
        filter: grayscale(1);
      }

      .status-pill {
        display: inline-block;
        font-size: 0.7rem;
        padding: 6px 12px;
        border-radius: 12px;
        background: #f1f2f6;
        color: #636e72;
        margin-bottom: 12px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      .status-pill.repro {
        background: #e1f5fe;
        color: var(--info);
      }
      .status-pill.done {
        background: #e0f2f1;
        color: var(--success);
      }
      .status-pill.late {
        background: #ffebee;
        color: var(--danger);
      }

      .actions-row {
        display: flex;
        gap: 10px;
        margin-top: 15px;
      }
      .btn-action {
        border: none;
        padding: 12px;
        border-radius: 14px;
        cursor: pointer;
        font-weight: 700;
        font-size: 0.85rem;
        flex: 1;
        transition: all 0.2s ease;
        font-family: inherit;
      }
      .btn-reschedule {
        background: #e3f2fd;
        color: var(--info);
      }
      .btn-cancel {
        background: #ffebee;
        color: var(--danger);
      }
      .btn-arrive {
        background: #e0f2f1;
        color: var(--success);
      }
      .btn-notify-late {
        background: var(--danger);
        color: white;
      }

      /* --- ADMIN PREMIUM STYLES --- */

      /* CARD GENERICA ADMIN */
      .admin-card {
        background: white;
        border-radius: 24px;
        padding: 20px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.02);
        border: 1px solid #f5f5f5;
        margin-bottom: 25px;
      }
      .admin-title {
        font-size: 1.1rem;
        color: var(--text);
        font-weight: 700;
        margin: 0 0 15px 0;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      /* LISTA DE ITEMS (SERVICIOS / RECARGOS) */
      .service-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: #fbfbfb;
        padding: 15px;
        border-radius: 18px;
        margin-bottom: 10px;
        border: 1px solid #f1f2f6;
        transition: background 0.2s;
      }
      .service-item:hover {
        background: #fdfdfd;
        border-color: #eee;
      }
      .service-info {
        font-weight: 600;
        color: #2d3436;
        font-size: 0.95rem;
      }

      /* BOTONES FLOTANTES */
      .svc-controls {
        display: flex;
        gap: 8px;
      }
      .btn-round {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        font-size: 1rem;
      }

      .btn-edit {
        background: white;
        color: var(--text-light);
        border: 1px solid #eee;
      }
      .btn-edit:hover {
        background: var(--info);
        color: white;
        border-color: var(--info);
        transform: rotate(15deg);
        box-shadow: 0 5px 15px rgba(41, 182, 246, 0.3);
      }

      .btn-del {
        background: white;
        color: var(--danger);
        border: 1px solid #ffcdd2;
      }
      .btn-del:hover {
        background: var(--danger);
        color: white;
        border-color: var(--danger);
        transform: rotate(90deg);
        box-shadow: 0 5px 15px rgba(255, 71, 87, 0.3);
      }

      .btn-move {
        background: white;
        color: #b2bec3;
        border: 1px solid #f1f2f6;
        font-size: 0.8rem;
      }

      /* INPUTS EN FILA ADMIN */
      .add-row {
        display: flex;
        gap: 10px;
        align-items: center;
        margin-top: 10px;
        background: #f8f9fa;
        padding: 8px;
        border-radius: 20px;
        border: 1px solid #eee;
      }
      .add-row input,
      .add-row select {
        border: none;
        background: transparent;
        padding: 10px 15px;
        margin: 0;
        box-shadow: none;
        font-size: 0.9rem;
      }
      .add-row button {
        margin: 0;
        width: auto;
        box-shadow: none;
        border-radius: 14px;
        padding: 12px 20px;
        font-size: 1.2rem;
        display: flex;
        align-items: center;
        justify-content: center;
        height: 48px;
        min-width: 48px;
      }

      /* HOURS EDITOR PILLS */
      .hours-editor-box {
        background: #fff0f6;
        padding: 20px;
        border-radius: 24px;
        border: 1px dashed var(--primary);
        margin-bottom: 20px;
        text-align: center;
      }
      .weekly-hours-container {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        justify-content: center;
        margin-bottom: 15px;
      }
      .hour-tag {
        display: inline-flex;
        align-items: center;
        background: white;
        color: var(--primary);
        padding: 8px 16px;
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.9rem;
        box-shadow: 0 3px 10px rgba(255, 20, 147, 0.1);
      }
      .hour-tag span {
        margin-left: 8px;
        color: #ffb7b2;
        cursor: pointer;
        font-weight: bold;
      }
      .hour-tag span:hover {
        color: var(--danger);
      }

      /* DAY SELECTOR */
      .week-selector {
        display: flex;
        justify-content: center;
        gap: 6px;
        margin-bottom: 20px;
        flex-wrap: wrap;
      }
      .day-chip {
        width: 44px;
        height: 44px;
        border-radius: 14px;
        background: white;
        border: 1px solid #eee;
        color: #b2bec3;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 0.85rem;
      }
      .day-chip.active {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
        transform: translateY(-3px);
        box-shadow: var(--primary-glow);
      }

      /* CALENDAR */
      .cal-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 6px;
        margin-top: 15px;
      }
      .day {
        aspect-ratio: 1/1;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 14px;
        cursor: pointer;
        font-size: 0.9rem;
        background: white;
        border: 1px solid #f1f2f6;
        color: var(--text);
        font-weight: 600;
        transition: all 0.2s;
      }
      .day.today {
        border-color: var(--primary);
        color: var(--primary);
        background: #fff0f6;
      }
      .day.selected {
        background: var(--primary) !important;
        color: white !important;
        border-color: var(--primary);
        transform: translateY(-2px);
        box-shadow: var(--primary-glow);
      }
      .day.full {
        background: #ffeaeb;
        color: #ff5252;
        border-color: #ffcdd2;
        pointer-events: none;
      }
      .day.blocked-day {
        background: #f5f5f5;
        color: #b2bec3;
        text-decoration: line-through;
        pointer-events: auto;
      }
      .day.disabled {
        opacity: 0.2;
        pointer-events: none;
      }

      @media (max-width: 600px) {
        .add-row {
          flex-direction: column;
          align-items: stretch;
          gap: 8px;
          padding: 15px;
        }
        .add-row input,
        .add-row select,
        .add-row button {
          width: 100% !important;
          height: 50px;
          border-radius: 14px;
        }
        .add-row input,
        .add-row select {
          background: #f5f5f5;
        }
        .service-item {
          flex-direction: column;
          align-items: flex-start;
          gap: 12px;
        }
        .svc-controls {
          width: 100%;
          justify-content: flex-end;
        }
        .admin-card {
          padding: 15px;
        }
      }

      .surcharge-alert {
        background: #fff8e1;
        border: 1px solid #ffe0b2;
        padding: 15px;
        border-radius: 18px;
        margin: 15px 0;
        display: none;
        color: #f57c00;
        font-size: 0.9rem;
        font-weight: 700;
        align-items: center;
        gap: 10px;
        animation: popIn 0.3s;
      }
      #editModeBar {
        background: var(--info);
        color: white;
        padding: 15px;
        text-align: center;
        font-weight: bold;
        display: none;
        justify-content: space-between;
        align-items: center;
        border-radius: 0 0 24px 24px;
        margin-bottom: 20px;
        box-shadow: 0 5px 15px rgba(41, 182, 246, 0.3);
      }
    </style>
  </head>
  <body>
    <div id="generalModal" class="modal-overlay">
      <div class="modal-content">
        <div class="modal-icon" id="genIcon">‚ú®</div>
        <h3 id="genTitle" style="color: var(--text); margin: 0"></h3>
        <p
          id="genMsg"
          style="color: var(--text-light); margin: 15px 0 25px"
        ></p>
        <button
          class="btn-main"
          style="margin-top: 0"
          onclick="closeModal('generalModal')"
        >
          Entendido
        </button>
      </div>
    </div>

    <div id="deleteServiceModal" class="modal-overlay">
      <div class="modal-content">
        <div class="modal-icon">üóëÔ∏è</div>
        <h3 style="color: var(--danger); margin: 0">¬øBorrar Servicio?</h3>
        <div class="modal-btn-row">
          <button
            class="btn-modal secondary"
            onclick="closeModal('deleteServiceModal')"
          >
            Cancelar
          </button>
          <button class="btn-modal danger" onclick="confirmDeleteService()">
            S√≠, Borrar
          </button>
        </div>
      </div>
    </div>

    <div id="deleteSurchargeModal" class="modal-overlay">
      <div class="modal-content">
        <div class="modal-icon">üí∏</div>
        <h3 style="color: var(--danger); margin: 0">¬øBorrar Recargo?</h3>
        <div class="modal-btn-row">
          <button
            class="btn-modal secondary"
            onclick="closeModal('deleteSurchargeModal')"
          >
            Cancelar
          </button>
          <button class="btn-modal danger" onclick="confirmDeleteSurcharge()">
            S√≠, Borrar
          </button>
        </div>
      </div>
    </div>

    <div id="deleteBlockModal" class="modal-overlay">
      <div class="modal-content">
        <div class="modal-icon">üîì</div>
        <h3 style="color: var(--text); margin: 0">¬øDesbloquear?</h3>
        <p style="color: var(--text-light); margin: 10px 0">
          Se abrir√° este espacio.
        </p>
        <div class="modal-btn-row">
          <button
            class="btn-modal secondary"
            onclick="closeModal('deleteBlockModal')"
          >
            Cancelar
          </button>
          <button class="btn-modal primary" onclick="confirmDeleteBlock()">
            S√≠, Abrir
          </button>
        </div>
      </div>
    </div>

    <div id="resetModal" class="modal-overlay">
      <div class="modal-content">
        <div class="modal-icon">üìß</div>
        <h3 style="color: var(--primary); margin: 0">Recuperar</h3>
        <input
          type="email"
          id="resetEmailInput"
          placeholder="tucorreo@ejemplo.com"
        />
        <div class="modal-btn-row">
          <button
            class="btn-modal secondary"
            onclick="closeModal('resetModal')"
          >
            Cancelar
          </button>
          <button class="btn-modal primary" onclick="sendResetEmail()">
            Enviar
          </button>
        </div>
      </div>
    </div>
    <div id="cancelModal" class="modal-overlay">
      <div class="modal-content">
        <div class="modal-icon">üíî</div>
        <h3 style="color: var(--text); margin: 0">¬øCancelar?</h3>
        <div class="modal-btn-row">
          <button
            class="btn-modal secondary"
            onclick="closeModal('cancelModal')"
          >
            Volver
          </button>
          <button class="btn-modal danger" onclick="confirmCancelation()">
            S√≠, Cancelar
          </button>
        </div>
      </div>
    </div>
    <div id="wspModal" class="modal-overlay">
      <div class="modal-content">
        <div class="modal-icon">üíÖ</div>
        <h2 style="color: var(--primary); margin: 0">¬°Casi Listo!</h2>
        <p style="color: var(--text-light)">Contin√∫a en WhatsApp.</p>
        <button class="btn-modal whatsapp" onclick="enviarWhatsAppCliente()">
          Enviar Mensaje
        </button>
      </div>
    </div>
    <div id="wspRescheduleModal" class="modal-overlay">
      <div class="modal-content">
        <div class="modal-icon">üîÑ</div>
        <h2 style="color: var(--info); margin: 0">Cambio Listo</h2>
        <button
          class="btn-modal whatsapp"
          onclick="enviarWhatsAppReprogramacion()"
        >
          Confirmar
        </button>
      </div>
    </div>

    <div id="recovery-screen" class="animate-pop">
      <h1 style="text-align: center; color: var(--primary); margin-top: 20%">
        Restablecer
      </h1>
      <p
        id="recoveryStatus"
        style="text-align: center; color: var(--text-light)"
      >
        Verificando enlace...
      </p>
      <div id="recoveryForm" style="display: none; padding: 20px">
        <div class="password-wrapper">
          <input
            type="password"
            id="recoveryPass"
            placeholder="Nueva contrase√±a (m√≠n 6)"
          /><span
            class="toggle-eye"
            onclick="togglePassword('recoveryPass', this)"
            >üëÅÔ∏è</span
          >
        </div>
        <button class="btn-main" onclick="finalizeRecovery()">
          Guardar Clave
        </button>
      </div>
    </div>

    <div id="auth-screen" class="animate-pop">
      <h1 style="text-align: center; color: var(--primary)">NailsbyNiNa</h1>
      <p
        style="
          text-align: center;
          color: var(--text-light);
          margin-bottom: 30px;
        "
      >
        Agenda tu momento de brillo ‚ú®
      </p>
      <div id="login-form">
        <input type="email" id="loginEmail" placeholder="Tu Correo" />
        <div class="password-wrapper">
          <input type="password" id="loginPass" placeholder="Contrase√±a" /><span
            class="toggle-eye"
            onclick="togglePassword('loginPass', this)"
            >üëÅÔ∏è</span
          >
        </div>
        <button class="btn-main" onclick="handleAuth('login')">
          Ingresar üíñ
        </button>
        <p style="text-align: center; margin-top: 15px">
          <a
            href="#"
            onclick="openResetModal()"
            style="color: var(--info); text-decoration: none; font-size: 0.9rem"
            >¬øOlvidaste tu contrase√±a?</a
          >
        </p>
        <p
          style="
            text-align: center;
            margin-top: 25px;
            color: var(--text-light);
            font-size: 0.9rem;
          "
        >
          ¬øNueva?
          <a
            href="#"
            onclick="toggleAuth(false)"
            style="
              color: var(--primary);
              font-weight: bold;
              text-decoration: none;
            "
            >Crear cuenta</a
          >
        </p>
      </div>
      <div id="signup-form" style="display: none">
        <input type="text" id="regNombre" placeholder="Nombre Completo" />
        <input type="email" id="regEmail" placeholder="Tu Correo" />
        <div class="password-wrapper">
          <input
            type="password"
            id="regPass"
            placeholder="Contrase√±a (m√≠n 6)"
          /><span class="toggle-eye" onclick="togglePassword('regPass', this)"
            >üëÅÔ∏è</span
          >
        </div>
        <div class="password-wrapper">
          <input
            type="password"
            id="regPassConfirm"
            placeholder="Confirmar Contrase√±a"
          /><span
            class="toggle-eye"
            onclick="togglePassword('regPassConfirm', this)"
            >üëÅÔ∏è</span
          >
        </div>
        <button class="btn-main" onclick="handleAuth('signup')">
          Registrarme ‚ú®
        </button>
        <p style="text-align: center; margin-top: 25px">
          <a
            href="#"
            onclick="toggleAuth(true)"
            style="
              color: var(--primary);
              font-weight: bold;
              text-decoration: none;
            "
            >Ya tengo cuenta</a
          >
        </p>
      </div>
    </div>

    <div id="app-screen" class="animate-pop">
      <div class="nav-header">
        <div class="brand-title">
          üíÖ Nailsby<span>NiNa</span>
          <span
            id="adminBadge"
            style="
              display: none;
              font-size: 0.6rem;
              background: var(--text);
              color: white;
              padding: 2px 6px;
              border-radius: 6px;
              margin-left: 5px;
            "
            >ADMIN</span
          >
        </div>
        <div
          class="header-avatar"
          id="headerAvatar"
          onclick="showTab('perfil')"
        >
          NN
        </div>
      </div>

      <div id="editModeBar">
        <span>üîÑ MODO REPROGRAMACI√ìN</span>
        <button
          onclick="cancelRescheduleMode()"
          style="
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 6px 12px;
            border-radius: 10px;
            cursor: pointer;
          "
        >
          Cancelar
        </button>
      </div>

      <div class="tabs">
        <button
          id="tab-agenda"
          class="tab-btn active"
          onclick="showTab('agenda')"
        >
          Agendar
        </button>
        <button id="tab-lista" class="tab-btn" onclick="showTab('lista')">
          Mis Citas
        </button>
        <button
          id="tab-config"
          class="tab-btn"
          onclick="showTab('config')"
          style="display: none"
        >
          Admin
        </button>
      </div>

      <div id="view-agenda" class="main-grid animate-pop">
        <div>
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: 15px;
            "
          >
            <button
              onclick="moveMonth(-1)"
              style="
                border: none;
                background: white;
                width: 40px;
                height: 40px;
                border-radius: 12px;
                box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
                color: var(--text);
                font-weight: bold;
                cursor: pointer;
              "
            >
              ‚óÄ
            </button>
            <b
              id="monthDisplay"
              style="
                text-transform: capitalize;
                color: var(--text);
                font-size: 1.1rem;
              "
            ></b>
            <button
              onclick="moveMonth(1)"
              style="
                border: none;
                background: white;
                width: 40px;
                height: 40px;
                border-radius: 12px;
                box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
                color: var(--text);
                font-weight: bold;
                cursor: pointer;
              "
            >
              ‚ñ∂
            </button>
          </div>
          <div class="cal-grid" id="calendarGrid"></div>
        </div>
        <div class="form-section">
          <h3 style="color: var(--text); margin: 0 0 15px">
            Detalles de tu cita
          </h3>
          <div id="newAppointmentFields">
            <input type="text" id="fieldNombre" placeholder="Nombre" />
            <input type="email" id="fieldCorreo" placeholder="Correo" />
            <input
              type="tel"
              id="fieldTelefono"
              placeholder="WhatsApp (Sin espacios)"
              pattern="[0-9]*"
              oninput="this.value = this.value.replace(/[^0-9]/g, '')"
            />

            <select id="fieldServicio" onchange="enableTimeSelector()" disabled>
              <option value="">1. Toca un d√≠a en el calendario üëÜ</option>
            </select>
          </div>

          <select id="fieldHora" onchange="checkSurcharges()" disabled>
            <option value="">2. Luego selecciona servicio...</option>
          </select>

          <div id="surchargeAlert" class="surcharge-alert">
            ‚ö†Ô∏è <span id="surchargeText"></span>
          </div>

          <button id="btnMainAction" class="btn-main" onclick="confirmarCita()">
            üíñ Reservar Cita
          </button>
        </div>
      </div>

      <div
        id="view-lista"
        style="display: none; padding: 20px"
        class="animate-pop"
      >
        <div class="sub-tabs">
          <button
            id="subtab-upcoming"
            class="sub-tab-btn active"
            onclick="switchListTab('upcoming')"
          >
            üìÖ Pr√≥ximas
          </button>
          <button
            id="subtab-history"
            class="sub-tab-btn"
            onclick="switchListTab('history')"
          >
            üïí Historial
          </button>
        </div>
        <div id="list-upcoming-container"></div>
        <div id="list-history-container" style="display: none"></div>
      </div>

      <div
        id="view-config"
        class="admin-control-panel animate-pop"
        style="display: none"
      >
        <div class="admin-card">
          <div class="admin-title">üíÖ Gesti√≥n de Servicios</div>
          <div id="adminServicesList"></div>

          <div class="add-row" id="formServiceRow">
            <input type="hidden" id="editServiceId" />
            <input
              type="text"
              id="newServiceInput"
              placeholder="Nombre del servicio..."
              style="flex: 2"
            />
            <select id="newServiceType" style="flex: 1.2">
              <option value="basico">ü©∑ B√°sico</option>
              <option value="diseno">üíñ Dise√±o</option>
            </select>
            <input
              type="text"
              id="newServiceDuration"
              placeholder="1:30"
              style="width: 70px; text-align: center"
            />
            <button
              id="btnSaveService"
              class="btn-main"
              style="
                background: var(--success);
                width: auto;
                padding: 0;
                margin: 0;
                box-shadow: none;
              "
              onclick="saveService()"
            >
              üíæ
            </button>
            <button
              id="btnCancelEdit"
              class="btn-main"
              style="
                background: #f1f2f6;
                color: #636e72;
                width: auto;
                padding: 0;
                margin: 0;
                display: none;
                box-shadow: none;
              "
              onclick="cancelEditService()"
            >
              ‚úï
            </button>
          </div>

          <div
            class="msg-config-box"
            style="
              margin-top: 20px;
              border-top: 1px solid #eee;
              padding-top: 15px;
            "
          >
            <label class="msg-label">ü©∑ Mensaje Final (B√°sico):</label>
            <textarea
              id="adminMsgBasic"
              rows="2"
              style="border: 1px solid #eee"
            ></textarea>
            <label class="msg-label" style="margin-top: 10px"
              >üíñ Mensaje Final (Dise√±o):</label
            >
            <textarea
              id="adminMsgDesign"
              rows="2"
              style="border: 1px solid #eee"
            ></textarea>
            <button
              class="btn-main"
              style="
                margin-top: 10px;
                padding: 12px;
                font-size: 0.9rem;
                background: var(--info);
              "
              onclick="saveMsgConfig()"
            >
              Guardar Mensajes
            </button>
          </div>
        </div>

        <div class="admin-card">
          <div class="admin-title">‚è∞ Horario Semanal</div>
          <div class="week-selector">
            <div class="day-chip" id="d1" onclick="toggleWeekDay(1)">Lu</div>
            <div class="day-chip" id="d2" onclick="toggleWeekDay(2)">Ma</div>
            <div class="day-chip" id="d3" onclick="toggleWeekDay(3)">Mi</div>
            <div class="day-chip" id="d4" onclick="toggleWeekDay(4)">Ju</div>
            <div class="day-chip" id="d5" onclick="toggleWeekDay(5)">Vi</div>
            <div class="day-chip" id="d6" onclick="toggleWeekDay(6)">Sa</div>
            <div class="day-chip" id="d0" onclick="toggleWeekDay(0)">Do</div>
          </div>

          <div
            id="hoursEditor"
            class="hours-editor-box"
            style="display: none; background: #fff; border: 1px solid #eee"
          >
            <div
              style="
                margin-bottom: 15px;
                border-bottom: 1px solid #eee;
                padding-bottom: 15px;
                text-align: left;
              "
            >
              <label
                style="font-size: 0.85rem; font-weight: 700; color: var(--text)"
                >Hora de Cierre (L√≠mite):</label
              >
              <input
                type="time"
                id="dayClosingTime"
                style="margin-top: 5px; background: #f9f9f9"
              />
            </div>
            <div id="weeklyHours" class="weekly-hours-container"></div>
            <div class="add-row">
              <input type="time" id="newHourInput" />
              <button
                class="btn-main"
                style="
                  background: var(--text);
                  margin: 0;
                  padding: 0;
                  width: auto;
                "
                onclick="addHourToSelected()"
              >
                +
              </button>
            </div>
            <button
              class="btn-main"
              style="
                background: var(--whatsapp);
                margin-top: 15px;
                font-size: 0.9rem;
              "
              onclick="saveWeekSchedule()"
            >
              Guardar Horario
            </button>
          </div>
        </div>

        <div
          class="admin-card"
          style="background: #fff8e1; border-color: #ffe0b2"
        >
          <div class="admin-title" style="color: #f57c00">
            üí∞ Recargos por Hora
          </div>
          <div class="add-row" id="formSurchargeRow" style="background: white">
            <input type="hidden" id="editSurchargeId" />
            <input type="time" id="surchargeTime" style="flex: 1" />
            <span style="font-weight: bold; color: #ccc">-</span>
            <input type="time" id="surchargeEnd" style="flex: 1" />
            <input
              type="text"
              id="surchargeMsg"
              placeholder="Ej: Recargo nocturno"
              style="flex: 2"
            />
            <button
              id="btnSaveSurcharge"
              class="btn-main"
              style="
                background: var(--warning);
                margin: 0;
                padding: 0;
                width: auto;
                box-shadow: none;
              "
              onclick="addSurcharge()"
            >
              +
            </button>
            <button
              id="btnCancelSurcharge"
              class="btn-main"
              style="
                background: #f1f2f6;
                color: #666;
                margin: 0;
                padding: 0;
                width: auto;
                display: none;
                box-shadow: none;
              "
              onclick="cancelEditSurcharge()"
            >
              ‚úï
            </button>
          </div>
          <div id="surchargesList" style="margin-top: 15px"></div>
        </div>

        <div
          class="admin-card"
          style="background: #ffebee; border-color: #ffcdd2"
        >
          <div class="admin-title" style="color: var(--danger)">
            üîí Bloquear Fecha
          </div>
          <input
            type="date"
            id="adminDateInput"
            onchange="loadAdminDayConfig()"
            style="background: white; margin-bottom: 15px"
          />

          <div id="adminPanelControls" style="display: none">
            <button
              id="btnToggleDay"
              onclick="toggleFullDayBlock()"
              class="btn-main"
              style="
                background: white;
                color: var(--text);
                border: 1px solid #ddd;
                margin-bottom: 20px;
                box-shadow: none;
              "
            >
              CERRAR D√çA COMPLETO
            </button>

            <h4
              style="
                margin: 0 0 10px 0;
                color: var(--danger);
                font-size: 0.9rem;
              "
            >
              Bloquear Rango Espec√≠fico
            </h4>
            <div class="add-row" style="background: white">
              <input type="time" id="blockStartTime" style="flex: 1" />
              <span>-</span>
              <input type="time" id="blockEndTime" style="flex: 1" />
              <button
                class="btn-main"
                style="
                  background: var(--danger);
                  width: auto;
                  padding: 0;
                  margin: 0;
                  box-shadow: none;
                "
                onclick="addBlockRange()"
              >
                üîí
              </button>
            </div>
            <div id="adminBlockList" style="margin-top: 15px"></div>
          </div>
        </div>
      </div>

      <div
        id="view-perfil"
        style="display: none; padding: 20px"
        class="animate-pop"
      >
        <div class="profile-header-large">
          <div class="avatar-large" id="profileAvatarLarge">NN</div>
          <h2 style="margin: 0; color: var(--text)" id="displayProfileName">
            Usuario
          </h2>
          <p style="color: #aaa; margin: 5px" id="displayProfileEmail">...</p>
        </div>
        <div
          style="
            background: white;
            padding: 25px;
            border-radius: 24px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.03);
            margin-bottom: 20px;
          "
        >
          <h4 style="margin-top: 0; color: var(--primary)">Editar Nombre</h4>
          <div
            class="add-row"
            style="
              background: #f9f9f9;
              padding: 0;
              border: none;
              box-shadow: none;
            "
          >
            <input
              type="text"
              id="profileNameInput"
              style="background: white"
            />
            <button
              class="btn-main"
              style="
                padding: 0 20px;
                margin: 0;
                width: auto;
                background: var(--primary);
              "
              onclick="updateProfileName()"
            >
              üíæ
            </button>
          </div>
        </div>
        <button
          class="btn-main"
          style="
            background: white;
            border: 2px dashed var(--primary);
            color: var(--primary);
            margin-bottom: 20px;
            box-shadow: none;
          "
          onclick="togglePassForm()"
        >
          üîí Cambiar Contrase√±a
        </button>
        <div
          id="profilePassForm"
          style="
            display: none;
            background: white;
            padding: 25px;
            border-radius: 24px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.03);
            margin-bottom: 20px;
          "
        >
          <h4 style="margin-top: 0">Nueva Contrase√±a</h4>
          <div class="password-wrapper">
            <input
              type="password"
              id="currentPassProfile"
              placeholder="Actual"
            /><span
              class="toggle-eye"
              onclick="togglePassword('currentPassProfile', this)"
              >üëÅÔ∏è</span
            >
          </div>
          <div class="password-wrapper">
            <input
              type="password"
              id="newPassProfile"
              placeholder="Nueva (min 6)"
            /><span
              class="toggle-eye"
              onclick="togglePassword('newPassProfile', this)"
              >üëÅÔ∏è</span
            >
          </div>
          <div class="password-wrapper">
            <input
              type="password"
              id="confirmPassProfile"
              placeholder="Confirmar"
            /><span
              class="toggle-eye"
              onclick="togglePassword('confirmPassProfile', this)"
              >üëÅÔ∏è</span
            >
          </div>
          <button
            class="btn-main"
            style="margin-top: 15px; background: var(--info)"
            onclick="updatePassword()"
          >
            Actualizar
          </button>
        </div>
        <button
          onclick="logout()"
          style="
            width: 100%;
            padding: 18px;
            border: 2px solid #ffebee;
            background: #fff5f5;
            color: var(--danger);
            border-radius: 20px;
            font-weight: 800;
            cursor: pointer;
            font-family: inherit;
          "
        >
          Cerrar Sesi√≥n
        </button>
      </div>
    </div>

    <script>
      const sbUrl = "https://jifwtgpchbipxyriirtq.supabase.co";
      const sbKey = "sb_publishable_zF5mj6Ba61zibU_19vnFPQ_a4GDaKwi";
      const client = supabase.createClient(sbUrl, sbKey);
      const miWhatsAppAdmin = "573228211246";

      let userProfile = null,
        currentUserEmail = "",
        globalSchedule = {},
        globalServices = [],
        selectedWeekDays = [],
        stagedHours = [],
        viewDate = new Date(),
        selectedDate = null,
        lastCitaData = null,
        isRescheduling = false,
        rescheduleId = null,
        rescheduleData = null,
        pendingCancelId = null,
        pendingCancelData = null;
      let pendingServiceDeleteId = null;
      let pendingSurchargeId = null;
      let pendingBlockId = null;
      let msgBasic = "Te env√≠o el comprobante por aqu√≠.";
      let msgDesign = "Te env√≠o el dise√±o que tengo en mente y el comprobante.";
      let globalSurcharges = [];
      let globalClosingTimes = {};
      let adminSelectedDate = null;

      const hash = window.location.hash;
      const isRecovery = hash && hash.includes("type=recovery");

      function formatDateText(dateStr) {
        const dias = [
          "Domingo",
          "Lunes",
          "Martes",
          "Mi√©rcoles",
          "Jueves",
          "Viernes",
          "S√°bado",
        ];
        const meses = [
          "Enero",
          "Febrero",
          "Marzo",
          "Abril",
          "Mayo",
          "Junio",
          "Julio",
          "Agosto",
          "Septiembre",
          "Octubre",
          "Noviembre",
          "Diciembre",
        ];
        const date = new Date(dateStr + "T00:00:00");
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const tomorrow = new Date(today);
        tomorrow.setDate(tomorrow.getDate() + 1);
        let prefix = "";
        if (date.toDateString() === today.toDateString()) prefix = "Hoy, ";
        else if (date.toDateString() === tomorrow.toDateString())
          prefix = "Ma√±ana, ";
        return (
          prefix +
          `${dias[date.getDay()]}, ${date.getDate()} de ${meses[date.getMonth()]}`
        );
      }

      function minsToTime(totalMins) {
        let h = Math.floor(totalMins / 60);
        const m = totalMins % 60;
        if (h >= 24) h -= 24;
        return `${String(h).padStart(2, "0")}:${String(m).padStart(2, "0")}`;
      }
      function timeToMins(t) {
        if (!t) return 0;
        const [h, m] = t.split(":").map(Number);
        return h * 60 + m;
      }
      function formatServiceName(str) {
        if (!str) return "";
        const minorWords = [
          "de",
          "del",
          "la",
          "las",
          "el",
          "los",
          "y",
          "o",
          "en",
          "con",
          "sin",
          "por",
          "para",
          "un",
          "una",
        ];
        return str
          .toLowerCase()
          .split(" ")
          .map((word, index) => {
            if (index > 0 && minorWords.includes(word)) return word;
            return word.charAt(0).toUpperCase() + word.slice(1);
          })
          .join(" ");
      }
      function parseDurationInput(input) {
        if (!input) return 60;
        if (input.toString().includes(":")) {
          const [h, m] = input.split(":").map(Number);
          return h * 60 + (m || 0);
        }
        return parseInt(input);
      }
      function formatDurationDisplay(mins) {
        const h = Math.floor(mins / 60);
        const m = mins % 60;
        return `${h}:${String(m).padStart(2, "0")}h`;
      }

      async function initApp() {
        if (isRecovery) {
          document.getElementById("auth-screen").style.display = "none";
          document.getElementById("app-screen").style.display = "none";
          document.getElementById("recovery-screen").style.display = "block";
          let checks = 0;
          const checkSession = async () => {
            const { data } = await client.auth.getSession();
            if (data.session) {
              document.getElementById("recoveryStatus").innerText =
                "‚úÖ Verificado. Escribe tu nueva clave.";
              document.getElementById("recoveryStatus").style.color =
                "var(--success)";
              document.getElementById("recoveryForm").style.display = "block";
              return true;
            }
            return false;
          };
          if (await checkSession()) return;
          const interval = setInterval(async () => {
            checks++;
            if ((await checkSession()) || checks > 8) clearInterval(interval);
          }, 500);
        } else {
          checkUser();
        }
      }

      function renderProfileUI() {
        if (!userProfile) return;
        const names = userProfile.full_name.split(" ");
        const initials =
          names.length > 1
            ? (names[0][0] + names[1][0]).toUpperCase()
            : names[0].substring(0, 2).toUpperCase();
        document.getElementById("headerAvatar").innerText = initials;
        document.getElementById("profileAvatarLarge").innerText = initials;
        document.getElementById("displayProfileName").innerText =
          userProfile.full_name;
        document.getElementById("displayProfileEmail").innerText =
          currentUserEmail;
        document.getElementById("profileNameInput").value =
          userProfile.full_name;
      }

      async function checkUser() {
        if (isRecovery) return;
        const {
          data: { session },
        } = await client.auth.getSession();
        if (session) {
          currentUserEmail = session.user.email;
          const { data } = await client
            .from("profiles")
            .select("*")
            .eq("id", session.user.id)
            .single();
          if (!data) return setTimeout(checkUser, 500);
          userProfile = data;
          document.getElementById("auth-screen").style.display = "none";
          document.getElementById("app-screen").style.display = "block";
          document.getElementById("fieldNombre").value = data.full_name;
          document.getElementById("fieldCorreo").value = session.user.email;
          renderProfileUI();
          await fetchServices();
          await fetchSchedule();
          await fetchSurcharges();

          const { data: cfg } = await client
            .from("textos_app")
            .select("*")
            .eq("id", 1)
            .single();
          if (cfg) {
            msgBasic = cfg.final_basico || msgBasic;
            msgDesign = cfg.final_diseno || msgDesign;
            document.getElementById("adminMsgBasic").value = msgBasic;
            document.getElementById("adminMsgDesign").value = msgDesign;
          } else {
            document.getElementById("adminMsgBasic").value = msgBasic;
            document.getElementById("adminMsgDesign").value = msgDesign;
          }

          if (data.role === "admin") {
            document.getElementById("adminBadge").style.display =
              "inline-block";
            document.getElementById("tab-config").style.display = "block";
            document.getElementById("fieldNombre").readOnly = false;
            document.getElementById("fieldCorreo").readOnly = false;
          } else {
            document.getElementById("fieldNombre").readOnly = true;
            document.getElementById("fieldCorreo").readOnly = true;
          }

          renderCalendar();

          setInterval(() => {
            if (document.getElementById("view-lista").style.display !== "none")
              loadAllAppointments();
          }, 30000);
        } else {
          document.getElementById("auth-screen").style.display = "block";
        }
      }

      // RECARGOS (LOGICA EDITAR MEJORADA)
      async function fetchSurcharges() {
        const { data } = await client
          .from("recargos_rango")
          .select("*")
          .order("hora_inicio");
        globalSurcharges = data || [];
        renderAdminSurcharges();
      }

      // NUEVO: EDITAR RECARGO
      function editSurcharge(id) {
        const recargo = globalSurcharges.find((r) => r.id === id);
        if (!recargo) return;

        document
          .getElementById("formSurchargeRow")
          .scrollIntoView({ behavior: "smooth", block: "center" });
        const row = document.getElementById("formSurchargeRow");
        row.classList.add("pulse-input");
        setTimeout(() => row.classList.remove("pulse-input"), 1000);

        document.getElementById("editSurchargeId").value = recargo.id;
        document.getElementById("surchargeTime").value = recargo.hora_inicio;
        document.getElementById("surchargeEnd").value = recargo.hora_fin;
        document.getElementById("surchargeMsg").value = recargo.mensaje;

        document.getElementById("btnSaveSurcharge").innerText = "üíæ";
        document.getElementById("btnCancelSurcharge").style.display = "block";
      }

      function cancelEditSurcharge() {
        document.getElementById("editSurchargeId").value = "";
        document.getElementById("surchargeTime").value = "";
        document.getElementById("surchargeEnd").value = "";
        document.getElementById("surchargeMsg").value = "";
        document.getElementById("btnSaveSurcharge").innerText = "+";
        document.getElementById("btnCancelSurcharge").style.display = "none";
      }

      async function addSurcharge() {
        const id = document.getElementById("editSurchargeId").value;
        const s = document.getElementById("surchargeTime").value;
        const e = document.getElementById("surchargeEnd").value;
        const m = document.getElementById("surchargeMsg").value;

        if (!s || !e || !m) {
          showAlert("Faltan datos", "Llena todos los campos.");
          return;
        }

        if (id) {
          // UPDATE
          await client
            .from("recargos_rango")
            .update({ hora_inicio: s, hora_fin: e, mensaje: m })
            .eq("id", id);
        } else {
          // INSERT
          await client
            .from("recargos_rango")
            .insert({ hora_inicio: s, hora_fin: e, mensaje: m });
        }

        cancelEditSurcharge();
        await fetchSurcharges();
      }

      function deleteSurcharge(id) {
        pendingSurchargeId = id;
        document.getElementById("deleteSurchargeModal").style.display = "flex";
      }
      async function confirmDeleteSurcharge() {
        if (!pendingSurchargeId) return;
        await client
          .from("recargos_rango")
          .delete()
          .eq("id", pendingSurchargeId);
        closeModal("deleteSurchargeModal");
        pendingSurchargeId = null;
        await fetchSurcharges();
      }

      function renderAdminSurcharges() {
        const c = document.getElementById("surchargesList");
        c.innerHTML = "";
        globalSurcharges.forEach((r) => {
          const s = r.hora_inicio.substring(0, 5);
          const e = r.hora_fin.substring(0, 5);
          c.innerHTML += `<div class="service-item">
               <div class="service-info"><b>${format12h(s)} - ${format12h(e)}</b><br><span style="font-weight:400; font-size:0.85rem">${r.mensaje}</span></div>
               <div class="svc-controls">
                  <button class="btn-round btn-edit" onclick="editSurcharge(${r.id})">‚úèÔ∏è</button>
                  <button class="btn-round btn-del" onclick="deleteSurcharge(${r.id})">üóëÔ∏è</button>
               </div>
            </div>`;
        });
      }

      function checkSurcharges() {
        const h = document.getElementById("fieldHora").value;
        const d = document.getElementById("surchargeAlert");
        if (!h) {
          d.style.display = "none";
          return;
        }
        const selMins = timeToMins(h);
        let activeMsg = null;
        for (let r of globalSurcharges) {
          const start = timeToMins(r.hora_inicio);
          const end = timeToMins(r.hora_fin);
          if (selMins >= start && selMins < end) {
            activeMsg = r.mensaje;
            break;
          }
        }
        if (activeMsg) {
          document.getElementById("surchargeText").innerText = activeMsg;
          d.style.display = "flex";
        } else {
          d.style.display = "none";
        }
      }

      async function saveMsgConfig() {
        const b = document.getElementById("adminMsgBasic").value;
        const d = document.getElementById("adminMsgDesign").value;
        const { error } = await client
          .from("textos_app")
          .upsert({ id: 1, final_basico: b, final_diseno: d });
        if (error) showAlert("Error", "Falta crear la tabla en DB.");
        else {
          msgBasic = b;
          msgDesign = d;
          showAlert("√âxito", "Mensajes actualizados.");
        }
      }

      function togglePassword(id, icon) {
        const i = document.getElementById(id);
        if (i.type === "password") {
          i.type = "text";
          icon.innerText = "üôà";
        } else {
          i.type = "password";
          icon.innerText = "üëÅÔ∏è";
        }
      }
      function togglePassForm() {
        const f = document.getElementById("profilePassForm");
        f.style.display = f.style.display === "none" ? "block" : "none";
      }
      function showAlert(t, m, i = "‚ú®") {
        document.getElementById("genIcon").innerText = i;
        document.getElementById("genTitle").innerText = t;
        document.getElementById("genMsg").innerText = m;
        document.getElementById("generalModal").style.display = "flex";
      }
      function closeModal(id) {
        document.getElementById(id).style.display = "none";
      }
      function toggleAuth(l) {
        document.getElementById("login-form").style.display = l
          ? "block"
          : "none";
        document.getElementById("signup-form").style.display = l
          ? "none"
          : "block";
      }
      async function handleAuth(t) {
        const e = document.getElementById(
          t === "login" ? "loginEmail" : "regEmail",
        ).value;
        const p = document.getElementById(
          t === "login" ? "loginPass" : "regPass",
        ).value;
        if (t === "signup") {
          if (p !== document.getElementById("regPassConfirm").value)
            return showAlert("Error", "No coinciden");
          const { error } = await client.auth.signUp({
            email: e,
            password: p,
            options: {
              data: { full_name: document.getElementById("regNombre").value },
            },
          });
          if (error) showAlert("Error", error.message);
          else showAlert("Bienvenida", "Cuenta creada.");
        } else {
          const { error } = await client.auth.signInWithPassword({
            email: e,
            password: p,
          });
          if (error) showAlert("Error", "Datos incorrectos.");
          else checkUser();
        }
      }
      function openResetModal() {
        document.getElementById("resetModal").style.display = "flex";
      }
      async function sendResetEmail() {
        const e = document.getElementById("resetEmailInput").value;
        if (!e) return showAlert("Error", "Falta correo");
        const { error } = await client.auth.resetPasswordForEmail(e, {
          redirectTo: window.location.href,
        });
        if (error) showAlert("Error", error.message);
        else {
          closeModal("resetModal");
          showAlert("Enviado", "Revisa tu correo.");
        }
      }
      async function finalizeRecovery() {
        const p = document.getElementById("recoveryPass").value;
        if (p.length < 6) return showAlert("Error", "Min 6 caracteres");
        const { error } = await client.auth.updateUser({ password: p });
        if (error) {
          showAlert("Error", "Enlace expirado.");
          setTimeout(() => {
            window.location.hash = "";
            window.location.reload();
          }, 2000);
        } else {
          showAlert("¬°√âxito!", "Clave cambiada.");
          document.getElementById("recovery-screen").style.display = "none";
          history.replaceState(null, null, " ");
          checkUser();
        }
      }

      // ADMIN: SERVICIOS Y EDICION
      async function fetchServices() {
        const { data } = await client
          .from("servicios")
          .select("*")
          .order("orden", { ascending: true });
        if (data) {
          globalServices = data;
          const s = document.getElementById("fieldServicio");
          s.innerHTML = "";
          s.add(new Option("1. Toca un d√≠a en el calendario üëÜ", ""));
          s.disabled = true;

          if (userProfile?.role === "admin") {
            const l = document.getElementById("adminServicesList");
            l.innerHTML = "";
            globalServices.forEach((i, idx) => {
              const icon = i.tipo === "diseno" ? "üíñ" : "ü©∑";
              l.innerHTML += `
                <div class="service-item">
                  <div class="service-info">
                    <span>${icon} ${i.nombre} (${formatDurationDisplay(i.duracion_minutos || 60)})</span>
                  </div>
                  <div class="svc-controls">
                    <button class="btn-round btn-move" onclick="moveService(${i.id}, ${i.orden}, 'up')">‚¨Ü</button>
                    <button class="btn-round btn-move" onclick="moveService(${i.id}, ${i.orden}, 'down')">‚¨á</button>
                    <button class="btn-round btn-edit" onclick="editService(${i.id})">‚úèÔ∏è</button>
                    <button class="btn-round btn-del" onclick="askDeleteService(${i.id})">üóëÔ∏è</button>
                  </div>
                </div>`;
            });
          }
        }
      }

      function editService(id) {
        const svc = globalServices.find((s) => s.id === id);
        if (!svc) return;

        document
          .getElementById("formServiceRow")
          .scrollIntoView({ behavior: "smooth", block: "center" });
        const row = document.getElementById("formServiceRow");
        row.classList.add("pulse-input");
        setTimeout(() => row.classList.remove("pulse-input"), 1000);

        document.getElementById("editServiceId").value = svc.id;
        document.getElementById("newServiceInput").value = svc.nombre;
        document.getElementById("newServiceType").value = svc.tipo;

        const h = Math.floor((svc.duracion_minutos || 60) / 60);
        const m = (svc.duracion_minutos || 60) % 60;
        document.getElementById("newServiceDuration").value =
          `${h}:${String(m).padStart(2, "0")}`;

        document.getElementById("btnSaveService").innerText = "üíæ";
        document.getElementById("btnCancelEdit").style.display = "block";
      }

      function cancelEditService() {
        document.getElementById("editServiceId").value = "";
        document.getElementById("newServiceInput").value = "";
        document.getElementById("newServiceType").value = "basico";
        document.getElementById("newServiceDuration").value = "1:00";
        document.getElementById("btnSaveService").innerText = "Guardar";
        document.getElementById("btnCancelEdit").style.display = "none";
      }

      async function saveService() {
        const id = document.getElementById("editServiceId").value;
        let v = document.getElementById("newServiceInput").value.trim();
        v = formatServiceName(v);
        const t = document.getElementById("newServiceType").value;
        const rawDur = document.getElementById("newServiceDuration").value;
        if (!v) return;

        const d = parseDurationInput(rawDur);

        if (id) {
          await client
            .from("servicios")
            .update({ nombre: v, tipo: t, duracion_minutos: d })
            .eq("id", id);
        } else {
          const lastOrder =
            globalServices.length > 0
              ? Math.max(...globalServices.map((s) => s.orden || 0))
              : 0;
          await client
            .from("servicios")
            .insert([
              { nombre: v, tipo: t, duracion_minutos: d, orden: lastOrder + 1 },
            ]);
        }
        cancelEditService();
        await fetchServices();
        renderCalendar();
      }

      async function moveService(id, currentOrder, direction) {
        const index = globalServices.findIndex((s) => s.id === id);
        if (index === -1) return;
        const swapIndex = direction === "up" ? index - 1 : index + 1;
        if (swapIndex < 0 || swapIndex >= globalServices.length) return;
        const otherService = globalServices[swapIndex];
        await client
          .from("servicios")
          .update({ orden: otherService.orden })
          .eq("id", id);
        await client
          .from("servicios")
          .update({ orden: currentOrder })
          .eq("id", otherService.id);
        await fetchServices();
      }

      function askDeleteService(id) {
        pendingServiceDeleteId = id;
        document.getElementById("deleteServiceModal").style.display = "flex";
      }
      async function confirmDeleteService() {
        if (!pendingServiceDeleteId) return;
        await client
          .from("servicios")
          .delete()
          .eq("id", pendingServiceDeleteId);
        closeModal("deleteServiceModal");
        pendingServiceDeleteId = null;
        await fetchServices();
      }

      async function updateProfileName() {
        const n = document.getElementById("profileNameInput").value;
        const { error } = await client
          .from("profiles")
          .update({ full_name: n })
          .eq("id", userProfile.id);
        if (!error) {
          userProfile.full_name = n;
          renderProfileUI();
          showAlert("√âxito", "Nombre actualizado.");
        }
      }
      async function updatePassword() {
        const c = document.getElementById("currentPassProfile").value,
          n = document.getElementById("newPassProfile").value,
          cf = document.getElementById("confirmPassProfile").value;
        if (!c || !n || !cf) return showAlert("Falta", "Llena todo");
        if (n !== cf) return showAlert("Error", "No coinciden");
        const { error: s } = await client.auth.signInWithPassword({
          email: currentUserEmail,
          password: c,
        });
        if (s) return showAlert("Error", "Contrase√±a actual mal");
        const { error } = await client.auth.updateUser({ password: n });
        if (!error) {
          togglePassForm();
          document.getElementById("currentPassProfile").value = "";
          showAlert("√âxito", "Actualizada.");
        } else showAlert("Error", error.message);
      }
      async function logout() {
        await client.auth.signOut();
        localStorage.clear();
        window.location.href = window.location.origin;
      }

      let touchStartX = 0,
        touchEndX = 0;
      document
        .getElementById("app-screen")
        .addEventListener(
          "touchstart",
          (e) => (touchStartX = e.changedTouches[0].screenX),
        );
      document
        .getElementById("app-screen")
        .addEventListener("touchend", (e) => {
          touchEndX = e.changedTouches[0].screenX;
          if (Math.abs(touchEndX - touchStartX) > 100) {
            const tabs = ["agenda", "lista"];
            if (userProfile?.role === "admin") tabs.push("config");
            let i = 0;
            if (document.getElementById("view-lista").style.display !== "none")
              i = 1;
            if (document.getElementById("view-config").style.display !== "none")
              i = 2;
            if (document.getElementById("view-perfil").style.display !== "none")
              return;
            if (touchEndX < touchStartX) {
              if (i < tabs.length - 1) showTab(tabs[i + 1]);
            } else {
              if (i > 0) showTab(tabs[i - 1]);
            }
          }
        });
      function format12h(h) {
        if (!h) return "";
        let [hr, m] = h.split(":");
        let suf = hr >= 12 ? "PM" : "AM";
        hr = hr % 12 || 12;
        return `${hr}:${m} ${suf}`;
      }
      function showTab(t) {
        ["agenda", "lista", "config", "perfil"].forEach(
          (x) => (document.getElementById(`view-${x}`).style.display = "none"),
        );
        ["agenda", "lista", "config"].forEach(
          (x) => (document.getElementById(`tab-${x}`).className = "tab-btn"),
        );
        if (t !== "perfil")
          document.getElementById(`tab-${t}`).className = "tab-btn active";
        document.getElementById(`view-${t}`).style.display =
          t === "agenda"
            ? window.innerWidth > 768
              ? "grid"
              : "block"
            : "block";
        if (t === "lista") loadAllAppointments();
        if (t !== "agenda") cancelRescheduleMode();
      }

      // HORARIOS
      function toggleWeekDay(d) {
        const i = selectedWeekDays.indexOf(d);
        if (i > -1) selectedWeekDays.splice(i, 1);
        else selectedWeekDays.push(d);
        renderWeekDays();
      }
      function renderWeekDays() {
        [0, 1, 2, 3, 4, 5, 6].forEach((d) => {
          const el = document.getElementById(`d${d}`);
          if (selectedWeekDays.includes(d)) el.classList.add("active");
          else el.classList.remove("active");
        });

        document.getElementById("hoursEditor").style.display =
          selectedWeekDays.length ? "block" : "none";

        if (selectedWeekDays.length === 1) {
          const day = selectedWeekDays[0];
          const closing = globalClosingTimes[day] || "";
          document.getElementById("dayClosingTime").value = closing;
        } else {
          document.getElementById("dayClosingTime").value = "";
        }
        renderStaged();
      }
      function renderStaged() {
        const c = document.getElementById("weeklyHours");
        c.innerHTML = "";
        let allHours = new Set();
        selectedWeekDays.forEach((day) => {
          if (globalSchedule[day] && globalSchedule[day].horas)
            globalSchedule[day].horas.forEach((h) => allHours.add(h));
        });
        const sortedHours = Array.from(allHours).sort();
        sortedHours.forEach((h) => {
          c.innerHTML += `<div class="hour-tag">${format12h(h)} <span onclick="remStaged('${h}')">‚úï</span></div>`;
        });
      }
      function addHourToSelected() {
        const h = document.getElementById("newHourInput").value;
        if (!h) return;
        selectedWeekDays.forEach((day) => {
          if (!globalSchedule[day]) globalSchedule[day] = { horas: [] };
          if (!globalSchedule[day].horas.includes(h))
            globalSchedule[day].horas.push(h);
        });
        renderStaged();
      }
      function remStaged(h) {
        selectedWeekDays.forEach((day) => {
          if (globalSchedule[day] && globalSchedule[day].horas) {
            globalSchedule[day].horas = globalSchedule[day].horas.filter(
              (x) => x !== h,
            );
          }
        });
        renderStaged();
      }

      async function saveWeekSchedule() {
        const closingTime = document.getElementById("dayClosingTime").value;
        for (let d of selectedWeekDays) {
          let updateData = {
            dia: d,
            horas: globalSchedule[d] ? globalSchedule[d].horas : [],
          };
          if (closingTime && selectedWeekDays.length === 1)
            updateData.hora_cierre = closingTime;
          else if (selectedWeekDays.length > 1 && closingTime)
            updateData.hora_cierre = closingTime;
          await client.from("horarios_base").upsert(updateData);
        }
        selectedWeekDays = [];
        renderWeekDays();
        await fetchSchedule();
        showAlert("√âxito", "Horario guardado.");
      }

      async function loadAdminDayConfig() {
        const d = document.getElementById("adminDateInput").value;
        if (!d) return;
        adminSelectedDate = d;
        document.getElementById("adminPanelControls").style.display = "block";
        const { data } = await client
          .from("bloqueos")
          .select("*")
          .eq("fecha", d);
        const isFull = data.some((b) => b.hora_inicio === null);
        document.getElementById("btnToggleDay").innerText = isFull
          ? "üîì ABRIR D√çA"
          : "üîí CERRAR D√çA";
        renderBlockedRanges(data);
      }

      function renderBlockedRanges(data) {
        const container = document.getElementById("adminBlockList");
        container.innerHTML = "";
        if (!data) return;
        data.forEach((b) => {
          if (b.hora_inicio !== null) {
            const s = b.hora_inicio.substring(0, 5);
            const e = b.hora_fin.substring(0, 5);
            container.innerHTML += `<div class="service-item"><span>üö´ ${format12h(s)} - ${format12h(e)}</span><button class="btn-round btn-del" onclick="askDeleteBlock(${b.id})">üóëÔ∏è</button></div>`;
          }
        });
      }

      async function addBlockRange() {
        if (!adminSelectedDate) return;
        const start = document.getElementById("blockStartTime").value;
        const end = document.getElementById("blockEndTime").value;
        if (!start || !end) {
          showAlert("Falta hora", "Selecciona inicio y fin.");
          return;
        }

        await client
          .from("bloqueos")
          .insert({
            fecha: adminSelectedDate,
            hora_inicio: start,
            hora_fin: end,
          });
        document.getElementById("blockStartTime").value = "";
        document.getElementById("blockEndTime").value = "";
        loadAdminDayConfig();
        renderCalendar();
      }

      function askDeleteBlock(id) {
        pendingBlockId = id;
        document.getElementById("deleteBlockModal").style.display = "flex";
      }

      async function confirmDeleteBlock() {
        if (!pendingBlockId) return;
        await client.from("bloqueos").delete().eq("id", pendingBlockId);
        closeModal("deleteBlockModal");
        loadAdminDayConfig();
        renderCalendar();
      }

      async function toggleFullDayBlock() {
        const { data } = await client
          .from("bloqueos")
          .select("*")
          .eq("fecha", adminSelectedDate)
          .is("hora_inicio", null);
        if (data.length)
          await client.from("bloqueos").delete().eq("id", data[0].id);
        else
          await client
            .from("bloqueos")
            .insert([
              { fecha: adminSelectedDate, hora_inicio: null, hora_fin: null },
            ]);
        loadAdminDayConfig();
        renderCalendar();
      }

      function startReschedule(id, f, h, s, n, t) {
        isRescheduling = true;
        rescheduleId = id;
        rescheduleData = { fecha: f, hora: h, servicio: s, nombre: n, tel: t };
        document.getElementById("editModeBar").style.display = "flex";
        document.getElementById("newAppointmentFields").style.display = "none";
        document.getElementById("btnMainAction").innerText =
          "Confirmar Nueva Fecha üîÑ";
        document.getElementById("btnMainAction").className =
          "btn-main reschedule-mode";
        showTab("agenda");
        showAlert("Reprogramar", "Selecciona fecha y hora.", "üóìÔ∏è");
      }
      function cancelRescheduleMode() {
        isRescheduling = false;
        rescheduleId = null;
        document.getElementById("editModeBar").style.display = "none";
        document.getElementById("newAppointmentFields").style.display = "block";
        document.getElementById("btnMainAction").innerText = "üíñ Reservar Cita";
        document.getElementById("btnMainAction").className = "btn-main";
      }

      async function confirmarCita() {
        if (!selectedDate || !document.getElementById("fieldHora").value)
          return showAlert("Faltan Datos", "Selecciona fecha y hora.");
        const hora = document.getElementById("fieldHora").value;
        const svcName = document.getElementById("fieldServicio").value;
        const svcObj = globalServices.find((s) => s.nombre === svcName);
        const duration = svcObj ? svcObj.duracion_minutos || 60 : 60;
        const cleanTel = document
          .getElementById("fieldTelefono")
          .value.replace(/\D/g, "");
        const datos = {
          fecha: selectedDate,
          hora,
          nombre: document.getElementById("fieldNombre").value,
          correo: document.getElementById("fieldCorreo").value,
          telefono: cleanTel,
          servicio: document.getElementById("fieldServicio").value,
          user_id: userProfile.id,
          estado: "pendiente",
        };

        if (isRescheduling) {
          const { error } = await client
            .from("citas")
            .update({ fecha: selectedDate, hora: hora, estado: "reprogramada" })
            .eq("id", rescheduleId);
          if (error) showAlert("Error", error.message);
          else {
            lastCitaData = {
              ...rescheduleData,
              fecha: selectedDate,
              hora: hora,
            };
            document.getElementById("wspRescheduleModal").style.display =
              "flex";
            cancelRescheduleMode();
            loadAllAppointments();
          }
        } else {
          if (!document.getElementById("fieldTelefono").value)
            return showAlert("Faltan Datos", "Tel√©fono requerido.");
          const { error } = await client.from("citas").insert([datos]);
          if (error) showAlert("Error", error.message);
          else {
            lastCitaData = datos;
            document.getElementById("wspModal").style.display = "flex";

            // RESET ABSOLUTO AL AGENDAR
            selectedDate = null;
            document
              .querySelectorAll(".day")
              .forEach((e) => e.classList.remove("selected"));

            const s = document.getElementById("fieldServicio");
            s.value = "";
            s.disabled = true;
            s.innerHTML =
              '<option value="">1. Toca un d√≠a en el calendario üëÜ</option>';

            const h = document.getElementById("fieldHora");
            h.value = "";
            h.disabled = true;
            h.innerHTML =
              '<option value="">2. Luego selecciona servicio...</option>';
            document.getElementById("surchargeAlert").style.display = "none";

            renderCalendar();
          }
        }
      }

      function enviarWhatsAppCliente() {
        const serviceObj = globalServices.find(
          (s) => s.nombre === lastCitaData.servicio,
        );
        const finalPhrase =
          serviceObj && serviceObj.tipo === "diseno" ? msgDesign : msgBasic;
        const msg =
          `Hola NailsbyNiNa. Soy ${lastCitaData.nombre}.\n` +
          `Cita: ${formatDateText(lastCitaData.fecha)} ${format12h(lastCitaData.hora)}\n` +
          `Servicio: ${lastCitaData.servicio}\n` +
          finalPhrase;
        window.open(
          `https://wa.me/${miWhatsAppAdmin}?text=${encodeURIComponent(msg)}`,
          "_blank",
        );
        closeModal("wspModal");
        showTab("lista");
      }
      function enviarWhatsAppReprogramacion() {
        window.open(
          `https://wa.me/${miWhatsAppAdmin}?text=${encodeURIComponent(`Hola NailsbyNiNa. Soy ${lastCitaData.nombre}.\nHe reprogramado mi cita.\nNueva: ${formatDateText(lastCitaData.fecha)} ${format12h(lastCitaData.hora)}`)}`,
          "_blank",
        );
        closeModal("wspRescheduleModal");
        showTab("lista");
      }

      function openCancelModal(id, t, n, c, h) {
        pendingCancelId = id;
        pendingCancelData = { tel: t, name: n, isClient: c, hour: h };
        document.getElementById("cancelModal").style.display = "flex";
      }
      async function confirmCancelation() {
        const { error } = await client
          .from("citas")
          .delete()
          .eq("id", pendingCancelId);
        if (!error) {
          let rawTel = pendingCancelData.tel.replace(/\D/g, "");
          if (!rawTel.startsWith("57")) rawTel = "57" + rawTel;
          let msg = "";
          if (pendingCancelData.isClient) {
            msg = `Hola NailsbyNiNa. Cancelo cita de ${pendingCancelData.name}.`;
          } else {
            msg = `Hola! ¬øC√≥mo est√°s?\nHan pasado 20 minutos o m√°s desde la hora de tu cita, debido a esto, ser√° cancelada la cita que ten√≠as para el d√≠a de hoy a las ${format12h(pendingCancelData.hour)}\nSi deseas agendar un nuevo turno hazmelo saber para que juntas revisemos la agenda üíÖüèª`;
          }
          window.open(
            `https://wa.me/${pendingCancelData.isClient ? miWhatsAppAdmin : rawTel}?text=${encodeURIComponent(msg)}`,
            "_blank",
          );
          loadAllAppointments();
          closeModal("cancelModal");
        }
      }
      async function markArrived(id) {
        await client
          .from("citas")
          .update({ estado: "completada" })
          .eq("id", id);
        loadAllAppointments();
      }

      function switchListTab(tab) {
        document
          .querySelectorAll(".sub-tab-btn")
          .forEach((b) => b.classList.remove("active"));
        document.getElementById(`subtab-${tab}`).classList.add("active");
        if (tab === "upcoming") {
          document.getElementById("list-upcoming-container").style.display =
            "block";
          document.getElementById("list-history-container").style.display =
            "none";
        } else {
          document.getElementById("list-upcoming-container").style.display =
            "none";
          document.getElementById("list-history-container").style.display =
            "block";
        }
      }

      async function loadAllAppointments() {
        let q = client.from("citas").select("*");
        if (userProfile.role !== "admin") q = q.eq("user_id", userProfile.id);
        const { data } = await q
          .order("fecha", { ascending: false })
          .order("hora");

        const cUp = document.getElementById("list-upcoming-container");
        const cHist = document.getElementById("list-history-container");
        cUp.innerHTML = "";
        cHist.innerHTML = "";

        if (!data || !data.length) {
          cUp.innerHTML =
            "<p style='text-align:center;color:#aaa;margin-top:30px'>Sin citas.</p>";
          return;
        }

        const now = new Date();
        const upcomingData = [];
        const historyData = [];

        data.forEach((d) => {
          const apptTime = new Date(d.fecha + "T" + d.hora);
          const threshold = new Date(apptTime.getTime() + 20 * 60000);
          if (threshold < now || d.estado === "completada") historyData.push(d);
          else upcomingData.push(d);
        });

        upcomingData.sort(
          (a, b) =>
            new Date(a.fecha + "T" + a.hora) - new Date(b.fecha + "T" + b.hora),
        );

        const renderCard = (d, isPast) => {
          let rawTel = d.telefono.replace(/\D/g, "");
          if (!rawTel.startsWith("57")) rawTel = "57" + rawTel;
          const reminderMsg =
            `Hola ${d.nombre}!\n` +
            `Fecha: ${formatDateText(d.fecha)}.\n` +
            `Hora: ${format12h(d.hora)}\n` +
            `Lugar: Carrera 81d #68-03sur Bosa Palestina\n` +
            `Servicio: ${d.servicio}.\n\n` +
            `*Recuerda que tenemos 20 minutos de tolerancia si no llegas tu cita ser√° cancelada.`;

          let badgeClass = "status-pill";
          let badgeText = "Confirmada";
          if (d.estado === "reprogramada") {
            badgeClass += " repro";
            badgeText = "Reprogramada";
          } else if (d.estado === "completada") {
            badgeClass += " done";
            badgeText = "Completada";
          }
          if (isPast && d.estado !== "completada") {
            badgeClass += " late";
            badgeText = "Vencida (No Lleg√≥)";
          }

          let btns = "";
          if (!isPast && d.estado !== "completada") {
            btns =
              userProfile.role === "admin"
                ? `<div class="actions-row"><button class="btn-action btn-arrive" onclick="markArrived('${d.id}')">‚úÖ Lleg√≥</button><button class="btn-action btn-reschedule" style="background:var(--whatsapp);color:white" onclick="window.open('https://wa.me/${rawTel}?text=${encodeURIComponent(reminderMsg)}')">Recordar</button><button class="btn-action btn-cancel" onclick="openCancelModal('${d.id}','${d.telefono}','${d.nombre}',false, '${d.hora}')">Cancelar</button></div>`
                : `<div class="actions-row"><button class="btn-action btn-reschedule" onclick="startReschedule('${d.id}','${d.fecha}','${d.hora}','${d.servicio}','${d.nombre}','${d.telefono}')">Reprogramar</button><button class="btn-action btn-cancel" onclick="openCancelModal('${d.id}','${d.telefono}','${d.nombre}',true, '${d.hora}')">Cancelar</button></div>`;
          } else if (
            isPast &&
            d.estado !== "completada" &&
            userProfile.role === "admin"
          ) {
            btns = `<div class="actions-row"><button class="btn-action btn-notify-late" onclick="openCancelModal('${d.id}','${d.telefono}','${d.nombre}',false, '${d.hora}')">üì¢ Notificar Cancelaci√≥n</button></div>`;
          }

          const card = `<div class="appointment-card ${d.estado === "reprogramada" ? "reprogramada" : ""} ${d.estado === "completada" ? "completada" : ""} ${isPast && d.estado !== "completada" ? "vencida past" : isPast ? "past" : ""} animate-pop"><div class="${badgeClass}">${badgeText}</div><div style="font-size:1.1rem;font-weight:bold">${d.servicio}</div><div style="color:var(--primary);font-weight:bold;margin:5px 0">${formatDateText(d.fecha)} - ${format12h(d.hora)}</div><div style="font-size:0.9rem;color:#888">${d.nombre}</div>${userProfile.role === "admin" ? `<div style="background:#f9f9f9;padding:8px;border-radius:8px;margin-top:8px;font-size:0.8rem">üì± ${d.telefono}<br>üìß ${d.correo}</div>` : ""}${btns}</div>`;
          if (isPast || d.estado === "completada") return card;
          else return card;
        };

        if (upcomingData.length)
          upcomingData.forEach((d) => (cUp.innerHTML += renderCard(d, false)));
        else
          cUp.innerHTML =
            "<p style='text-align:center;color:#ccc;margin-top:20px'>No tienes citas pr√≥ximas.</p>";
        if (historyData.length)
          historyData.forEach((d) => (cHist.innerHTML += renderCard(d, true)));
        else
          cHist.innerHTML =
            "<p style='text-align:center;color:#ccc;margin-top:20px'>No hay historial reciente.</p>";
      }

      async function fetchSchedule() {
        const { data } = await client.from("horarios_base").select("*");
        if (data)
          data.forEach((i) => {
            if (!globalSchedule[i.dia]) globalSchedule[i.dia] = {};
            globalSchedule[i.dia].horas = i.horas;
            globalClosingTimes[i.dia] = i.hora_cierre || "20:00";
          });
      }
      function renderCalendar() {
        const grid = document.getElementById("calendarGrid");
        grid.innerHTML = "";
        ["Do", "Lu", "Ma", "Mi", "Ju", "Vi", "Sa"].forEach(
          (d) =>
            (grid.innerHTML += `<div style="font-size:0.8rem;text-align:center;color:var(--primary);font-weight:bold">${d}</div>`),
        );
        const y = viewDate.getFullYear(),
          m = viewDate.getMonth();
        document.getElementById("monthDisplay").innerText = new Date(
          y,
          m,
          1,
        ).toLocaleString("es-ES", { month: "long", year: "numeric" });
        const first = new Date(y, m, 1).getDay(),
          last = new Date(y, m + 1, 0).getDate(),
          today = new Date();
        today.setHours(0, 0, 0, 0);
        const maxDate = new Date();
        maxDate.setMonth(maxDate.getMonth() + 2);
        for (let i = 0; i < first; i++) grid.innerHTML += `<div></div>`;
        for (let i = 1; i <= last; i++) {
          const dStr = `${y}-${String(m + 1).padStart(2, "0")}-${String(i).padStart(2, "0")}`;
          const cDate = new Date(dStr + "T00:00:00");
          const d = document.createElement("div");
          d.className = "day";
          d.innerText = i;
          d.id = `day-${dStr}`;
          if (cDate < today || cDate > maxDate) d.classList.add("disabled");
          else {
            if (cDate.getTime() === today.getTime()) d.classList.add("today");
            d.onclick = () => {
              if (d.classList.contains("full"))
                return showAlert("Lo sentimos", "D√≠a completo o no laboral.");
              // BLOCK CHECK DAY
              if (d.classList.contains("blocked-day")) {
                showAlert("D√≠a Cerrado", "No hay servicio este d√≠a.");
                return;
              }

              document
                .querySelectorAll(".day")
                .forEach((e) => e.classList.remove("selected"));
              d.classList.add("selected");
              selectedDate = dStr;

              // RESET Y FEEDBACK VISUAL
              const s = document.getElementById("fieldServicio");
              s.disabled = false;
              s.classList.add("highlight-input");
              setTimeout(() => s.classList.remove("highlight-input"), 500);
              s.selectedIndex = 0;

              const h = document.getElementById("fieldHora");
              h.innerHTML =
                '<option value="">Luego selecciona servicio...</option>';
              h.disabled = true;
              document.getElementById("surchargeAlert").style.display = "none";

              // UPDATE AVAILABLE SERVICES FOR THIS DAY
              updateServiceAvailability(dStr);
            };
          }
          grid.appendChild(d);
        }

        // CALL NEW MASSIVE UPDATE FUNCTION
        updateFullDays(y, m, last);
      }

      function moveMonth(v) {
        const nextDate = new Date(viewDate);
        nextDate.setMonth(nextDate.getMonth() + v);
        const today = new Date();
        const maxDate = new Date();
        maxDate.setMonth(maxDate.getMonth() + 2);
        if (v > 0 && nextDate > maxDate) return;
        if (
          v < 0 &&
          nextDate < new Date(today.getFullYear(), today.getMonth(), 1)
        )
          return;
        viewDate.setMonth(viewDate.getMonth() + v);
        renderCalendar();
      }

      // NUEVA FUNCION INTELIGENTE: UPDATE FULL DAYS MASIVO
      async function updateFullDays(y, m, last) {
        // 1. OBTENER RANGO MES
        const s = `${y}-${String(m + 1).padStart(2, "0")}-01`;
        const e = `${y}-${String(m + 1).padStart(2, "0")}-${last}`;

        // 2. FETCH MASIVO
        const { data: c } = await client
          .from("citas")
          .select("fecha,hora,servicio")
          .gte("fecha", s)
          .lte("fecha", e);
        const { data: b } = await client
          .from("bloqueos")
          .select("fecha,hora_inicio,hora_fin")
          .gte("fecha", s)
          .lte("fecha", e);

        // 3. CALCULAR MINIMA DURACION DE SERVICIO (O 60 POR DEFECTO)
        let minServiceDuration = 60;
        if (globalServices.length > 0) {
          minServiceDuration = Math.min(
            ...globalServices.map((svc) => svc.duracion_minutos || 60),
          );
        }

        // 4. ITERAR DIAS DEL MES
        for (let i = 1; i <= last; i++) {
          const dStr = `${y}-${String(m + 1).padStart(2, "0")}-${String(i).padStart(2, "0")}`;
          const el = document.getElementById(`day-${dStr}`);
          if (!el || el.classList.contains("disabled")) continue;

          // A. DIA CERRADO ADMIN?
          const isBlockedDay = b.some(
            (x) => x.fecha === dStr && x.hora_inicio === null,
          );
          if (isBlockedDay) {
            el.classList.add("blocked-day");
            continue;
          }

          // B. ANALIZAR SI CABE EL SERVICIO MAS CORTO
          const dw = new Date(dStr + "T00:00:00").getDay();
          const base = globalSchedule[dw] ? globalSchedule[dw].horas : [];

          if (!base.length) {
            el.classList.add("full");
            continue;
          } // Si no hay horario base, dia cerrado

          const closingStr = globalClosingTimes[dw] || "20:00";
          const closingMins = timeToMins(closingStr);

          // Filtrar eventos de este dia
          const dayCitas = c.filter((x) => x.fecha === dStr);
          const dayBlocks = b.filter(
            (x) => x.fecha === dStr && x.hora_inicio !== null,
          );

          // Calcular Rangos Ocupados
          let busyRanges = [];
          dayCitas.forEach((appt) => {
            const s = globalServices.find((x) => x.nombre === appt.servicio);
            const dur = s ? s.duracion_minutos || 60 : 60;
            const start = timeToMins(appt.hora);
            const end = start + dur; // **SIN BUFFER 30 MIN**
            busyRanges.push({ start, end });
          });
          dayBlocks.forEach((bk) => {
            const start = timeToMins(bk.hora_inicio);
            const end = timeToMins(bk.hora_fin);
            busyRanges.push({ start, end });
          });

          // Generar posibles inicios (Base + Fin de citas)
          let candidateStartTimes = new Set();
          base.forEach((h) => candidateStartTimes.add(timeToMins(h)));
          busyRanges.forEach((r) => {
            // Si termina antes del cierre, podria empezar una cita ahi
            if (r.end < closingMins) candidateStartTimes.add(r.end);
          });

          // C. PROBAR SI CABE "MIN_DURATION" EN ALGUNO
          let isFull = true;
          for (let startMins of candidateStartTimes) {
            // Solo probar si coincide con un slot base o generado valido (simplificado: si esta en rango operativo)
            // El inicio debe ser validado contra cierre
            const endMins = startMins + minServiceDuration; // **SIN BUFFER 30 MIN**

            // Strict Check: Can fit min service before closing?
            if (endMins > closingMins) continue; // Logic fixed: endMins > closingMins (was start + min > closing)

            // Check Collision
            let collision = false;
            for (let r of busyRanges) {
              if (startMins < r.end && endMins > r.start) {
                // **SIN BUFFER 30 MIN**
                collision = true;
                break;
              }
            }

            if (!collision) {
              isFull = false; // Found a spot!
              break;
            }
          }

          if (isFull) el.classList.add("full");
        }
      }

      function enableTimeSelector() {
        const svc = document.getElementById("fieldServicio").value;
        const h = document.getElementById("fieldHora");
        if (svc && selectedDate) {
          h.disabled = false;
          h.classList.add("highlight-input");
          setTimeout(() => h.classList.remove("highlight-input"), 500);
          checkHoras(selectedDate);
        } else {
          h.disabled = true;
          h.innerHTML =
            '<option value="">Luego selecciona servicio...</option>';
        }
      }

      // NUEVO: FILTRAR SERVICIOS POR HUECOS DISPONIBLES
      async function updateServiceAvailability(f) {
        const s = document.getElementById("fieldServicio");

        // 1. RE-POPULATE SERVICES FROM GLOBAL
        s.innerHTML = "";
        s.add(new Option("Selecciona servicio...", ""));

        const dw = new Date(f + "T00:00:00").getDay();
        let base = globalSchedule[dw]
          ? [...globalSchedule[dw].horas].sort()
          : [];
        const closingStr = globalClosingTimes[dw] || "20:00";
        const closingMins = timeToMins(closingStr);

        const { data: c } = await client
          .from("citas")
          .select("hora, servicio")
          .eq("fecha", f);
        const { data: b } = await client
          .from("bloqueos")
          .select("hora_inicio, hora_fin")
          .eq("fecha", f);

        // CALCULAR OCUPACION
        let busyRanges = [];
        if (c)
          c.forEach((appt) => {
            const svc = globalServices.find((x) => x.nombre === appt.servicio);
            const dur = svc ? svc.duracion_minutos || 60 : 60;
            const start = timeToMins(appt.hora);
            const end = start + dur; // SIN BUFFER
            busyRanges.push({ start, end });
          });
        if (b)
          b.forEach((bk) => {
            if (bk.hora_inicio) {
              const start = timeToMins(bk.hora_inicio);
              const end = timeToMins(bk.hora_fin);
              busyRanges.push({ start, end });
            }
          });

        // GENERAR CANDIDATOS
        let candidateSlots = new Set(base);
        busyRanges.forEach((range) => {
          if (range.end < closingMins)
            candidateSlots.add(minsToTime(range.end));
        });
        let availableSlots = Array.from(candidateSlots).sort();

        const isToday =
          new Date(f + "T00:00:00").toDateString() ===
          new Date().toDateString();
        const nowMins = new Date().getHours() * 60 + new Date().getMinutes();

        // 2. LOOP & VERIFY
        globalServices.forEach((svc) => {
          let reqDur = svc.duracion_minutos || 60;
          let fitsAnywhere = false;

          for (let h of availableSlots) {
            const startMins = timeToMins(h);
            const endMins = startMins + reqDur; // SIN BUFFER

            if (isToday && startMins <= nowMins) continue;
            if (endMins > closingMins) continue; // Check strict closing fit

            let collision = false;
            for (let r of busyRanges) {
              // Overlap check
              if (startMins < r.end && endMins > r.start) {
                collision = true;
                break;
              }
            }

            if (!collision) {
              fitsAnywhere = true;
              break;
            }
          }

          let opt = document.createElement("option");
          opt.value = svc.nombre;

          if (!fitsAnywhere) {
            opt.disabled = true;
            opt.innerText = `üö´ ${svc.nombre} (No cabe hoy)`;
          } else {
            opt.disabled = false;
            opt.innerText = svc.nombre;
          }
          s.add(opt);
        });

        // SI NO HAY NADA DISPONIBLE, MARCAR DIA COMO FULL EN ROJO
        // (Aunque updateFullDays ya lo hace, esto es un refuerzo visual si el usuario ya esta dentro)
      }

      async function checkHoras(f) {
        const dw = new Date(f + "T00:00:00").getDay();
        let base = globalSchedule[dw]
          ? [...globalSchedule[dw].horas].sort()
          : [];
        const closingStr = globalClosingTimes[dw] || "20:00";
        const closingMins = timeToMins(closingStr);
        const { data: c } = await client
          .from("citas")
          .select("hora, servicio")
          .eq("fecha", f);
        const { data: b } = await client
          .from("bloqueos")
          .select("hora_inicio, hora_fin")
          .eq("fecha", f);

        const svcName = document.getElementById("fieldServicio").value;
        const svcObj = globalServices.find((s) => s.nombre === svcName);
        const reqDuration = svcObj ? svcObj.duracion_minutos || 60 : 60;

        const s = document.getElementById("fieldHora");
        s.innerHTML = "";
        const isToday =
          new Date(f + "T00:00:00").toDateString() ===
          new Date().toDateString();
        const nowMins = new Date().getHours() * 60 + new Date().getMinutes();

        let busyRanges = [];
        const explicitBlocks = [];

        if (c && c.length > 0) {
          c.forEach((appt) => {
            const s = globalServices.find((x) => x.nombre === appt.servicio);
            const dur = s ? s.duracion_minutos || 60 : 60;
            const start = timeToMins(appt.hora);
            const end = start + dur; // **SIN BUFFER 30 MIN**
            busyRanges.push({ start, end });
          });
        }
        if (b && b.length > 0) {
          b.forEach((bk) => {
            if (bk.hora_inicio) {
              const start = timeToMins(bk.hora_inicio);
              const end = timeToMins(bk.hora_fin);
              busyRanges.push({ start, end });
            }
          });
        }

        let candidateSlots = new Set(base);
        busyRanges.forEach((range) => {
          if (range.end < closingMins)
            candidateSlots.add(minsToTime(range.end));
        });

        let availableList = Array.from(candidateSlots).sort();
        let any = false;

        if (!availableList.length) {
          s.add(new Option("No disponible", ""));
          s.disabled = true;
          return;
        }
        s.add(new Option("Selecciona hora...", ""));

        availableList.forEach((h) => {
          const startMins = timeToMins(h);
          const endMins = startMins + reqDuration; // **SIN BUFFER 30 MIN**

          if (isToday && startMins <= nowMins) {
            const opt = document.createElement("option");
            opt.value = h;
            opt.text = format12h(h) + " (Pasada)";
            opt.disabled = true;
            s.appendChild(opt);
            return;
          }

          if (endMins > closingMins) {
            return;
          }

          let collision = false;
          for (let r of busyRanges) {
            if (startMins < r.end && endMins > r.start) {
              collision = true;
              break;
            } // **SIN BUFFER 30 MIN**
          }

          // HIDE IF INSIDE ADMIN BLOCK
          let isAdminBlocked = false;
          if (b) {
            for (let bk of b) {
              if (bk.hora_inicio) {
                const bS = timeToMins(bk.hora_inicio);
                const bE = timeToMins(bk.hora_fin);
                if (startMins >= bS && startMins < bE) {
                  isAdminBlocked = true;
                  break;
                }
              }
            }
          }
          if (isAdminBlocked) return;

          if (!collision) {
            const opt = document.createElement("option");
            opt.value = h;
            opt.text = format12h(h);
            any = true;
            s.appendChild(opt);
          } else {
            if (base.includes(h)) {
              const opt = document.createElement("option");
              opt.value = h;
              opt.text = format12h(h) + " (Ocupado)";
              opt.disabled = true;
              s.appendChild(opt);
            }
          }
        });

        if (!any) {
          s.innerHTML = "";
          s.add(new Option("Lleno", ""));
          s.disabled = true;
        } else {
          s.disabled = false;
        }
      }

      initApp();
    </script>
  </body>
</html>
