<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>NailsbyNiNa - App</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
      :root {
        --primary: #ff1493;
        --primary-glow: 0 0 10px rgba(255, 20, 147, 0.4);
        --bg: #fff0f5;
        --card-bg: #ffffff;
        --text: #4a148c;
        --text-light: #888;
        --whatsapp: #25d366;
        --danger: #ff3366;
        --info: #00bfff;
        --success: #00e676;
        --radius: 20px;
      }
      body {
        font-family: "Segoe UI", sans-serif;
        background: var(--bg);
        margin: 0;
        color: var(--text);
        padding: 15px;
        -webkit-tap-highlight-color: transparent;
        overscroll-behavior-y: none;
      }
      @keyframes popIn {
        0% {
          opacity: 0;
          transform: scale(0.98);
        }
        100% {
          opacity: 1;
          transform: scale(1);
        }
      }
      .animate-pop {
        animation: popIn 0.3s ease-out;
      }

      /* MODALES */
      .modal-overlay {
        display: none;
        position: fixed;
        z-index: 3000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(5px);
        align-items: center;
        justify-content: center;
      }
      .modal-content {
        background: white;
        padding: 30px;
        border-radius: var(--radius);
        width: 85%;
        max-width: 340px;
        text-align: center;
        box-shadow: 0 20px 60px rgba(255, 20, 147, 0.15);
        border: 1px solid rgba(255, 20, 147, 0.1);
        animation: popIn 0.3s ease-out;
      }
      .modal-icon {
        font-size: 3.5rem;
        margin-bottom: 15px;
        display: block;
      }
      .modal-btn-row {
        display: flex;
        gap: 12px;
        margin-top: 25px;
      }
      .btn-modal {
        flex: 1;
        padding: 14px;
        border: none;
        border-radius: 12px;
        font-weight: 600;
        cursor: pointer;
        font-size: 0.95rem;
        transition: transform 0.2s;
      }
      .btn-modal:active {
        transform: scale(0.95);
      }
      .btn-modal.primary {
        background: var(--primary);
        color: white;
        box-shadow: var(--primary-glow);
      }
      .btn-modal.secondary {
        background: #f0f0f0;
        color: #666;
      }
      .btn-modal.whatsapp {
        background: var(--whatsapp);
        color: white;
      }
      .btn-modal.danger {
        background: var(--danger);
        color: white;
      }

      /* LAYOUT */
      #auth-screen,
      #app-screen,
      #recovery-screen {
        display: none;
        max-width: 800px;
        margin: 0 auto;
        background: var(--card-bg);
        border-radius: var(--radius);
        overflow: hidden;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.03);
        min-height: 85vh;
      }
      #auth-screen,
      #recovery-screen {
        display: block;
        max-width: 400px;
        margin-top: 40px;
        padding: 40px 30px;
        border: 2px solid #ffe6f2;
        min-height: auto;
      }
      #recovery-screen {
        display: none;
      }

      /* CABECERA CON PERFIL */
      .nav-header {
        background: white;
        color: var(--primary);
        padding: 15px 25px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid #ffe6f2;
      }
      .brand-title {
        font-size: 1.2rem;
        font-weight: 800;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      /* EL CIRCULITO DE PERFIL */
      .header-avatar {
        width: 42px;
        height: 42px;
        border-radius: 50%;
        background: var(--primary);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 0.9rem;
        cursor: pointer;
        border: 2px solid #ffcce6;
        transition: transform 0.2s;
        box-shadow: 0 4px 10px rgba(255, 20, 147, 0.2);
      }
      .header-avatar:active {
        transform: scale(0.9);
      }

      /* TABS */
      .tabs {
        display: flex;
        background: white;
        padding: 5px;
        border-bottom: 1px solid #f8f8f8;
      }
      .tab-btn {
        flex: 1;
        padding: 15px;
        border: none;
        background: none;
        cursor: pointer;
        font-weight: 600;
        color: #bbb;
        position: relative;
        transition: color 0.3s;
      }
      .tab-btn.active {
        color: var(--primary);
      }
      .tab-btn.active::after {
        content: "";
        position: absolute;
        bottom: 5px;
        left: 50%;
        transform: translateX(-50%);
        width: 6px;
        height: 6px;
        background: var(--primary);
        border-radius: 50%;
        box-shadow: var(--primary-glow);
      }

      /* COMPONENTES */
      .cal-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 8px;
        margin-top: 15px;
      }
      .day {
        aspect-ratio: 1/1;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 14px;
        cursor: pointer;
        font-size: 0.9rem;
        background: #fff;
        border: 1px solid transparent;
        color: #555;
      }
      .day.today {
        border-color: var(--primary);
        color: var(--primary);
        font-weight: 700;
      }
      .day.selected {
        background: var(--primary) !important;
        color: white !important;
        font-weight: bold;
      }
      .day.full {
        background: #f8f8f8;
        color: #ddd;
        text-decoration: line-through;
        pointer-events: none;
      }
      .day.disabled {
        opacity: 0.3;
        pointer-events: none;
      }

      .main-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 30px;
        padding: 25px;
      }
      @media (min-width: 768px) {
        .main-grid {
          grid-template-columns: 1fr 350px;
        }
      }
      input,
      select {
        width: 100%;
        padding: 16px;
        margin: 8px 0;
        border: 2px solid #f0f0f0;
        border-radius: 16px;
        box-sizing: border-box;
        background: #fbfbfb;
        font-size: 1rem;
        color: #333;
      }
      input:focus,
      select:focus {
        outline: none;
        border-color: var(--primary);
        background: white;
      }

      .password-wrapper {
        position: relative;
        width: 100%;
        margin: 8px 0;
      }
      .password-wrapper input {
        margin: 0;
        padding-right: 45px;
      }
      .toggle-eye {
        position: absolute;
        right: 15px;
        top: 50%;
        transform: translateY(-50%);
        cursor: pointer;
        font-size: 1.2rem;
        color: #bbb;
        z-index: 10;
      }

      .btn-main {
        background: var(--primary);
        color: white;
        border: none;
        padding: 18px;
        width: 100%;
        border-radius: 16px;
        cursor: pointer;
        font-weight: 700;
        font-size: 1.05rem;
        margin-top: 15px;
        box-shadow: var(--primary-glow);
      }
      .btn-main.reschedule-mode {
        background: var(--info);
        box-shadow: 0 0 15px rgba(0, 191, 255, 0.4);
      }

      .appointment-card {
        background: white;
        border: 1px solid #f0f0f0;
        padding: 20px;
        border-radius: 18px;
        margin-bottom: 20px;
        position: relative;
        overflow: hidden;
      }
      .appointment-card::before {
        content: "";
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 5px;
        background: var(--primary);
      }
      .appointment-card.reprogramada::before {
        background: var(--info);
      }
      .status-pill {
        display: inline-block;
        font-size: 0.7rem;
        padding: 4px 10px;
        border-radius: 20px;
        background: #f0f0f0;
        color: #666;
        margin-bottom: 8px;
        font-weight: 600;
      }
      .status-pill.repro {
        background: rgba(0, 191, 255, 0.1);
        color: var(--info);
        border: 1px solid var(--info);
      }
      .actions-row {
        display: flex;
        gap: 10px;
        margin-top: 15px;
      }
      .btn-action {
        border: none;
        padding: 10px;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 600;
        font-size: 0.85rem;
        flex: 1;
      }
      .btn-reschedule {
        background: #eeffff;
        color: var(--info);
      }
      .btn-cancel {
        background: #fff5f5;
        color: var(--danger);
      }

      /* ADMIN - DISTRIBUCI√ìN */
      .admin-control-panel {
        padding: 20px;
        background: white;
      }
      .week-selector {
        display: flex;
        justify-content: center;
        gap: 5px;
        margin-bottom: 15px;
        flex-wrap: wrap;
      }
      .day-chip {
        width: 45px;
        height: 45px;
        border-radius: 12px;
        background: #f5f5f5;
        color: #aaa;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        cursor: pointer;
        transition: 0.2s;
      }
      .day-chip.active {
        background: var(--primary);
        color: white;
        transform: translateY(-2px);
        box-shadow: var(--primary-glow);
      }
      .hours-editor-box {
        background: #fffbfd;
        padding: 20px;
        border-radius: 15px;
        border: 1px dashed var(--primary);
        margin-bottom: 20px;
      }
      .hour-tag {
        display: inline-block;
        background: var(--primary);
        color: white;
        padding: 6px 12px;
        border-radius: 20px;
        margin: 4px;
        font-size: 0.85rem;
      }
      .service-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: #f9f9f9;
        padding: 15px;
        border-radius: 12px;
        margin-bottom: 8px;
        border: 1px solid #eee;
      }
      .btn-delete-svc {
        background: #ffebee;
        color: var(--danger);
        border: none;
        padding: 8px 12px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
        font-size: 0.8rem;
      }
      .add-row {
        display: flex;
        gap: 10px;
        align-items: center;
        margin-top: 15px;
      }
      .add-row input {
        margin: 0;
        flex: 1;
      }
      .add-row button {
        width: auto;
        margin: 0;
        padding: 0 20px;
        height: 56px;
      }

      /* PERFIL ESTILIZADO */
      .profile-header-large {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin-bottom: 30px;
      }
      .avatar-large {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--primary), #ff80bf);
        color: white;
        font-size: 2.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 15px;
        border: 4px solid white;
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
      }
      #editModeBar {
        background: var(--info);
        color: white;
        padding: 12px;
        text-align: center;
        font-weight: bold;
        display: none;
        justify-content: space-between;
        align-items: center;
        border-radius: 0 0 15px 15px;
        margin-bottom: 15px;
      }
    </style>
  </head>
  <body>
    <div id="generalModal" class="modal-overlay">
      <div class="modal-content">
        <div class="modal-icon" id="genIcon">‚ú®</div>
        <h3 id="genTitle" style="color: var(--primary); margin: 0"></h3>
        <p id="genMsg" style="color: #666; margin: 15px 0 25px"></p>
        <button class="btn-main" onclick="closeModal('generalModal')">
          Entendido
        </button>
      </div>
    </div>

    <div id="resetModal" class="modal-overlay">
      <div class="modal-content">
        <div class="modal-icon">üìß</div>
        <h3 style="color: var(--primary); margin: 0">Recuperar Cuenta</h3>
        <p style="color: #666; margin: 10px 0">
          Te enviaremos un enlace m√°gico.
        </p>
        <input
          type="email"
          id="resetEmailInput"
          placeholder="tucorreo@ejemplo.com"
        />
        <div class="modal-btn-row">
          <button
            class="btn-modal secondary"
            onclick="closeModal('resetModal')"
          >
            Cancelar
          </button>
          <button class="btn-modal primary" onclick="sendResetEmail()">
            Enviar
          </button>
        </div>
      </div>
    </div>

    <div id="cancelModal" class="modal-overlay">
      <div class="modal-content">
        <div class="modal-icon">üíî</div>
        <h3 style="color: var(--text); margin: 0">¬øCancelar?</h3>
        <p style="color: #888">Esta acci√≥n libera el espacio.</p>
        <div class="modal-btn-row">
          <button
            class="btn-modal secondary"
            onclick="closeModal('cancelModal')"
          >
            Volver
          </button>
          <button class="btn-modal danger" onclick="confirmCancelation()">
            S√≠, Cancelar
          </button>
        </div>
      </div>
    </div>

    <div id="wspModal" class="modal-overlay">
      <div class="modal-content">
        <div class="modal-icon">üíÖ</div>
        <h2 style="color: var(--primary); margin: 0">¬°Casi Listo!</h2>
        <p style="color: #666">Env√≠a tu comprobante para confirmar.</p>
        <button class="btn-modal whatsapp" onclick="enviarWhatsAppCliente()">
          Enviar Comprobante
        </button>
      </div>
    </div>

    <div id="wspRescheduleModal" class="modal-overlay">
      <div class="modal-content">
        <div class="modal-icon">üîÑ</div>
        <h2 style="color: var(--info); margin: 0">Cambio Listo</h2>
        <p style="color: #666">Notifica tu nueva fecha.</p>
        <button
          class="btn-modal whatsapp"
          onclick="enviarWhatsAppReprogramacion()"
        >
          Confirmar
        </button>
      </div>
    </div>

    <div id="recovery-screen" class="animate-pop">
      <h1 style="text-align: center; color: var(--primary); margin-top: 20%">
        Restablecer
      </h1>
      <p id="recoveryStatus" style="text-align: center; color: #666">
        Verificando enlace...
      </p>
      <div id="recoveryForm" style="display: none; padding: 20px">
        <div class="password-wrapper">
          <input
            type="password"
            id="recoveryPass"
            placeholder="Nueva contrase√±a (m√≠n 6)"
          /><span
            class="toggle-eye"
            onclick="togglePassword('recoveryPass', this)"
            >üëÅÔ∏è</span
          >
        </div>
        <button class="btn-main" onclick="finalizeRecovery()">
          Guardar Clave
        </button>
      </div>
    </div>

    <div id="auth-screen" class="animate-pop">
      <h1 style="text-align: center; color: var(--primary)">NailsbyNiNa</h1>
      <p style="text-align: center; color: #aaa; margin-bottom: 30px">
        Agenda tu momento de brillo ‚ú®
      </p>
      <div id="login-form">
        <input type="email" id="loginEmail" placeholder="Tu Correo" />
        <div class="password-wrapper">
          <input type="password" id="loginPass" placeholder="Contrase√±a" /><span
            class="toggle-eye"
            onclick="togglePassword('loginPass', this)"
            >üëÅÔ∏è</span
          >
        </div>
        <button class="btn-main" onclick="handleAuth('login')">
          Ingresar üíñ
        </button>
        <p style="text-align: center; margin-top: 15px">
          <a
            href="#"
            onclick="openResetModal()"
            style="color: var(--info); text-decoration: none; font-size: 0.9rem"
            >¬øOlvidaste tu contrase√±a?</a
          >
        </p>
        <p
          style="
            text-align: center;
            margin-top: 25px;
            color: #888;
            font-size: 0.9rem;
          "
        >
          ¬øNueva?
          <a
            href="#"
            onclick="toggleAuth(false)"
            style="
              color: var(--primary);
              font-weight: bold;
              text-decoration: none;
            "
            >Crear cuenta</a
          >
        </p>
      </div>
      <div id="signup-form" style="display: none">
        <input type="text" id="regNombre" placeholder="Nombre Completo" />
        <input type="email" id="regEmail" placeholder="Tu Correo" />
        <div class="password-wrapper">
          <input
            type="password"
            id="regPass"
            placeholder="Contrase√±a (m√≠n 6)"
          /><span class="toggle-eye" onclick="togglePassword('regPass', this)"
            >üëÅÔ∏è</span
          >
        </div>
        <div class="password-wrapper">
          <input
            type="password"
            id="regPassConfirm"
            placeholder="Confirmar Contrase√±a"
          /><span
            class="toggle-eye"
            onclick="togglePassword('regPassConfirm', this)"
            >üëÅÔ∏è</span
          >
        </div>
        <button class="btn-main" onclick="handleAuth('signup')">
          Registrarme ‚ú®
        </button>
        <p style="text-align: center; margin-top: 25px">
          <a
            href="#"
            onclick="toggleAuth(true)"
            style="
              color: var(--primary);
              font-weight: bold;
              text-decoration: none;
            "
            >Ya tengo cuenta</a
          >
        </p>
      </div>
    </div>

    <div id="app-screen" class="animate-pop">
      <div class="nav-header">
        <div class="brand-title">
          üíÖ NailsbyNiNa
          <span
            id="adminBadge"
            style="
              display: none;
              font-size: 0.6rem;
              background: var(--text);
              color: white;
              padding: 2px 5px;
              border-radius: 4px;
              margin-left: 5px;
            "
            >ADMIN</span
          >
        </div>
        <div
          class="header-avatar"
          id="headerAvatar"
          onclick="showTab('perfil')"
        >
          NN
        </div>
      </div>

      <div id="editModeBar">
        <span>üîÑ MODO REPROGRAMACI√ìN</span>
        <button
          onclick="cancelRescheduleMode()"
          style="
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 5px 10px;
            border-radius: 8px;
          "
        >
          Cancelar
        </button>
      </div>

      <div class="tabs">
        <button
          id="tab-agenda"
          class="tab-btn active"
          onclick="showTab('agenda')"
        >
          Agendar
        </button>
        <button id="tab-lista" class="tab-btn" onclick="showTab('lista')">
          Mis Citas
        </button>
        <button
          id="tab-config"
          class="tab-btn"
          onclick="showTab('config')"
          style="display: none"
        >
          Admin
        </button>
      </div>

      <div id="view-agenda" class="main-grid animate-pop">
        <div>
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: 10px;
            "
          >
            <button
              onclick="moveMonth(-1)"
              style="
                border: none;
                background: white;
                width: 35px;
                height: 35px;
                border-radius: 50%;
                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
                color: var(--primary);
                font-weight: bold;
              "
            >
              ‚óÄ
            </button>
            <b
              id="monthDisplay"
              style="
                text-transform: capitalize;
                color: var(--text);
                font-size: 1.1rem;
              "
            ></b>
            <button
              onclick="moveMonth(1)"
              style="
                border: none;
                background: white;
                width: 35px;
                height: 35px;
                border-radius: 50%;
                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
                color: var(--primary);
                font-weight: bold;
              "
            >
              ‚ñ∂
            </button>
          </div>
          <div class="cal-grid" id="calendarGrid"></div>
        </div>
        <div class="form-section">
          <h3 style="color: var(--primary); margin: 0 0 15px">Detalles</h3>
          <div id="newAppointmentFields">
            <input type="text" id="fieldNombre" placeholder="Nombre" />
            <input type="email" id="fieldCorreo" placeholder="Correo" />
            <input
              type="tel"
              id="fieldTelefono"
              placeholder="WhatsApp (Sin +57)"
              pattern="[0-9]*"
              oninput="this.value = this.value.replace(/[^0-9]/g, '')"
            />
            <select id="fieldServicio">
              <option>Cargando servicios...</option>
            </select>
          </div>
          <select id="fieldHora">
            <option value="">Selecciona d√≠a...</option>
          </select>

          <button id="btnMainAction" class="btn-main" onclick="confirmarCita()">
            üíñ Reservar Cita
          </button>
        </div>
      </div>

      <div
        id="view-lista"
        style="display: none; padding: 20px"
        class="animate-pop"
      >
        <div id="tablaCitasContainer"></div>
      </div>

      <div
        id="view-config"
        class="admin-control-panel animate-pop"
        style="display: none"
      >
        <h3 style="color: var(--primary); margin-top: 0">Servicios</h3>
        <div
          style="
            background: #f9f9f9;
            padding: 15px;
            border-radius: 15px;
            border: 1px dashed #ddd;
            margin-bottom: 20px;
          "
        >
          <div id="adminServicesList"></div>
          <div class="add-row">
            <input
              type="text"
              id="newServiceInput"
              placeholder="Nuevo servicio..."
            />
            <button
              class="btn-main"
              style="background: var(--success)"
              onclick="addService()"
            >
              +
            </button>
          </div>
        </div>

        <h3 style="text-align: center; color: var(--primary)">
          Horario Semanal
        </h3>
        <div class="week-selector">
          <div class="day-chip" id="d1" onclick="toggleWeekDay(1)">Lu</div>
          <div class="day-chip" id="d2" onclick="toggleWeekDay(2)">Ma</div>
          <div class="day-chip" id="d3" onclick="toggleWeekDay(3)">Mi</div>
          <div class="day-chip" id="d4" onclick="toggleWeekDay(4)">Ju</div>
          <div class="day-chip" id="d5" onclick="toggleWeekDay(5)">Vi</div>
          <div class="day-chip" id="d6" onclick="toggleWeekDay(6)">Sa</div>
          <div class="day-chip" id="d0" onclick="toggleWeekDay(0)">Do</div>
        </div>
        <div id="hoursEditor" class="hours-editor-box" style="display: none">
          <div id="weeklyHours" style="margin-bottom: 10px"></div>
          <div class="add-row">
            <input type="time" id="newHourInput" />
            <button class="btn-main" onclick="addStagedHour()">+</button>
          </div>
          <button
            class="btn-main"
            style="background: var(--whatsapp); margin-top: 10px"
            onclick="saveWeekSchedule()"
          >
            Guardar Horario
          </button>
        </div>

        <h3 style="text-align: center; color: var(--primary); margin-top: 30px">
          Bloquear Fecha
        </h3>
        <input
          type="date"
          id="adminDateInput"
          onchange="loadAdminDayConfig()"
        />
        <div id="adminPanelControls" style="display: none; margin-top: 15px">
          <button
            id="btnToggleDay"
            onclick="toggleFullDayBlock()"
            class="btn-main"
            style="background: #888"
          >
            CERRAR D√çA
          </button>
          <div
            id="adminHourGrid"
            style="
              display: grid;
              grid-template-columns: repeat(3, 1fr);
              gap: 8px;
              margin-top: 15px;
            "
          ></div>
        </div>
      </div>

      <div
        id="view-perfil"
        style="display: none; padding: 20px"
        class="animate-pop"
      >
        <div class="profile-header-large">
          <div class="avatar-large" id="profileAvatarLarge">NN</div>
          <h2 style="margin: 0; color: var(--text)" id="displayProfileName">
            Usuario
          </h2>
          <p style="color: #aaa; margin: 5px" id="displayProfileEmail">...</p>
        </div>

        <div
          style="
            background: white;
            padding: 20px;
            border-radius: 20px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
          "
        >
          <h4 style="margin-top: 0">Editar Nombre</h4>
          <div class="add-row">
            <input type="text" id="profileNameInput" />
            <button
              class="btn-main"
              style="padding: 0 20px"
              onclick="updateProfileName()"
            >
              üíæ
            </button>
          </div>
        </div>

        <button
          class="btn-main"
          style="
            background: white;
            border: 2px dashed var(--primary);
            color: var(--primary);
            margin-bottom: 20px;
          "
          onclick="togglePassForm()"
        >
          üîí Cambiar Contrase√±a
        </button>

        <div
          id="profilePassForm"
          style="
            display: none;
            background: white;
            padding: 20px;
            border-radius: 20px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
          "
        >
          <h4 style="margin-top: 0">Nueva Contrase√±a</h4>
          <div class="password-wrapper">
            <input
              type="password"
              id="currentPassProfile"
              placeholder="Actual"
            /><span
              class="toggle-eye"
              onclick="togglePassword('currentPassProfile', this)"
              >üëÅÔ∏è</span
            >
          </div>
          <div class="password-wrapper">
            <input
              type="password"
              id="newPassProfile"
              placeholder="Nueva (min 6)"
            /><span
              class="toggle-eye"
              onclick="togglePassword('newPassProfile', this)"
              >üëÅÔ∏è</span
            >
          </div>
          <div class="password-wrapper">
            <input
              type="password"
              id="confirmPassProfile"
              placeholder="Confirmar"
            /><span
              class="toggle-eye"
              onclick="togglePassword('confirmPassProfile', this)"
              >üëÅÔ∏è</span
            >
          </div>
          <button
            class="btn-main"
            style="margin-top: 10px; background: var(--info)"
            onclick="updatePassword()"
          >
            Actualizar
          </button>
        </div>

        <button
          onclick="logout()"
          style="
            width: 100%;
            padding: 15px;
            border: 1px solid #eee;
            background: white;
            color: var(--danger);
            border-radius: 16px;
            font-weight: bold;
            cursor: pointer;
          "
        >
          Cerrar Sesi√≥n
        </button>
      </div>
    </div>

    <script>
      const sbUrl = "https://jifwtgpchbipxyriirtq.supabase.co";
      const sbKey = "sb_publishable_zF5mj6Ba61zibU_19vnFPQ_a4GDaKwi";
      const client = supabase.createClient(sbUrl, sbKey);
      const miWhatsAppAdmin = "573228211246";

      let userProfile = null,
        currentUserEmail = "",
        globalSchedule = {},
        globalServices = [],
        selectedWeekDays = [],
        stagedHours = [],
        viewDate = new Date(),
        selectedDate = null,
        lastCitaData = null,
        isRescheduling = false,
        rescheduleId = null,
        rescheduleData = null,
        pendingCancelId = null,
        pendingCancelData = null;

      const hash = window.location.hash;
      const isRecovery = hash && hash.includes("type=recovery");

      async function initApp() {
        if (isRecovery) {
          document.getElementById("auth-screen").style.display = "none";
          document.getElementById("app-screen").style.display = "none";
          document.getElementById("recovery-screen").style.display = "block";

          let checks = 0;
          const checkSession = async () => {
            const { data } = await client.auth.getSession();
            if (data.session) {
              document.getElementById("recoveryStatus").innerText =
                "‚úÖ Verificado. Escribe tu nueva clave.";
              document.getElementById("recoveryStatus").style.color =
                "var(--success)";
              document.getElementById("recoveryForm").style.display = "block";
              return true;
            }
            return false;
          };
          if (await checkSession()) return;
          const interval = setInterval(async () => {
            checks++;
            if ((await checkSession()) || checks > 8) clearInterval(interval);
          }, 500);
        } else {
          checkUser();
        }
      }

      function renderProfileUI() {
        if (!userProfile) return;
        const names = userProfile.full_name.split(" ");
        const initials =
          names.length > 1
            ? (names[0][0] + names[1][0]).toUpperCase()
            : names[0].substring(0, 2).toUpperCase();
        document.getElementById("headerAvatar").innerText = initials;
        document.getElementById("profileAvatarLarge").innerText = initials;
        document.getElementById("displayProfileName").innerText =
          userProfile.full_name;
        document.getElementById("displayProfileEmail").innerText =
          currentUserEmail;
        document.getElementById("profileNameInput").value =
          userProfile.full_name;
      }

      async function checkUser() {
        if (isRecovery) return;
        const {
          data: { session },
        } = await client.auth.getSession();
        if (session) {
          currentUserEmail = session.user.email;
          const { data } = await client
            .from("profiles")
            .select("*")
            .eq("id", session.user.id)
            .single();
          if (!data) return setTimeout(checkUser, 500);
          userProfile = data;

          document.getElementById("auth-screen").style.display = "none";
          document.getElementById("app-screen").style.display = "block";
          document.getElementById("fieldNombre").value = data.full_name;
          document.getElementById("fieldCorreo").value = session.user.email;

          renderProfileUI();
          await fetchServices();
          await fetchSchedule();

          if (data.role === "admin") {
            document.getElementById("adminBadge").style.display =
              "inline-block";
            document.getElementById("tab-config").style.display = "block";
            document.getElementById("fieldNombre").readOnly = false;
            document.getElementById("fieldCorreo").readOnly = false;
          } else {
            document.getElementById("fieldNombre").readOnly = true;
            document.getElementById("fieldCorreo").readOnly = true;
          }
          renderCalendar();
        } else {
          document.getElementById("auth-screen").style.display = "block";
        }
      }

      // FUNCIONES COMUNES
      function togglePassword(id, icon) {
        const i = document.getElementById(id);
        if (i.type === "password") {
          i.type = "text";
          icon.innerText = "üôà";
        } else {
          i.type = "password";
          icon.innerText = "üëÅÔ∏è";
        }
      }
      function togglePassForm() {
        const f = document.getElementById("profilePassForm");
        f.style.display = f.style.display === "none" ? "block" : "none";
      }
      function showAlert(t, m, i = "‚ú®") {
        document.getElementById("genIcon").innerText = i;
        document.getElementById("genTitle").innerText = t;
        document.getElementById("genMsg").innerText = m;
        document.getElementById("generalModal").style.display = "flex";
      }
      function closeModal(id) {
        document.getElementById(id).style.display = "none";
      }
      function toggleAuth(l) {
        document.getElementById("login-form").style.display = l
          ? "block"
          : "none";
        document.getElementById("signup-form").style.display = l
          ? "none"
          : "block";
      }
      async function handleAuth(t) {
        const e = document.getElementById(
          t === "login" ? "loginEmail" : "regEmail",
        ).value;
        const p = document.getElementById(
          t === "login" ? "loginPass" : "regPass",
        ).value;
        if (t === "signup") {
          if (p !== document.getElementById("regPassConfirm").value)
            return showAlert("Error", "No coinciden");
          const { error } = await client.auth.signUp({
            email: e,
            password: p,
            options: {
              data: { full_name: document.getElementById("regNombre").value },
            },
          });
          if (error) showAlert("Error", error.message);
          else showAlert("Bienvenida", "Cuenta creada.");
        } else {
          const { error } = await client.auth.signInWithPassword({
            email: e,
            password: p,
          });
          if (error) showAlert("Error", "Datos incorrectos.");
          else checkUser();
        }
      }
      function openResetModal() {
        document.getElementById("resetModal").style.display = "flex";
      }
      async function sendResetEmail() {
        const e = document.getElementById("resetEmailInput").value;
        if (!e) return showAlert("Error", "Falta correo");
        const { error } = await client.auth.resetPasswordForEmail(e, {
          redirectTo: window.location.href,
        });
        if (error) showAlert("Error", error.message);
        else {
          closeModal("resetModal");
          showAlert("Enviado", "Revisa tu correo.");
        }
      }
      async function finalizeRecovery() {
        const p = document.getElementById("recoveryPass").value;
        if (p.length < 6) return showAlert("Error", "Min 6 caracteres");
        const { error } = await client.auth.updateUser({ password: p });
        if (error) {
          showAlert("Error", "Enlace expirado.");
          setTimeout(() => {
            window.location.hash = "";
            window.location.reload();
          }, 2000);
        } else {
          showAlert("¬°√âxito!", "Clave cambiada.");
          document.getElementById("recovery-screen").style.display = "none";
          history.replaceState(null, null, " ");
          checkUser();
        }
      }

      // ADMIN Y DATOS
      async function fetchServices() {
        const { data } = await client.from("servicios").select("*").order("id");
        if (data) {
          globalServices = data;
          const s = document.getElementById("fieldServicio");
          s.innerHTML = "";
          globalServices.forEach((i) => {
            const o = document.createElement("option");
            o.value = i.nombre;
            o.text = i.nombre;
            s.appendChild(o);
          });
          if (userProfile?.role === "admin") {
            const l = document.getElementById("adminServicesList");
            l.innerHTML = "";
            globalServices.forEach(
              (i) =>
                (l.innerHTML += `<div class="service-item"><span>${i.nombre}</span><button class="btn-delete-svc" onclick="deleteService(${i.id})">Borrar</button></div>`),
            );
          }
        }
      }
      async function addService() {
        const v = document.getElementById("newServiceInput").value.trim();
        if (!v) return;
        const { error } = await client
          .from("servicios")
          .insert([{ nombre: v }]);
        if (!error) {
          document.getElementById("newServiceInput").value = "";
          await fetchServices();
        }
      }
      async function deleteService(id) {
        if (confirm("¬øBorrar?")) {
          await client.from("servicios").delete().eq("id", id);
          await fetchServices();
        }
      }

      async function updateProfileName() {
        const n = document.getElementById("profileNameInput").value;
        const { error } = await client
          .from("profiles")
          .update({ full_name: n })
          .eq("id", userProfile.id);
        if (!error) {
          userProfile.full_name = n;
          renderProfileUI();
          showAlert("√âxito", "Nombre actualizado.");
        }
      }
      async function updatePassword() {
        const c = document.getElementById("currentPassProfile").value,
          n = document.getElementById("newPassProfile").value,
          cf = document.getElementById("confirmPassProfile").value;
        if (!c || !n || !cf) return showAlert("Falta", "Llena todo");
        if (n !== cf) return showAlert("Error", "No coinciden");
        const { error: s } = await client.auth.signInWithPassword({
          email: currentUserEmail,
          password: c,
        });
        if (s) return showAlert("Error", "Contrase√±a actual mal");
        const { error } = await client.auth.updateUser({ password: n });
        if (!error) {
          togglePassForm();
          document.getElementById("currentPassProfile").value = "";
          showAlert("√âxito", "Actualizada.");
        } else showAlert("Error", error.message);
      }
      async function logout() {
        await client.auth.signOut();
        localStorage.clear();
        window.location.href = window.location.origin;
      }

      // GESTOS Y NAVEGACI√ìN
      let touchStartX = 0,
        touchEndX = 0;
      document
        .getElementById("app-screen")
        .addEventListener(
          "touchstart",
          (e) => (touchStartX = e.changedTouches[0].screenX),
        );
      document
        .getElementById("app-screen")
        .addEventListener("touchend", (e) => {
          touchEndX = e.changedTouches[0].screenX;
          if (Math.abs(touchEndX - touchStartX) > 100) {
            const tabs = ["agenda", "lista"];
            if (userProfile?.role === "admin") tabs.push("config");
            let i = 0;
            if (document.getElementById("view-lista").style.display !== "none")
              i = 1;
            if (document.getElementById("view-config").style.display !== "none")
              i = 2;
            if (document.getElementById("view-perfil").style.display !== "none")
              return;
            if (touchEndX < touchStartX) {
              if (i < tabs.length - 1) showTab(tabs[i + 1]);
            } else {
              if (i > 0) showTab(tabs[i - 1]);
            }
          }
        });
      function format12h(h) {
        if (!h) return "";
        let [hr, m] = h.split(":");
        let suf = hr >= 12 ? "PM" : "AM";
        hr = hr % 12 || 12;
        return `${hr}:${m} ${suf}`;
      }
      function showTab(t) {
        ["agenda", "lista", "config", "perfil"].forEach(
          (x) => (document.getElementById(`view-${x}`).style.display = "none"),
        );
        ["agenda", "lista", "config"].forEach(
          (x) => (document.getElementById(`tab-${x}`).className = "tab-btn"),
        );
        if (t !== "perfil")
          document.getElementById(`tab-${t}`).className = "tab-btn active";
        document.getElementById(`view-${t}`).style.display =
          t === "agenda"
            ? window.innerWidth > 768
              ? "grid"
              : "block"
            : "block";
        if (t === "lista") loadAllAppointments();
        if (t !== "agenda") cancelRescheduleMode();
      }

      // ADMIN CALENDARIO
      function toggleWeekDay(d) {
        const i = selectedWeekDays.indexOf(d);
        if (i > -1) selectedWeekDays.splice(i, 1);
        else selectedWeekDays.push(d);
        renderWeekDays();
      }
      function renderWeekDays() {
        [0, 1, 2, 3, 4, 5, 6].forEach((d) => {
          const el = document.getElementById(`d${d}`);
          if (selectedWeekDays.includes(d)) el.classList.add("active");
          else el.classList.remove("active");
        });
        document.getElementById("hoursEditor").style.display =
          selectedWeekDays.length ? "block" : "none";
        if (selectedWeekDays.length === 1 && !stagedHours.length)
          stagedHours = globalSchedule[selectedWeekDays[0]]
            ? [...globalSchedule[selectedWeekDays[0]]]
            : [];
        renderStaged();
      }
      function renderStaged() {
        const c = document.getElementById("weeklyHours");
        c.innerHTML = "";
        stagedHours
          .sort()
          .forEach(
            (h) =>
              (c.innerHTML += `<span class="hour-tag">${format12h(h)} <span onclick="remStaged('${h}')" style="cursor:pointer;margin-left:5px">x</span></span>`),
          );
      }
      function addStagedHour() {
        const h = document.getElementById("newHourInput").value;
        if (h && !stagedHours.includes(h)) {
          stagedHours.push(h);
          renderStaged();
        }
      }
      function remStaged(h) {
        stagedHours = stagedHours.filter((x) => x !== h);
        renderStaged();
      }
      async function saveWeekSchedule() {
        for (let d of selectedWeekDays)
          await client
            .from("horarios_base")
            .upsert({ dia: d, horas: stagedHours });
        selectedWeekDays = [];
        renderWeekDays();
        showAlert("√âxito", "Horario guardado.");
      }
      async function loadAdminDayConfig() {
        const d = document.getElementById("adminDateInput").value;
        if (!d) return;
        adminSelectedDate = d;
        document.getElementById("adminPanelControls").style.display = "block";
        const { data } = await client
          .from("bloqueos")
          .select("*")
          .eq("fecha", d);
        const isFull = data.some((b) => b.hora === null);
        document.getElementById("btnToggleDay").innerText = isFull
          ? "üîì ABRIR D√çA"
          : "üîí CERRAR D√çA";
        const dw = new Date(d + "T00:00:00").getDay();
        const base = globalSchedule[dw] || [];
        const g = document.getElementById("adminHourGrid");
        g.innerHTML = "";
        base.sort().forEach((h) => {
          const isB = data.some((b) => b.hora === h);
          g.innerHTML += `<button class="hour-btn" style="background:${isB ? "#ffebee" : "#e8f5e9"};border:1px solid #ddd;padding:10px;border-radius:8px" onclick="toggleBlock('${h}',${isB})">${format12h(h)} ${isB ? "üö´" : "‚úÖ"}</button>`;
        });
      }
      async function toggleFullDayBlock() {
        const { data } = await client
          .from("bloqueos")
          .select("*")
          .eq("fecha", adminSelectedDate)
          .is("hora", null);
        if (data.length)
          await client.from("bloqueos").delete().eq("id", data[0].id);
        else
          await client
            .from("bloqueos")
            .insert([{ fecha: adminSelectedDate, hora: null }]);
        loadAdminDayConfig();
      }
      async function toggleBlock(h, isB) {
        if (isB)
          await client
            .from("bloqueos")
            .delete()
            .eq("fecha", adminSelectedDate)
            .eq("hora", h);
        else
          await client
            .from("bloqueos")
            .insert([{ fecha: adminSelectedDate, hora: h }]);
        loadAdminDayConfig();
      }

      function startReschedule(id, f, h, s, n, t) {
        isRescheduling = true;
        rescheduleId = id;
        rescheduleData = { fecha: f, hora: h, servicio: s, nombre: n, tel: t };
        document.getElementById("editModeBar").style.display = "flex";
        document.getElementById("newAppointmentFields").style.display = "none";
        document.getElementById("btnMainAction").innerText =
          "Confirmar Nueva Fecha üîÑ";
        document.getElementById("btnMainAction").className =
          "btn-main reschedule-mode";
        showTab("agenda");
        showAlert("Reprogramar", "Selecciona fecha y hora.", "üóìÔ∏è");
      }
      function cancelRescheduleMode() {
        isRescheduling = false;
        rescheduleId = null;
        document.getElementById("editModeBar").style.display = "none";
        document.getElementById("newAppointmentFields").style.display = "block";
        document.getElementById("btnMainAction").innerText = "üíñ Reservar Cita";
        document.getElementById("btnMainAction").className = "btn-main";
      }
      async function confirmarCita() {
        if (!selectedDate || !document.getElementById("fieldHora").value)
          return showAlert("Faltan Datos", "Selecciona fecha y hora.");
        const hora = document.getElementById("fieldHora").value;
        if (isRescheduling) {
          const { error } = await client
            .from("citas")
            .update({ fecha: selectedDate, hora: hora, estado: "reprogramada" })
            .eq("id", rescheduleId);
          if (error) showAlert("Error", error.message);
          else {
            lastCitaData = {
              ...rescheduleData,
              fecha: selectedDate,
              hora: hora,
            };
            document.getElementById("wspRescheduleModal").style.display =
              "flex";
            cancelRescheduleMode();
            loadAllAppointments();
          }
        } else {
          if (!document.getElementById("fieldTelefono").value)
            return showAlert("Faltan Datos", "Tel√©fono requerido.");
          const cleanTel = document
            .getElementById("fieldTelefono")
            .value.replace(/\D/g, "");
          const datos = {
            fecha: selectedDate,
            hora,
            nombre: document.getElementById("fieldNombre").value,
            correo: document.getElementById("fieldCorreo").value,
            telefono: cleanTel,
            servicio: document.getElementById("fieldServicio").value,
            user_id: userProfile.id,
            estado: "pendiente",
          };
          const { error } = await client.from("citas").insert([datos]);
          if (error) showAlert("Error", error.message);
          else {
            lastCitaData = datos;
            document.getElementById("wspModal").style.display = "flex";
          }
        }
      }
      function enviarWhatsAppCliente() {
        const cleanTel = lastCitaData.telefono.replace(/\D/g, "");
        window.open(
          `https://wa.me/${miWhatsAppAdmin}?text=${encodeURIComponent(`Hola NailsbyNiNa. Soy ${lastCitaData.nombre}.\nCita: ${lastCitaData.fecha} ${format12h(lastCitaData.hora)}\nServicio: ${lastCitaData.servicio}\nTe env√≠o el comprobante por aqu√≠.`)}`,
          "_blank",
        );
        closeModal("wspModal");
        showTab("lista");
      }
      function enviarWhatsAppReprogramacion() {
        window.open(
          `https://wa.me/${miWhatsAppAdmin}?text=${encodeURIComponent(`Hola NailsbyNiNa. Soy ${lastCitaData.nombre}.\nHe reprogramado mi cita.\nNueva: ${lastCitaData.fecha} ${format12h(lastCitaData.hora)}`)}`,
          "_blank",
        );
        closeModal("wspRescheduleModal");
        showTab("lista");
      }
      function openCancelModal(id, t, n, c) {
        pendingCancelId = id;
        pendingCancelData = { tel: t, name: n, isClient: c };
        document.getElementById("cancelModal").style.display = "flex";
      }
      async function confirmCancelation() {
        const { error } = await client
          .from("citas")
          .delete()
          .eq("id", pendingCancelId);
        if (!error) {
          const cleanTel = pendingCancelData.tel.replace(/\D/g, "");
          window.open(
            `https://wa.me/${pendingCancelData.isClient ? miWhatsAppAdmin : cleanTel}?text=${encodeURIComponent(pendingCancelData.isClient ? `Hola NailsbyNiNa. Cancelo cita de ${pendingCancelData.name}.` : `Hola ${pendingCancelData.name}, cancelamos tu cita.`)}`,
            "_blank",
          );
          loadAllAppointments();
          closeModal("cancelModal");
        }
      }
      async function loadAllAppointments() {
        let q = client.from("citas").select("*");
        if (userProfile.role !== "admin") q = q.eq("user_id", userProfile.id);
        const { data } = await q.order("fecha").order("hora");
        const c = document.getElementById("tablaCitasContainer");
        c.innerHTML = "";
        if (!data || !data.length) {
          c.innerHTML =
            "<p style='text-align:center;color:#aaa;margin-top:30px'>Sin citas.</p>";
          return;
        }
        const hoy = new Date().toISOString().split("T")[0];
        data.forEach((d) => {
          const cleanTel = d.telefono.replace(/\D/g, "");
          const badge =
            d.estado === "reprogramada"
              ? `<div class="status-pill repro">Reprogramada</div>`
              : `<div class="status-pill" style="background:#e6fffa;color:#00b894;border:1px solid #00b894">Confirmada</div>`;
          const btns =
            userProfile.role === "admin"
              ? `<div class="actions-row"><button class="btn-action btn-reschedule" style="background:var(--whatsapp);color:white" onclick="window.open('https://wa.me/${cleanTel}?text=Hola%20${d.nombre},%20recordatorio')">Recordar</button><button class="btn-action btn-cancel" onclick="openCancelModal('${d.id}','${d.telefono}','${d.nombre}',false)">Cancelar</button></div>`
              : d.fecha >= hoy
                ? `<div class="actions-row"><button class="btn-action btn-reschedule" onclick="startReschedule('${d.id}','${d.fecha}','${d.hora}','${d.servicio}','${d.nombre}','${d.telefono}')">Reprogramar</button><button class="btn-action btn-cancel" onclick="openCancelModal('${d.id}','${d.telefono}','${d.nombre}',true)">Cancelar</button></div>`
                : "";
          c.innerHTML += `<div class="appointment-card ${d.estado === "reprogramada" ? "reprogramada" : ""} animate-pop">${badge}<div style="font-size:1.1rem;font-weight:bold">${d.servicio}</div><div style="color:var(--primary);font-weight:bold;margin:5px 0">${format12h(d.hora)} - ${d.fecha}</div><div style="font-size:0.9rem;color:#888">${d.nombre}</div>${userProfile.role === "admin" ? `<div style="background:#f9f9f9;padding:8px;border-radius:8px;margin-top:8px;font-size:0.8rem">üì± ${d.telefono}<br>üìß ${d.correo}</div>` : ""}${btns}</div>`;
        });
      }
      async function fetchSchedule() {
        const { data } = await client.from("horarios_base").select("*");
        if (data) data.forEach((i) => (globalSchedule[i.dia] = i.horas));
      }
      function renderCalendar() {
        const grid = document.getElementById("calendarGrid");
        grid.innerHTML = "";
        ["Do", "Lu", "Ma", "Mi", "Ju", "Vi", "Sa"].forEach(
          (d) =>
            (grid.innerHTML += `<div style="font-size:0.8rem;text-align:center;color:var(--primary);font-weight:bold">${d}</div>`),
        );
        const y = viewDate.getFullYear(),
          m = viewDate.getMonth();
        document.getElementById("monthDisplay").innerText = new Date(
          y,
          m,
          1,
        ).toLocaleString("es-ES", { month: "long", year: "numeric" });
        const first = new Date(y, m, 1).getDay(),
          last = new Date(y, m + 1, 0).getDate(),
          today = new Date();
        today.setHours(0, 0, 0, 0);
        for (let i = 0; i < first; i++) grid.innerHTML += `<div></div>`;
        for (let i = 1; i <= last; i++) {
          const d = document.createElement("div");
          const dStr = `${y}-${String(m + 1).padStart(2, "0")}-${String(i).padStart(2, "0")}`;
          const cDate = new Date(dStr + "T00:00:00");
          d.className = "day";
          d.innerText = i;
          d.id = `day-${dStr}`;
          if (cDate < today) d.classList.add("disabled");
          else {
            if (cDate.getTime() === today.getTime()) d.classList.add("today");
            d.onclick = () => {
              if (d.classList.contains("full"))
                return showAlert("Lo sentimos", "D√≠a completo o no laboral.");
              document
                .querySelectorAll(".day")
                .forEach((e) => e.classList.remove("selected"));
              d.classList.add("selected");
              selectedDate = dStr;
              checkHoras(dStr);
            };
          }
          grid.appendChild(d);
        }
        updateFullDays(y, m, last);
      }
      async function updateFullDays(y, m, last) {
        const s = `${y}-${String(m + 1).padStart(2, "0")}-01`,
          e = `${y}-${String(m + 1).padStart(2, "0")}-${last}`;
        const { data: c } = await client
          .from("citas")
          .select("fecha,hora")
          .gte("fecha", s)
          .lte("fecha", e);
        const { data: b } = await client
          .from("bloqueos")
          .select("fecha,hora")
          .gte("fecha", s)
          .lte("fecha", e);
        for (let i = 1; i <= last; i++) {
          const dStr = `${y}-${String(m + 1).padStart(2, "0")}-${String(i).padStart(2, "0")}`;
          const el = document.getElementById(`day-${dStr}`);
          if (!el || el.classList.contains("disabled")) continue;
          const dw = new Date(dStr + "T00:00:00").getDay();
          const base = globalSchedule[dw] || [];
          const bl = b.some((x) => x.fecha === dStr && x.hora === null);
          if (bl || !base.length) {
            el.classList.add("full");
            continue;
          }
          const taken = [
            ...c.filter((x) => x.fecha === dStr).map((x) => x.hora),
            ...b.filter((x) => x.fecha === dStr && x.hora).map((x) => x.hora),
          ];
          if (!base.filter((h) => !taken.includes(h)).length)
            el.classList.add("full");
        }
      }
      async function checkHoras(f) {
        const dw = new Date(f + "T00:00:00").getDay();
        let base = globalSchedule[dw] ? [...globalSchedule[dw]].sort() : [];
        const { data: c } = await client
          .from("citas")
          .select("hora")
          .eq("fecha", f);
        const { data: b } = await client
          .from("bloqueos")
          .select("hora")
          .eq("fecha", f);
        const taken = [...c.map((x) => x.hora), ...b.map((x) => x.hora)];
        const bl = b.some((x) => x.hora === null);
        const s = document.getElementById("fieldHora");
        s.innerHTML = "";
        if (!base.length || bl) {
          s.add(new Option("No disponible", ""));
          s.disabled = true;
          return;
        }
        s.disabled = false;
        let any = false;
        s.add(new Option("Selecciona hora...", ""));
        base.forEach((h) => {
          const opt = document.createElement("option");
          opt.value = h;
          if (taken.includes(h)) {
            opt.disabled = true;
            opt.text = format12h(h) + " (Ocupado)";
          } else {
            opt.text = format12h(h);
            any = true;
          }
          s.appendChild(opt);
        });
        if (!any) {
          s.innerHTML = "";
          s.add(new Option("Lleno", ""));
          s.disabled = true;
        }
      }
      function moveMonth(v) {
        viewDate.setMonth(viewDate.getMonth() + v);
        renderCalendar();
      }

      initApp();
    </script>
  </body>
</html>
