<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Nails App - Sistema Completo</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
      :root {
        --primary: #d63384;
        --primary-soft: #fce4ec;
        --accent: #f8bbd0;
        --bg: #fff5f8;
        --text: #4a148c;
        --whatsapp: #25d366;
      }

      body {
        font-family: "Segoe UI", sans-serif;
        background: var(--bg);
        margin: 0;
        color: var(--text);
        padding: 10px;
      }

      /* MODALES */
      .modal-overlay {
        display: none;
        position: fixed;
        z-index: 3000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: rgba(74, 20, 140, 0.4);
        backdrop-filter: blur(4px);
      }
      .modal-content {
        background: white;
        margin: 12% auto;
        padding: 35px;
        border-radius: 30px;
        width: 85%;
        max-width: 350px;
        text-align: center;
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.2);
        animation: bounceIn 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      }
      @keyframes bounceIn {
        0% {
          transform: scale(0.3);
          opacity: 0;
        }
        100% {
          transform: scale(1);
          opacity: 1;
        }
      }

      /* LOGIN / REGISTRO */
      .auth-container {
        background: white;
        max-width: 400px;
        margin: 40px auto;
        padding: 30px;
        border-radius: 25px;
        border: 2px solid var(--accent);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
      }
      .auth-container h1 {
        color: var(--primary);
        text-align: center;
        margin-bottom: 25px;
      }

      /* APP */
      #app-screen {
        display: none;
        max-width: 1000px;
        margin: 10px auto;
        background: white;
        border-radius: 25px;
        overflow: hidden;
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
      }
      .nav-header {
        background: var(--primary);
        color: white;
        padding: 15px 25px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .tabs {
        display: flex;
        background: white;
        border-bottom: 2px solid var(--accent);
      }
      .tab-btn {
        flex: 1;
        padding: 15px;
        border: none;
        background: none;
        cursor: pointer;
        font-weight: bold;
        color: #888;
      }
      .tab-btn.active {
        color: var(--primary);
        border-bottom: 3px solid var(--primary);
        background: var(--bg);
      }

      /* CALENDARIO */
      .cal-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 5px;
        margin-top: 10px;
      }
      .day {
        padding: 12px 5px;
        border-radius: 12px;
        cursor: pointer;
        border: 1px solid #fff0f5;
        text-align: center;
        font-weight: 500;
      }
      .day.today {
        border: 2px solid var(--primary);
        color: var(--primary);
        background: white;
      }
      .day.selected {
        background: var(--primary) !important;
        color: white !important;
        font-weight: bold;
      }
      .day.disabled {
        color: #ccc;
        cursor: not-allowed;
        background: #fdfdfd;
        opacity: 0.4;
        pointer-events: none;
      }

      /* FORMULARIO */
      .main-grid {
        display: grid;
        grid-template-columns: 1fr 350px;
        gap: 20px;
        padding: 20px;
      }
      @media (max-width: 850px) {
        .main-grid {
          grid-template-columns: 1fr;
        }
      }

      input,
      select {
        width: 100%;
        padding: 12px;
        margin: 8px 0;
        border: 2px solid var(--primary-soft);
        border-radius: 12px;
        box-sizing: border-box;
        font-family: inherit;
      }
      .btn-main {
        background: var(--primary);
        color: white;
        border: none;
        padding: 15px;
        width: 100%;
        border-radius: 15px;
        cursor: pointer;
        font-weight: bold;
        font-size: 1rem;
      }
      .btn-wa {
        background: var(--whatsapp);
        color: white;
        border: none;
        padding: 15px;
        width: 100%;
        border-radius: 15px;
        cursor: pointer;
        font-weight: bold;
      }

      .appointment-card {
        background: white;
        border-left: 6px solid var(--primary);
        padding: 15px;
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        margin-bottom: 15px;
      }
      .btn-remind {
        background: var(--whatsapp);
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 10px;
        cursor: pointer;
        font-size: 0.8rem;
        font-weight: bold;
        margin-top: 10px;
      }
    </style>
  </head>
  <body>
    <div id="signupModal" class="modal-overlay">
      <div class="modal-content">
        <div style="font-size: 60px">ðŸŒ¸</div>
        <h2 id="regTitle">Â¡Bienvenida!</h2>
        <p id="regMsg">
          Tu cuenta ha sido creada. Ahora puedes iniciar sesiÃ³n para agendar.
        </p>
        <button class="btn-main" onclick="closeSignupModal()">
          Entrar ahora
        </button>
      </div>
    </div>

    <div id="confirmModal" class="modal-overlay">
      <div class="modal-content">
        <div style="font-size: 60px">ðŸ“©</div>
        <h2>Â¡Casi listo!</h2>
        <p>
          Para confirmar tu espacio, **debes enviarnos el comprobante de pago**
          por WhatsApp ahora.
        </p>
        <button class="btn-wa" onclick="enviarWhatsAppCliente()">
          Enviar por WhatsApp ðŸ“±
        </button>
      </div>
    </div>

    <div id="auth-screen">
      <div class="auth-container">
        <h1>Nails App</h1>

        <div id="login-form">
          <input
            type="email"
            id="loginEmail"
            placeholder="Tu correo electrÃ³nico"
          />
          <input type="password" id="loginPass" placeholder="Tu contraseÃ±a" />
          <button class="btn-main" onclick="handleAuth('login')">
            Ingresar
          </button>
          <p style="text-align: center; font-size: 0.9rem; margin-top: 20px">
            Â¿No tienes cuenta?
            <a
              href="#"
              onclick="toggleAuth(false)"
              style="color: var(--primary)"
              >RegÃ­strate aquÃ­</a
            >
          </p>
        </div>

        <div id="signup-form" style="display: none">
          <input type="text" id="regNombre" placeholder="Nombre completo" />
          <input type="email" id="regEmail" placeholder="Correo electrÃ³nico" />
          <input
            type="password"
            id="regPass"
            placeholder="Crea una contraseÃ±a"
          />
          <button class="btn-main" onclick="handleAuth('signup')">
            Crear cuenta
          </button>
          <p style="text-align: center; font-size: 0.9rem; margin-top: 20px">
            <a href="#" onclick="toggleAuth(true)" style="color: var(--primary)"
              >Ya tengo cuenta</a
            >
          </p>
        </div>
      </div>
    </div>

    <div id="app-screen">
      <div class="nav-header">
        <span>ðŸ’… <b id="displayUserName"></b></span>
        <button
          onclick="logout()"
          style="
            background: none;
            border: 1px solid white;
            color: white;
            padding: 5px 10px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.8rem;
          "
        >
          Cerrar SesiÃ³n
        </button>
      </div>

      <div class="tabs">
        <button
          id="tab-agenda"
          class="tab-btn active"
          onclick="showTab('agenda')"
        >
          Agendar Cita
        </button>
        <button id="tab-lista" class="tab-btn" onclick="showTab('lista')">
          Mis Citas
        </button>
      </div>

      <div id="view-agenda" class="main-grid">
        <div>
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
            "
          >
            <button
              onclick="moveMonth(-1)"
              style="
                border: none;
                background: none;
                cursor: pointer;
                font-size: 1.2rem;
              "
            >
              â—€
            </button>
            <b id="monthDisplay"></b>
            <button
              onclick="moveMonth(1)"
              style="
                border: none;
                background: none;
                cursor: pointer;
                font-size: 1.2rem;
              "
            >
              â–¶
            </button>
          </div>
          <div class="cal-grid" id="calendarGrid"></div>
        </div>

        <div class="form-section">
          <label style="font-size: 0.7rem; font-weight: bold"
            >DATOS DE CITA:</label
          >
          <input
            type="text"
            id="fieldNombre"
            readonly
            style="background: #f9f9f9; color: #888"
          />
          <input
            type="email"
            id="fieldCorreo"
            readonly
            style="background: #f9f9f9; color: #888"
          />
          <input
            type="text"
            id="fieldTelefono"
            placeholder="WhatsApp (Ej: 573001234567)"
          />

          <select id="fieldServicio">
            <option>UÃ±as AcrÃ­licas</option>
            <option>Retoque</option>
            <option>Semipermanente</option>
            <option>Manicura Rusa</option>
          </select>

          <select id="fieldHora"></select>

          <label style="font-size: 0.7rem; font-weight: bold"
            >COMPROBANTE (Captura de pago):</label
          >
          <input type="file" id="fieldFile" accept="image/*" />

          <button
            class="btn-main"
            onclick="confirmarCita()"
            style="margin-top: 10px"
          >
            âœ¨ Reservar Espacio
          </button>
        </div>
      </div>

      <div id="view-lista" style="display: none; padding: 20px">
        <h2 id="listTitle" style="color: var(--primary); margin: 0 0 20px 0">
          Citas Programadas
        </h2>
        <div id="tablaCitasContainer"></div>
      </div>
    </div>

    <script>
      // CONFIGURACIÃ“N SUPABASE
      const sbUrl = "https://jifwtgpchbipxyriirtq.supabase.co";
      const sbKey = "sb_publishable_zF5mj6Ba61zibU_19vnFPQ_a4GDaKwi";
      const client = supabase.createClient(sbUrl, sbKey);

      // TU TELÃ‰FONO (Donde recibes las citas)
      const miTelefonoAdmin = "573153217110";

      let userProfile = null;
      let selectedDate = null;
      let lastCitaData = null;
      let viewDate = new Date();

      function format12h(h24) {
        let [h, m] = h24.split(":");
        let suf = h >= 12 ? "PM" : "AM";
        h = h % 12 || 12;
        return `${h}:${m} ${suf}`;
      }

      // --- SISTEMA DE AUTENTICACIÃ“N ---
      function toggleAuth(isLogin) {
        document.getElementById("login-form").style.display = isLogin
          ? "block"
          : "none";
        document.getElementById("signup-form").style.display = isLogin
          ? "none"
          : "block";
      }

      async function handleAuth(type) {
        if (type === "signup") {
          const nombre = document.getElementById("regNombre").value;
          const email = document.getElementById("regEmail").value;
          const pass = document.getElementById("regPass").value;

          if (!nombre || !email || pass.length < 6)
            return alert(
              "Completa todos los datos (ContraseÃ±a min 6 caracteres)",
            );

          const { data, error } = await client.auth.signUp({
            email,
            password: pass,
            options: { data: { full_name: nombre } },
          });

          if (error) alert(error.message);
          else {
            document.getElementById("regTitle").innerText = `Â¡Hola ${nombre}!`;
            document.getElementById("signupModal").style.display = "block";
          }
        } else {
          const email = document.getElementById("loginEmail").value;
          const pass = document.getElementById("loginPass").value;
          const { error } = await client.auth.signInWithPassword({
            email,
            password: pass,
          });
          if (error) alert("Correo o contraseÃ±a incorrectos");
          else checkUser();
        }
      }

      async function checkUser() {
        const {
          data: { session },
        } = await client.auth.getSession();
        if (session) {
          const { data: profile } = await client
            .from("profiles")
            .select("*")
            .eq("id", session.user.id)
            .single();
          if (!profile) return setTimeout(checkUser, 1000);

          userProfile = profile;
          document.getElementById("auth-screen").style.display = "none";
          document.getElementById("app-screen").style.display = "block";
          document.getElementById("displayUserName").innerText =
            profile.full_name;
          document.getElementById("fieldNombre").value = profile.full_name;
          document.getElementById("fieldCorreo").value = session.user.email;

          if (profile.role === "admin") {
            document.getElementById("fieldNombre").readOnly = false;
            document.getElementById("fieldNombre").style.background = "white";
          }
          renderCalendar();
        }
      }

      // --- SISTEMA DE AGENDAMIENTO ---
      function renderCalendar() {
        const grid = document.getElementById("calendarGrid");
        const months = [
          "Enero",
          "Febrero",
          "Marzo",
          "Abril",
          "Mayo",
          "Junio",
          "Julio",
          "Agosto",
          "Septiembre",
          "Octubre",
          "Noviembre",
          "Diciembre",
        ];
        const year = viewDate.getFullYear();
        const month = viewDate.getMonth();
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        document.getElementById("monthDisplay").innerText =
          `${months[month]} ${year}`;
        grid.innerHTML = "";
        ["Do", "Lu", "Ma", "Mi", "Ju", "Vi", "SÃ¡"].forEach(
          (d) =>
            (grid.innerHTML += `<div style="font-size:0.7rem; text-align:center; color:#bbb; padding-bottom:10px;">${d}</div>`),
        );

        const firstDay = new Date(year, month, 1).getDay();
        const lastDate = new Date(year, month + 1, 0).getDate();

        for (let i = 0; i < firstDay; i++) grid.innerHTML += `<div></div>`;
        for (let i = 1; i <= lastDate; i++) {
          const d = document.createElement("div");
          d.className = "day";
          d.innerText = i;
          const cIter = new Date(year, month, i);
          const dStr = `${year}-${String(month + 1).padStart(2, "0")}-${String(i).padStart(2, "0")}`;

          if (cIter < today) d.classList.add("disabled");
          else {
            if (cIter.getTime() === today.getTime()) d.classList.add("today");
            d.onclick = () => {
              document
                .querySelectorAll(".day")
                .forEach((el) => el.classList.remove("selected"));
              d.classList.add("selected");
              selectedDate = dStr;
              checkHoras(dStr);
            };
          }
          grid.appendChild(d);
        }
      }

      const horasBase = ["09:00", "11:00", "14:00", "16:00"];
      async function checkHoras(fecha) {
        const { data } = await client
          .from("citas")
          .select("hora")
          .eq("fecha", fecha);
        const selector = document.getElementById("fieldHora");
        selector.innerHTML = "";

        horasBase.forEach((h) => {
          const opt = document.createElement("option");
          opt.value = h;
          const ocupado = data && data.some((c) => c.hora.startsWith(h));
          opt.disabled = ocupado;
          opt.text = format12h(h) + (ocupado ? " (Ocupado)" : "");
          selector.appendChild(opt);
        });
      }

      async function confirmarCita() {
        if (!selectedDate)
          return alert("Por favor, selecciona un dÃ­a en el calendario ðŸŒ¸");

        // Verificamos que el archivo estÃ© seleccionado pero no lo subimos aÃºn a Supabase
        // para evitar errores de almacenamiento. Se enviarÃ¡ por WhatsApp.
        const file = document.getElementById("fieldFile").files[0];
        if (!file) return alert("Debes seleccionar la foto del comprobante ðŸ“¸");

        const tel = document.getElementById("fieldTelefono").value;
        if (!tel || tel.length < 7)
          return alert("Por favor, ingresa un nÃºmero de WhatsApp vÃ¡lido");

        const btn = document.querySelector(".btn-main");
        btn.innerText = "Procesando...";
        btn.disabled = true;

        const datosCita = {
          fecha: selectedDate,
          hora: document.getElementById("fieldHora").value,
          nombre: document.getElementById("fieldNombre").value,
          correo: document.getElementById("fieldCorreo").value,
          telefono: tel,
          servicio: document.getElementById("fieldServicio").value,
          user_id: userProfile.id,
          // No enviamos la columna 'comprobante' aquÃ­ para evitar el error de restricciÃ³n
        };

        const { error } = await client.from("citas").insert([datosCita]);

        if (error) {
          console.error("ERROR COMPLETO:", error);
          alert("Error al guardar: " + error.message);
          btn.innerText = "âœ¨ Reservar Espacio";
          btn.disabled = false;
        } else {
          // Guardamos los datos para el mensaje de WhatsApp
          lastCitaData = {
            nombre: datosCita.nombre,
            fecha: datosCita.fecha,
            hora: format12h(datosCita.hora),
            servicio: datosCita.servicio,
          };

          // Abrimos el modal que obliga a enviar el WhatsApp
          document.getElementById("confirmModal").style.display = "block";

          btn.innerText = "âœ¨ Reservar Espacio";
          btn.disabled = false;
        }
      }

      function enviarWhatsAppCliente() {
        const msg = `Â¡Hola! Soy *${lastCitaData.nombre}*. AgendÃ© cita para *${lastCitaData.servicio}* el *${lastCitaData.fecha}* a las *${lastCitaData.hora}*. Adjunto comprobante. âœ¨`;
        window.open(
          `https://wa.me/${miTelefonoAdmin}?text=${encodeURIComponent(msg)}`,
          "_blank",
        );
        document.getElementById("confirmModal").style.display = "none";
        showTab("lista");
      }

      function enviarRecordatorioAdmin(n, f, h, tel) {
        const msg = `Â¡Hola *${n}*! ðŸ’… Te recordamos tu cita de maÃ±ana *${f}* a las *${format12h(h)}*. Â¿Confirmas asistencia? âœ¨`;
        window.open(
          `https://wa.me/${tel}?text=${encodeURIComponent(msg)}`,
          "_blank",
        );
      }

      async function loadAllAppointments() {
        let query = client.from("citas").select("*");
        if (userProfile.role !== "admin")
          query = query.eq("user_id", userProfile.id);
        const { data } = await query.order("fecha", { ascending: true });

        const container = document.getElementById("tablaCitasContainer");
        container.innerHTML = "";
        const manana = new Date();
        manana.setDate(manana.getDate() + 1);
        const mananaStr = manana.toISOString().split("T")[0];

        if (data)
          data.forEach((c) => {
            const esManana = c.fecha === mananaStr;
            container.innerHTML += `
                    <div class="appointment-card">
                        <div style="font-weight:bold; color:var(--primary)">ðŸ•’ ${format12h(c.hora)} - ${c.fecha}</div>
                        <div>ðŸ‘¤ ${c.nombre}</div>
                        <div style="font-size:0.8rem">âœ¨ ${c.servicio}</div>
                        ${
                          userProfile.role === "admin" && esManana
                            ? `<button class="btn-remind" onclick="enviarRecordatorioAdmin('${c.nombre}', '${c.fecha}', '${c.hora}', '${c.telefono}')">ðŸ“± Recordar cita de maÃ±ana</button>`
                            : ""
                        }
                    </div>`;
          });
      }

      function showTab(t) {
        document.getElementById("view-agenda").style.display =
          t === "agenda" ? "grid" : "none";
        document.getElementById("view-lista").style.display =
          t === "lista" ? "block" : "none";
        if (t === "lista") loadAllAppointments();
      }

      function closeSignupModal() {
        document.getElementById("signupModal").style.display = "none";
        toggleAuth(true);
      }
      function moveMonth(d) {
        viewDate.setMonth(viewDate.getMonth() + d);
        renderCalendar();
      }
      async function logout() {
        await client.auth.signOut();
        window.location.reload();
      }

      checkUser();
    </script>
  </body>
</html>
